var dbStorage={dbAvailable:null,db:null,readyListeners:[],onReady:function(a){if(dbStorage.db||dbStorage.dbAvailable===false){a()}else{dbStorage.readyListeners.push(a)}},init:function(){var a=20,b=window.indexedDB.open("fluidDB",a);b.onupgradeneeded=function(d){dbStorage.dbAvailable=true;console.log("!!onupgradeneeded success: ",this.result,d.oldVersion);if(!this.result.objectStoreNames.contains("rastPages")){var c=this.result.createObjectStore("rastPages",{keyPath:"id"});c.createIndex("by_id","id",{unique:true});c.createIndex("by_data","data");c.createIndex("by_project","project")}if(!this.result.objectStoreNames.contains("uploads")){c=this.result.createObjectStore("uploads",{keyPath:"id"});c.createIndex("by_id","id",{unique:true});c.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("projects")){c=this.result.createObjectStore("projects",{keyPath:"id"});c.createIndex("by_id","id",{unique:true});c.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("uiIcons")){c=this.result.createObjectStore("uiIcons",{keyPath:"id"});c.createIndex("by_id","id",{unique:true});c.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("uploadThumbs")){c=this.result.createObjectStore("uploadThumbs",{keyPath:"id"});c.createIndex("by_id","id",{unique:true});c.createIndex("by_data","data")}if(!this.result.objectStoreNames.contains("wdgDefinitions")){c=this.result.createObjectStore("wdgDefinitions",{keyPath:"id"});c.createIndex("by_id","id",{unique:true});c.createIndex("by_data","data")}if(d.oldVersion!==0){console.log("oldVersion: ",d.oldVersion);dbStorage.clearStores=true}};b.onsuccess=function(c){dbStorage.dbAvailable=true;dbStorage.db=this.result;if(dbStorage.clearStores){var d;console.log("clearing stores: ");for(var e=0;e<dbStorage.db.objectStoreNames.length;e++){d=dbStorage.getObjectStore(dbStorage.db.objectStoreNames[e],"readwrite");d.clear()}localStorage.clear();localStorage.setItem("indexedDBreloaded",true);localStorage.setItem("postloadMessage","updateLogout");setTimeout(function(){window.location.reload()},3000);return}for(var e=0;e<dbStorage.readyListeners.length;e++){dbStorage.readyListeners[e]()}localStorage.setItem("indexedDBreloaded",false)};b.onerror=function(c){dbStorage.dbAvailable=false;if(c.target.error.name&&localStorage.getItem("indexedDBreloaded")==="false"){setTimeout(function(){dbStorage.clear();localStorage.clear();localStorage.setItem("indexedDBreloaded",true);localStorage.setItem("postloadMessage","updateLogout");window.location.reload()},5000)}};b.onblocked=function(c){dbStorage.dbAvailable=false}},getObjectStore:function(a,c){var b=dbStorage.db.transaction(a,c);return b.objectStore(a)},clear:function(){window.indexedDB.deleteDatabase("fluidDB")},set:function(b,d,e){if(d.length===undefined){d=[d]}if(d.length===0||dbStorage.dbAvailable===false){if(e){e()}return}var a=dbStorage.getObjectStore(b,"readwrite");for(var c=0;c<d.length;c++){a.put(d[c]).onsuccess=function(){if(c===d.length&&e){e()}}}},remove:function(b,d,e){if(d.length===undefined){d=[d]}if(d.length===0||dbStorage.dbAvailable===false){if(e){e()}return}var a=dbStorage.getObjectStore(b,"readwrite");for(var c=0;c<d.length;c++){a["delete"](d[c]).onsuccess=function(f,h,g){if(f===h.length-1&&g){g()}}.bind(this,c,d,e)}},list:function(a,e){var c=dbStorage.db.transaction(a);var d=c.objectStore(a);var b=[];d.openCursor().onsuccess=function(f){var g=f.target.result;if(g){b.push(g.key);g["continue"]()}else{if(e){e(b)}}}},get:function(a,e,h){var d={failed:[],fetched:[],resultsArr:[],resultsObj:{}};if(e.length===undefined||typeof(e)==="string"){e=[e]}if(e.length===0||dbStorage.dbAvailable===false){if(h){h(d)}return}var c=dbStorage.db.transaction(a);var g=c.objectStore(a);var f;for(var b=0;b<e.length;b++){f=g.get(e[b]);f.onsuccess=function(i,j){if(this.result){d.fetched.push(i);d.resultsObj[i]=this.result}else{d.failed.push(i);d.resultsObj[i]=null}d.resultsArr.push(d.resultsObj[i]);if(h&&d.resultsArr.length===e.length){h(d)}}.bind(f,e[b])}}};