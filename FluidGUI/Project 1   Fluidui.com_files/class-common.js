var preview={url:null,printURL:null,embedURL:null,pageTransitioning:false,multiOrientations:false,projectWH:[320,480],delayStart:1000,loaded:false,pageScale:1,pageRotation:0,pageTranslation:[0,0],viewportScaled:false,parentAccessible:false,currentFrameScale:1,navigationStackBack:[],navigationStackForward:[],navigationQueueNext:[],navigationQueueFlow:[],navigationCompleted:false,navigationEnabled:false,navigationDefaultTransition:null,useZoomSlider:false,pageNotes:{},isOpen:false,initExported:function(){if($("#previewPage").size()>0){$(window).on("message",preview._crossDomainCallListener)}preview._showPreviewPage(false)},scaleFrame:function(l,k,o){k=k||false;l=l||false;if(!preview.loaded&&!k&&l){return}if(window.g_print||window.g_embedded||window.g_imgExport=="true"){return}var b=$("#previewPage"),c=window,e=c.document,j=window;if(!b[0]){if(preview.parentAccessible){c=window.frameElement.ownerDocument.defaultView;b=c.$("#previewPage");e=c.document}else{if(window.parent!==window){preview._crossDomainCall(window.parent,"scaleFrame",arguments);return}}}else{j=b[0].contentWindow}if(!l&&!b[0]){if(utils.isMobileDevice()){preview.scaleViewport()}return}var d,a=b[0].ownerDocument.querySelector("#previewShare"),i=a&&!o&&!a.classList.contains("closed")?a.clientWidth:0,f=o?0:previewMenu.width;if(!o&&(preview.parentAccessible||preview.canAccessFrame())&&j.preview.useZoomSlider){d=e.getElementById("previewZoomSlider").value}else{var q=Math.max(b.width(),b.height())+20,h=(o?{width:b.width()+20,height:b.height()+20}:{width:q,height:q}),n=(e.getElementById("previewPage")?{width:c.innerWidth-f-i,height:c.innerHeight}:{width:b.width(),height:b.height()}),m;m=utils.getFitSize({object:h,frame:n,expand:o||false});d=m.width/h.width}if(!preview.useZoomSlider&&(preview.parentAccessible||preview.canAccessFrame())&&window.frameElement){var p=e.getElementById("previewZoomSlider");if(p){p.value=d}}if(o){if(c===window){b[0].contentWindow.preview.useZoomSlider=true}else{preview.useZoomSlider=true}}b.css({"-webkit-transform":"scale("+d+")","-moz-transform":"scale("+d+")","transform":"scale("+d+")"});preview.centerFrame(c);preview.positionNotes();preview.currentFrameScale=d;preview._showPreviewPage(true)},scaleViewport:function(i){if(!preview.viewportScaled){i=i||$(".ui-page-active");var f=$(".ui-content",i);var d=window.innerWidth;var h=preview.getTrueHeight();var c=d>h?[h,d]:[d,h];var a=preview.projectWH[0];var e=preview.projectWH[1];var b=a>e?[e,a]:[a,e];preview.pageScale=Math.min(c[0]/b[0],c[1]/b[1]);if(utils.hideBrowserBar()){window.scrollTo(0,1)}}},applyPageTransforms:function(c){var e=preview.pageScale!==1?"scale("+preview.pageScale+") ":"";var b=preview.pageRotation!=0?"rotate("+preview.pageRotation+"deg)":"";var d=(preview.pageTranslation[0]||preview.pageTranslation[1])?" translate("+preview.pageTranslation[0]+"px,"+preview.pageTranslation[1]+"px)":"";var a=e+b+d;$(".widgetHolder",c).css({"-webkit-transform":a,"-moz-transform":a,"transform":a})},_showPreviewPage:function(a){if(typeof a=="undefined"){a=true}var b=$("#previewPage");if(b.size()==0){if(preview.parentAccessible){b=$("#previewPage",window.parent.document)}else{if(window.parent!==window){preview._crossDomainCall(window.parent,"_showPreviewPage",[a])}}}b.css({visibility:a?"visible":"hidden"})},updateExportUi:function(c){var d={Pages:$("#previewShareContainer .shareLinkExportImg").add("#projectSettingsShareTop .shareLinkExportImg"),Project:$("#previewShareContainer .shareLinkExportImgFull").add("#projectSettingsShareTop .shareLinkExportImgFull")};var j;var h=["Pages","Project"];var e;var b;for(var f=0,a=h.length;f<a;f++){e=c["export"+h[f]];j=d[h[f]].next(".msg");if(e&&e.snapshotId){if(e.status==="FINISHED"){j.html('<a class="export-link" rel="'+e.snapshotId+'">Download ('+e.processDate+")</a>");b=j.find(".export-link");b.click(function(i){window.open(document.location.origin+document.location.pathname+"snapshot/"+i,"_snapshot")}.bind(b,e.snapshotId));j.removeClass("pulsing")}else{if(e.status==="STARTED"||(e.status==="NEW"&&e.queue===0)){j.html("exporting...");j.addClass("pulsing");share.startExportPolling(e.snapshotId)}else{if(e.status==="NEW"){e;j.html("queued ("+e.queue+")...");j.addClass("pulsing");share.startExportPolling(e.snapshotId)}else{if(e.status==="FAILED"){j.html("export failed...");j.removeClass("pulsing")}}}}}else{j.html("");j.removeClass("pulsing")}}},getLastExports:function(){var a=project.get("id");$.ajax({url:"./index.php",type:"POST",data:{t:"getLastExport",objectId:a},success:function(b,e,d){var c=JSON.parse(b);preview.updateExportUi(c)}})},open:function(i,h){preview.getLastExports();canvas2.setEditorVisibility(false);$("#previewPage").contents().find("body").remove();$("#hud .hud-buttons .hud-secondary").hide();fluid.command.create("hideButton").dispatchTo("fluid.controllers.timeline");hint.show("startedPreview");preview.hideMenu();fluid.controllers.bin.hide();preview.hideNotes();if(document.getElementById("previewShowNotes").checked){preview.getNotesElement().style.display=""}else{preview.getNotesElement().style.display="none"}preview._showPreviewPage(false);var c=account.get("lastOpenProject");project.checkIntegrity(c);var f=project.get("pageWH");var b=project.isMultiOrientation();if(i&&(i.currentTarget.id=="preview"||i.currentTarget.id==="pagePreview")){project.save();project.sync();var j=(document.location.href).split("?");var d=c+"."+project.get("updated");share.init(c);preview.embedURL=j[0]+"embed/"+d;var a=$("#tmplEmbedCode").tmpl({url:preview.embedURL,width:b?Math.max(f[0],f[1]):f[0]+64,height:b?Math.max(f[0],f[1]):f[1],multiorient:b}).html();$("#embedCode").html(a)}if(account.get("loggedIn")!="yes"){$("#previewSignup").show()}$("#previewPage").css({width:f[0],height:f[1],webkitTransform:"scale(2)",transform:"scale(2)"}).attr("src","project/"+c);$("#previewHolder").fadeIn(200).addClass("open");preview.displaySharePanel();preview.centerFrame();preview.isOpen=true},close:function(){canvas2.setEditorVisibility(true);hint.restart();$("#hud .hud-buttons .hud-secondary").fadeIn(300);fluid.command.create("showButton").dispatchTo("fluid.controllers.timeline");$("#previewPage").find(".widgetHolder").empty();$("#previewSignup").hide();$("#previewHolder").removeClass("open").fadeOut(200);$(".messageError").hide();signup.toggleTabMessage();preview.startPage=null;fluid.controllers.bin.show();preview.isOpen=false},displaySharePanel:function(b){var a=b==undefined?true:false;if(project.readOnly()){a=false}if(a){if(account.get("loggedIn")=="yes"){$("#previewShare").show();preview.updateScrollbar()}}else{$("#previewShare").hide()}},parseDownload:function(a,i,c){var f="Couldn't download correctly (has it been deleted/made inactive?)";try{var b=JSON.parse(c.responseText)}catch(h){$("body").html("Unable to parse download - unknown error (1)");throw ("Error Downloading "+item+"Caller:"+arguments.callee.caller+" Second level:"+arguments.callee.caller.caller+"loadSate"+loading_Stage_Check)}if(b.r!="s"){preview.displayErrorMessageOnLoad(f);return false}try{var d=JSON.parse(b.t.toString())}catch(h){preview.displayErrorMessageOnLoad("Unable to download the mockup - download was interrupted.")}var b=d[g_preview];if(b&&b.active===false){preview.displayErrorMessageOnLoad(f);return false}if(preview.exported){preview.afterPreviewLoad(d)}else{return d}},displayErrorMessageOnLoad:function(a){$("body").html(a);preview.scaleFrame(true,true)},afterPreviewLoad:function(e){var b=branding.deviceScreen(),c=b.device,l=b.screen,f=e[window.g_preview]||e,k=f.deviceModel,j,m,i=window.innerWidth>window.innerHeight,d=document.getElementById("homePageStyle"),h='<link id="appIcon" rel="apple-touch-icon" href="'+(branding.getUrl("icon",null,f)||"img/apple-touch-icon-144.png")+'" />';if(/iPhone/.test(k)){j=(branding.getUrl("splash"+k,l.splash,f)||"img/fluidLoading"+branding.screens[k].splash+".png");h+='<link id="splashP" rel="apple-touch-startup-image" href="'+j+'" />'}else{j=branding.getUrl("splashP"+k,l.splashP,f)||(l.splashP?"img/fluidLoading"+l.splashP+".png":"");m=branding.getUrl("splashL"+k,l.splashL,f)||(l.splashL?"img/fluidLoading"+l.splashL+".png":"");h+='<link id="splashP" rel="apple-touch-startup-image" sizes="'+l.splashP+'" media="(orientation: portrait)" href="'+j+'" />'+'<link id="splashL" rel="apple-touch-startup-image" sizes="'+l.splashL+'" media="(orientation: landscape)" href="'+m+'" />'}d.innerHTML="#homePage { background: url("+(i&&m?m:j)+") no-repeat bottom; "+"background-size: "+(/iPad/.test(k)?(i?"1024px 748px;":"764px 1004px;"):k==="iPhone5"?"320px 568px;":k==="iPhone"?"320px 460px;":(i?f.pageWH[0]+"px "+f.pageWH[1]+"px;":f.pageWH[0]+"px "+f.pageWH[1]+"px;"))+"}";if(!c){if(!j&&!m){document.head.removeChild(d);$("#default-branding-links").tmpl().appendTo("head")}}$("head").append(h);$(document).ready(function a(n){if(utils.isMobileDevice()){$("body").addClass("mobile")}widget.useCanvas=true;preview.runDraw(e);$(window).bind("orientationchange",function(){$("body").scrollTop(0).scrollLeft(0);loading_Stage_Check="preview Loaded"})})},load:function(a,d){try{preview.parentAccessible=!!(window.frameElement&&window.frameElement.ownerDocument)}catch(c){preview.parentAccessible=false}var b=storage.get(a);if(b&&b.unloaded!==true){if(typeof d==="function"){d(b)}if(window.g_print){preview.runDraw(a)}}else{ajax.syncDown(a,function(e){var f=preview.parseDownload.apply(this,arguments);if(typeof d==="function"){d(f)}e=JSON.parse(e);var h=JSON.parse(e.t);if(window.g_print){preview.runDraw(h)}})}},draw:function(v){if(!v){return false}if($.mobile){$.mobile.defaultHomeScroll=0}for(var z in v){storage.setTempItem(z,v[z])}var f=v[g_preview]||v;for(var p=0;p<f.pages.length;p++){var b=storage.get([f.pages[p]]);preview.pageNotes[f.pages[p]]=b&&b[3]||""}preview.viewportScaled=window.navigator.hasOwnProperty("standalone")&&window.navigator.standalone;preview.projectWH=[f.pageWH[0],f.pageWH[1]];var o=preview.viewportScaled?preview.projectWH[0]:$(window).width();var c=preview.viewportScaled?preview.projectWH[1]:preview.getTrueHeight();if(utils.isMobileDevice()&&o>c&&window.screen.width<window.screen.height){var t=o;o=c;c=t}var w=preview.viewportScaled?Math.min(window.screen.width/o,window.screen.height/c):1;$("#metaViewport").attr("content","width="+o+",height="+c+",minimum-scale="+w+",maximum-scale="+w+",initial-scale="+w+",user-scalable=0");if(preview.parentAccessible){if(!window.g_embedded){try{var h=$("#previewPage",window.parent.document);if(h.size()>0){h.css({width:f.pageWH[0],height:f.pageWH[1]});$(".ui-mobile-viewport").css("overflow","hidden")}}catch(s){}}preview.scaleFrame()}else{if(window.parent!==window){preview._crossDomainCall(window.parent,"setFrameSize",f.pageWH)}}$(".pageList").css("height",preview.getTrueHeight()+"px");document.title=f.name;document.projectLoaded=true;for(var p=0;p<f.pages.length;p++){if(!storage.get(f.pages[p])){f.pages.splice(p,1);p--}}if(!storage.get(f.homepage)){f.homepage=f.pages[0]}var m=f.orientation;preview.multiOrientations=false;for(var p=0,q=f.pages.length;p<q;p++){if(storage.get(f.pages[p]).orientation!=m){preview.multiOrientations=true;break}}if(browserDetect.OS=="Android"&&preview.multiOrientations){var u=$(window).width();var j=window.outerHeight||getTrueHeight();$(".ui-mobile-viewport").css({"min-height":Math.max(u,j)+"px"})}if(window.g_embedded&&(preview.projectWH[0]>preview.projectWH[1]||preview.multiOrientations)){}if(window.g_print||window.g_imgExport){for(var p=0,q=f.pages.length;p<q;p++){preview.drawPage(f.pages[p],f)}$("#font-preloader").remove();if(window.g_imgExport){var l=[];var a={};for(var p=0;p<f.pages.length;p++){a=$.extend({},storage.get(f.pages[p]));a.id=f.pages[p];l.push(a)}preview.pagesArr=l;preview.pagesArr=l;setTimeout(function(){$("#home").hide();if(typeof window.callPhantom==="function"){window.callPhantom({event:"finishedrendering",pages:l})}},3000)}}else{var k=null,r;try{var d=window.frameElement&&window.frameElement.ownerDocument.defaultView;k=d&&d.preview&&d.preview.startPage}catch(n){k=null}r=k||(f.homepage?f.homepage:f.pages[0]);preview.homePage=r;preview.drawPage(r,f);if(typeof g_previewMode!="undefined"&&g_previewMode==true){preview.scaleViewport();preview.bindMobileEvents(f.links);g_homepage=r;setTimeout(function(){preview.changePage("#"+r,null,false,true)},preview.delayStart)}}},showPage:function(a){$(".previewPage").hide();$("#"+a).show();if(typeof window.callPhantom==="function"){window.callPhantom({event:"shownPage",id:a})}},drawPage:function(b,e){if(!e){e=storage.get(g_preview)}var f=window.g_imgExport=="true"?"white":"transparent";var h=storage.get(b);if(!h){return}var a=[h.width,h.height];var d={pageId:b,width:a[0],height:a[1],widthScreen:$(window).width(),heightScreen:preview.getTrueHeight(),bgColor:f};if(window.g_embedded){if(preview.multiOrientations){if(a[0]>a[1]){d.top=(a[0]-a[1])>>1}else{d.left=(a[1]-a[0])>>1}}else{d.left=$(".previewLogoHolder").outerWidth()}}if((window.g_print)&&(h.notes!=undefined)){d.notes=h.notes[3];d.title=h.name==undefined?"":h.name}var c=$("#tmplPreviewPage").tmpl(d).appendTo("body");preview.drawWidgets(g_preview,b,e.links);preview.showLinks(e.links,b);$("#"+b).bind("pageshow",preview.navigateInit)},changePage:function(h,i,e,a){var c=h.substr(1);if($(h).size()==0){preview.drawPage(c);$(h).trigger("pageinit")}$(h).addClass("visited");var j=i;var b=a=="undefined"?true:!a;if((!j)&&(b)){var f=preview.navigationDefaultTransition.split(":");var d=(f.length>1)?true:false;j={transition:f[0],reverse:d}}preview.orient(null,$(h),$(".ui-page.ui-page-active"));if(utils.isMobileDevice()){$.mobile.changePage(h,j)}else{setTimeout(function(){$.mobile.changePage(h,j)},300)}if(window.Android){Android.updateOrientation()}window.setTimeout(function(){preview.preloadLinkedPages(c);preview._fixNavigationStatus(c,i,e)},100)},_fixNavigationStatus:function(c,d,e){if((preview.navigationStackBack.length>0)&&(e!=2)){var b=d;if(preview.navigationQueueNext.length>0){if(preview.navigationQueueNext[0].args){b=preview.navigationQueueNext[0].args;b.reverse=!b.reverse}}preview.navigationStackBack.push({pageId:c,args:b})}preview.navigationQueueFlow=$.grep(preview.navigationQueueFlow,function(h,f){return h.pageId!=c});var a=$("#"+c).hasClass("blank");if(!a){preview.navigationQueueFlow.push({pageId:c,args:d})}preview.navigationQueueNext=$.grep(preview.navigationQueueNext,function(h,f){return h.pageId!=c})},_isPageVisited:function(a){var b=$("#"+a);if((b.size()>0)&&(b.hasClass("visited"))){return true}return false},preloadLinkedPages:function(b){if((preview.navigationCompleted)&&(preview.navigationQueueFlow.length>1)){var f=preview.navigationQueueFlow.slice(0);var i=f.pop();preview.navigationStackBack.push(i);return}var d=storage.get(g_preview);var h=storage.get(b);var a=d.links;var e=0;var c=0;$.each(a.linkOrigin,function(n,k){if(a.linkType[n]=="ahref"&&$("#"+k).closest(".page").attr("id")==b){var j=a.linkDest[n];var q=storage.get(j);if(!q){return}var o=$("#"+j);if((o.size()==0)&&(q.widgets.length>0)){var r=a.transType[n].split(":");var m=(r.length>1)?true:false;var l={transition:r[0],reverse:m};preview.navigationQueueNext.push({pageId:j,args:l});preview.drawPage(j,d);e++}else{if(o.size()>0){if((preview.navigationQueueFlow.length>0)&&(j==preview.navigationQueueFlow[0].pageId)&&(!preview.navigationQueueFlow[0].args)){var r=a.transType[n].split(":");var m=(r.length>1)?true:false;preview.navigationQueueFlow[0].args={transition:r[0],reverse:m}}}}}if((preview.navigationStackBack.length==0)&&(c<1)){if((a.linkType[n]=="ahref")&&(a.linkDest[n]==b)){var j=preview.getPageIdForWidget(k);var q=storage.get(j);if(!q){return}if((!preview._isPageVisited(j))&&(q.widgets.length>0)){var r=a.transType[n].split(":");var m=(r.length>1)||r[0]=="none"?false:true;var l={transition:r[0],reverse:m};preview.navigationStackBack.push({pageId:j,args:l});c++}}}});preview.preloadNextUndisplayedPage(d);preview.preloadPreviousUndisplayedPage(d)},preloadNextUndisplayedPage:function(a){return preview.findUnlinkedPage(a,a.pages,preview.navigationQueueNext,true)},preloadPreviousUndisplayedPage:function(a){var d=a.pages.slice(0);preview.findUnlinkedPage(a,d.reverse(),preview.navigationStackBack,false);if((preview.navigationCompleted)&&(preview.navigationQueueFlow.length>1)){var b=preview.navigationQueueFlow.slice(0);var c=b.pop();preview.navigationStackBack.push(c)}},findUnlinkedPage:function(c,a,e,b){if((preview.navigationCompleted)||(e.length>0)){return false}var d=false;$.each(a,function(h,f){if(!preview._isPageVisited(f)){var j=storage.get(f);if(j.widgets.length>0){e.push({pageId:f,args:null});if(b){preview.drawPage(f,c)}d=true;return false}}});if(!d){preview.navigateSetCompleted()}return d},showLinks:function(b,a){$.each(b.linkOrigin,function(d,c){if(b.linkType[d]=="ahref"&&(!a||$("#"+c).closest(".page").attr("id")==a)){$("[id="+c+"]").addClass("widgetLink");var f=$("[id="+c+"]").attr("data-lockto");var e=$('[data-lockto="'+f+'"]').each(function(){var h=$(this).attr("id");if(preview.linkShowRipple(h,c)){$("#"+h).addClass("widgetLink")}})}})},drawWidgets:function(e,d,c){var j=$("#"+d).find("[data-role=content]");var b=[];for(var h in c.linkDest){if(c.linkType[h]=="template"&&c.linkDest[h]==d){var f=page.get(c.linkOrigin[h],"widgets");b=b.concat(f)}}var f=page.get(d,"widgets");widgetList=b.concat(f);for(var h=0;h<widgetList.length;h++){widget.checkIntegrity(widgetList[h])}if(widgetList.length>0){var a=true;widget.load(d,widgetList,a)}else{preview.showBlankPage(d,c)}},showBlankPage:function(b,a){var c=$("#blankPage").find(".pageList").html();var d=$("#"+b).find(".widgetHolder");d.html(c);d.parent().addClass("blank");$(".blankPageBackButton",d).bind("click",preview.navigateBack)},getPageIdForWidget:function(d){var c=storage.get(g_preview);var a=c.pages;var b="";$.each(a,function(e,f){var h=storage.get(f).widgets;$.each(h,function(j,i){if(i==d){b=f;return false}});if(b!=""){return false}});return b},orient:function(c,b,a){if(!window.g_embedded){try{if(utils.isMobileDevice()){preview._orientMobile(b,a)}else{preview._orientParent(b,a)}preview.scaleViewport(b);preview.centerFrame()}catch(c){}}},_orientationData:function(k){var e=storage.get(g_preview);var h=storage.get(k.attr("id"));var c=e.pageWH||[320,480];var i=h.orientation?(h.orientation!="Landscape"):(h.width<=h.height);var a=i?h.width>h.height:h.width<=h.height;var b=$.event.special.orientationchange;var d=(b&&$.isFunction(b.orientation))?b.orientation()=="portrait":window.screen.width<window.screen.height;var f=c[1]>=c[0];var j=i&&f||!i&&!f;return{portrait:i,crossOriented:d!=i,multiOriented:preview.multiOrientations,projectOriented:j,width:c[0],height:c[1],}},_orientMobile:function(c,a,d){d=d||preview._orientationData(c);preview.pageRotation=d.crossOriented?(d.portrait?-90:90):0;var b;if((d.portrait&&d.projectOriented)||(!d.portrait&&!d.projectOriented)){b="width"}else{b="height"}preview.pageTranslation=preview.pageRotation?(preview.pageRotation>0?[0,-d[b]]:[-d[b],0]):[0,0];preview.applyPageTransforms(c);if(browserDetect.OS=="iOS"){var f=window.screen.width*(preview.viewportScaled?window.devicePixelRatio:1);var h=window.screen.height*(preview.viewportScaled?window.devicePixelRatio:1);var e=d.portrait!=d.crossOriented;$(document.body).css({width:(e?Math.min(f,h):Math.max(f,h))+"px"})}else{if(utils.hideBrowserBar()){window.scrollTo(0,1)}}},orientPrevPage:function(c,a,d){if(!a){return}var b,e=(d.portrait&&d.projectOriented)||(!d.portrait&&!d.projectOriented);translateSide=e?"width":"height";if(d.portrait){b="rotate(90deg) translate(0,-"+d[translateSide]+"px)"}else{b="rotate(-90deg) translate(-"+d[translateSide]+"px, 0)"}$(".widgetHolder",a).css({"-webkit-transform":b,"-moz-transform":b,"transform":b})},_orientParent:function(d,b,f){var h=$("#previewPage",preview.parentAccessible?frameElement.ownerDocument:document);f=f||preview._orientationData(d);if(f.crossOriented){preview.orientPrevPage(d,b,f);if(h&&h.length){preview.hideNotes();var a=h[0],e=a.parentNode,c={};if(f.projectOriented){c.width=f.width;c.height=f.height}else{c.width=f.height;c.height=f.width}$(".widgetHolder",d).css({"-webkit-transform":"","-moz-transform":"","transform":"","width":c.width+"px","height":c.height+"px"});a.style.width=c.width+"px";a.style.height=c.height+"px";preview.centerFrame(window.parent||window);if(f.portrait){e.classList.remove("to-landscape");e.classList.add("to-portrait")}else{e.classList.remove("to-portrait");e.classList.add("to-landscape")}}else{if(window.parent!==window){preview._crossDomainCall(window.parent,"_orientParent",[null,null,f])}}}fluidEvent.triggerPreview("changeOrientation",{},true)},finishOrient:function(c,b,a){if(!window.g_embedded){try{if(!utils.isMobileDevice()){preview._finishOrient(b,a)}}catch(c){}}},clearPageOrientation:function(){preview.pageRotation=0;preview.pageTranslation=[0,0]},_finishOrient:function(b,a,c){var d=preview.parentAccessible&&window.parent&&$("#previewPage",window.parent.document);c=c||preview._orientationData(b);if(preview.parentAccessible&&b){preview.multiOrientations=c.multiOriented;preview.updateNotes(b[0].id);preview.positionNotes();preview.showNotes()}if(a){preview.clearPageOrientation();a.find(".widgetHolder").css({transform:"",webkitTransform:"",mosTransform:""});preview.clearPageOrientation();preview._crossDomainCall(window.parent,"_finishOrient",[null,null,c])}},bindMobileEvents:function(i){scrollview.setup(i);function d(l,k){preview.pageTransitioning=true;scrollview.showPage.call(l.target,l)}function b(l,k){scrollview.isScrolling=false;scrollview.isDoubleTapping=false;scrollview.isSwiping=false;preview.pageTransitioning=false;preview.finishOrient(l,$(l.target),k.prevPage);$(".ui-scrollview-clip",l.target).scrollview("option","rotate",preview.pageRotation);if(window.g_imgExport=="true"){l.stopImmediatePropagation()}setTimeout(function(){scrollview.isTapHolding=false;if(utils.hideBrowserBar()){window.scrollTo(0,1)}},350)}function h(k){preview.orient(k,$.mobile.activePage);$(".ui-scrollview-clip",$.mobile.activePage).scrollview("option","rotate",preview.pageRotation)}function e(o){scrollview.isScrolling=false;scrollview.isDoubleTapping=false;scrollview.isTapHolding=false;scrollview.isSwiping=true;var l={"up":0,"right":90,"down":180,"left":270};var k={0:"up",90:"right",180:"down",270:"left"};var n=o.type.substr(5);var m=k[(360+(l[n]-preview.pageRotation))%360];preview.handleUserInput("swipe"+m,$(o.currentTarget).attr("id"),i);return false}function a(k){k.stopImmediatePropagation();if(scrollview.isSwiping){scrollview.isSwiping=false}else{if(scrollview.isScrolling){scrollview.isScrolling=false}else{if(scrollview.isDoubleTapping){scrollview.isDoubleTapping=false}else{if(scrollview.isTapHolding){scrollview.isTapHolding=false}else{preview.handleUserInput(k.type,$(k.currentTarget).attr("id"),i)}}}}}function j(l){scrollview.isTapHolding=true;var k=$(l.currentTarget).attr("id");preview.handleUserInput(l.type,k,i)}function f(l){scrollview.isDoubleTapping=true;var k=$(l.target).parents(".pageWidget").attr("id");preview.handleUserInput("doubletap",k,i)}function c(k){$(document).trigger("mouseup")}if(utils.isMobileDevice()){if($.support.orientation){$(window).bind("orientationchange",h)}$(window).resize(function(){window.setTimeout(function(){preview.scaleViewport($.mobile.activePage)},100)})}$("body").bind("pageinit",function(k){$(".pageWidget",k.target).doubletap(f)}).bind("pagebeforeshow",d).bind("pageshow",b).mouseleave(c);$(document).bind("touchmove",false);$(".pageWidget").live("swipeleft swiperight swipeup swipedown",e).live("vclick",function(k){k.preventDefault();a(k)}).live("taphold",j)},handleUserInput:function(d,e,b){if(scrollview.isScrolling){return false}d=(d=="vclick"||d=="click")?"tap":d;var a=preview.linkCheck(e,b);if(a>-1&&b.triggerType[a]==d){preview.navigateSetIncompleted();var f=b.transType[a].split(":");var c=(f.length>1)?true:false;preview.changePage("#"+b.linkDest[a],{transition:f[0],reverse:c})}else{}},signupComplete:function(){project.sync()},alertCopyEmbedCode:function(a){notification.add("alert","Embed Code Copied");tracker.record("copiedEmbedCode",5,"",a)},showDebugInfo:function(b){var a=$("#divDebugInfo").html();if(a){b=a+b}$("#divDebugInfo").remove();$("body").append("<div id='divDebugInfo'>"+b+"<br/></div>")},getTrueHeight:function(){return(window.hasOwnProperty("innerHeight")?window.innerHeight:$(window).height())||480},updateScrollbar:function(){$("#Preveiw").tinyscrollbar()},linkCheck:function(c,a){do{var b=$.inArray(c,a.linkOrigin);if(b>-1){return b}c=storage.get(c);if(c==null){return -1}c=c.of}while(c);return -1},linkShowRipple:function(c,b){var a=storage.get(c);if(a&&a.segments==null){if(a.of==null){return}if(b!=a.of){if(preview.linkShowRipple(a.of,b)){$("#"+c).addClass("widgetLink")}}if(b==a.of){return true}}},runDraw:function(b){var c=b;var a;if(typeof(b)=="string"){b=project.bundle(b);a=b[g_preview];if(!a||!a.pages){ajax.syncDown(c,preview.parseDownload);return}}preview.loaded=true;preview.navigationStackBack=[];preview.navigationStackForward=[];preview.navigationQueueNext=[];preview.navigationQueueFlow=[];preview.navigationCompleted=false;preview.navigationDefaultTransition=a?a.defaultTransition:"none";preview.draw(b)},restart:function(){preview.changePage("#"+preview.homePage,null,false,true)},hideMenu:function(){},navigateInit:function(b,a){preview.navigationEnabled=true},navigateSetCompleted:function(){preview.navigationQueueNext=[];preview.navigationStackForward=[];preview.navigationCompleted=true},navigateSetIncompleted:function(){preview.navigationCompleted=false},navigateWithKeys:function(c){if((c.keyCode==27)&&(self!=top)&&(window.parent.lib!=undefined)){window.parent.lib.esc()}var b=utils.getNavigationKeyDirection(c.keyCode);if(b==""){return}var a=top==self?document.getElementById("previewPage").contentWindow.preview:window.preview;if((!a)||(!a.navigationEnabled)){return}if((b=="top")||(b=="right")){a.navigateNext();return}a.navigateBack()},navigateNext:function(){if(preview.navigationStackForward.length>0){var a=preview.navigationStackForward.pop();preview.changePage("#"+a.pageId,a.args);return}if(preview.navigationQueueNext.length>0){var a=preview.navigationQueueNext.shift();preview.changePage("#"+a.pageId,a.args);return}if(preview.navigationQueueFlow.length>0){var a=preview.navigationQueueFlow.shift();preview.changePage("#"+a.pageId,a.args);return}},navigateBack:function(){if(preview.navigationStackBack.length>1){var h=preview.navigationStackBack.pop();var f=preview.navigationStackBack.pop();var a=$("#"+f.pageId).hasClass("blank");if(a){if(preview.navigationStackBack.length>0){f=preview.navigationStackBack.pop()}else{return}}if(preview.navigationCompleted){var e=preview.navigationQueueFlow.pop();preview.navigationQueueFlow.splice(0,0,e);var b=preview.navigationQueueFlow.pop();if(b.pageId!=f.pageId){preview.navigationQueueFlow.push(b)}}else{preview.navigationStackForward=$.grep(preview.navigationStackForward,function(k,j){return k.pageId!=h.pageId});var d=$("#"+h.pageId).hasClass("blank");if(!d){var c={pageId:h.pageId,args:f.args};preview.navigationStackForward.push(c)}}preview.changePage("#"+f.pageId,f.args,1);return}if((preview.navigationCompleted)&&(preview.navigationQueueFlow.length>0)){var e=preview.navigationQueueFlow.pop();preview.changePage("#"+e.pageId,e.args,1)}},_crossDomainCall:function(c,b,a){c.postMessage(JSON.stringify({funcName:b,args:a}),"*")},_crossDomainCallListener:function(a){var b=JSON.parse(a.originalEvent.data);if($.isFunction(preview[b.funcName])){preview[b.funcName].apply(preview,b.args)}},getNotesElement:function(c){c=c||window;var b=c.document.getElementById("inPreviewNotes");if(b){return b}try{if(c.frameElement){return preview.getNotesElement(c.frameElement.ownerDocument.defaultView)}}catch(a){}return null},positionNotes:function(){var b=preview.getNotesElement(),c=b&&b.clientWidth||0;if(b){var d=document.getElementById("previewPage")||window.frameElement,a=d.getClientRects()[0];if(!a){return}x=a.left;y=a.top;b.style.left=(x-c+1)+"px";b.style.top=Math.max(y,0)+"px"}},updateNotes:function(a){var b=preview.getNotesElement();if(!b){return}var d=preview.getNotesElement().querySelector("#previewNotesContent"),c=page.get(a,"notes");d.textContent=c&&c[3]||"This page has no notes"},showNotes:function(){notesElement=preview.getNotesElement();notesElement&&notesElement.classList.remove("hide")},hideNotes:function(){notesElement=preview.getNotesElement();notesElement&&notesElement.classList.add("hide")},toggleShare:function(){var a=document.getElementById("previewShare");if(a.classList.contains("closed")){preview.openShareMenu(a)}else{preview.closeShareMenu(a)}preview.scaleFrame()},openShareMenu:function(){var a=document.getElementById("previewShare");a.classList.remove("closed");preview.centerFrame()},closeShareMenu:function(){var a=document.getElementById("previewShare");a.classList.add("closed");preview.centerFrame()},centerFrame:function(e){e=e||window;var l=e.document,d=l.getElementById("previewPage"),h=d&&d.parentNode,a=l.getElementById("previewShare"),b=a&&!a.classList.contains("closed")&&a.getClientRects()[0],i=b?b.width:0,c=parseInt(d.style.width)+20,m=parseInt(d.style.height)+20,f=((e.innerWidth-e.previewMenu.width-i)/2+i),k=(e.innerHeight)/2;var j=h.style;j.marginLeft=-(c/2)+"px";j.marginTop=-(m/2)+"px";j.left=f+"px";j.top=k+"px";j.width=c+"px";j.height=m+"px";setTimeout(preview.positionNotes,400)},setFrameSize:function(b,a){$("#previewPage").css({width:b,height:a});preview.scaleFrame()},canAccessFrame:function(){try{return !!(document.getElementById("previewPage").contentWindow.document)}catch(a){return false}}};var page={frame:null,frameVisible:false,menu:null,displayingMenu:false,orient:function(){var a=$(".screen.active");var c=a.attr("id");var b=$(this).val();page.update({orientation:b},c);a.each(page.resizeAfterOrient);page.updateOptionsMenu();hint.show("library");grid.showGrid()},resizeAfterOrient:function(){var c=$(this);var a=c.attr("id");var b=[page.get(a,"height"),page.get(a,"width")];c.css({"width":b[0],"height":b[1]});c.find(".page").css({"width":b[0],"height":b[1]});c.find(".page").children(".widgetHolder").css({"width":b[0],"height":b[1]});page.update({width:b[0],height:b[1]},a);if(project.get("currentZoom")===1&&c.hasClass("active")){if($("#"+a).hasClass("active")){page.drawDetailed(a,"init")}}else{page.draw(a,"init")}link.update(c)},updateOptionsMenu:function(){var c=project.getActivePageId();if(typeof c==="undefined"){return}var k=project.get("pageWH");var n=project.get("homepage");var d=page.get(c,"orientation");var i=project.get("orientation");var j=$("#pageMenu");var l=n==c?"This is the start page":"Make this the start page";var o=n==c?"Start page - Home":"";var h=n==c?"homePageOn":"homePageOff";var m=page.get(c,"name");m=m==undefined?"":m;$(".homePageStatusText").text(l);$(".iconPageSettingsIndicator").not(".gridOff, .gridOn, .snapToWidgetsOff, .snapToWidgetsOn").removeClass("homePageOn homePageOff").addClass(h).attr("alt",o).attr("title",o);j.find(".pageSize.rangeWidget.width>input").val(page.get(c,"width"));j.find(".pageSize.rangeWidget.height>input").val(page.get(c,"height"));j.find(".orientationSelector2").find("[value='"+i+"']").attr("selected","selected");var b=j.find(".buttonSwitchContainer");b.children().removeClass("activeOption");b.find("[data-for='"+d+"']").addClass("activeOption");$(".inputPageTitle").val(m);var a=project.get("deviceModel");var f=$("#DeviceSizeTmpl");if(a){$("option[data-type='"+a+"']",f).attr("selected","selected")}else{var p=project.get("pageWH");var e=false;$.each(f.children(),function(q,s){if($(s).val()!="Custom"){var r=$(s).val().split(",");if(((p[0]==r[0])&&(p[1]==r[1]))||((p[0]==r[1])&&(p[1]==r[0]))){$(s).attr("selected","selected");e=true;return false}}});if(!e){$("option[data-type='Custom']",f).attr("selected","selected")}}if($("option:selected",f).val()=="Custom"){$(".screenSize").parents("tr").children().show()}else{$(".screenSize").parents("tr").children().hide()}updateTLWH();var m=page.get(c,"name");grid.selectBackground()},addViaLinkDrop:function(d,n,i,k){var a=page.add(i);if(!a){return}var o=project.get("currentZoom");var l=Math.floor(Math.random()*1000);var f=Math.floor(parseInt($("#"+a).css("left"))-400-(l*3));var c=(parseInt($("#"+a).css("top")))-500+l;var h=100+l/3;$("#"+a).hide().fadeIn(h).css({left:f,top:c});var j="ahref";var m=$(".zoomedOutSelected").attr("id");var b=link.add(m,a,j);pagesCache[a].box[0]=f;pagesCache[a].box[1]=c;link.draw(b,m,a,j);page.update({x:f,y:c},a);$(b).fadeIn(600);tracker.record("addPage",1,a,i);tracker.record("addLink",1,"",i);return a},click:function(f){group.deselect();if(!$("#canvas").data("zooming")){if($(f.target).closest(".screen").attr("id")==project.getActivePageId()){return}var a=f.originalEvent&&$(f.originalEvent.target);if(a&&(a.hasClass("track")||a.hasClass("thumb"))){return}var c=$(this).closest(".screen");var b=c.attr("id");page.activate(this);var d=project.get("currentZoom");if(d==1){zoomInAndCenterOnPage(c,1,1,400)}else{canvas2.zoom({newZoom:1,page:c})}$("#trash").fadeIn(300)}},makeHome:function(b,a){if(typeof a==="undefined"){a=$(this).closest(".screen")}if($(a).hasClass("template")){return}var c=$(a).attr("id");project.set({homepage:c});page.updateOptionsMenu();$(".screen").removeClass("homePage");$(a).addClass("homePage")},removeHome:function(a){project.set({homepage:a||null});if(a){$("#"+a+".screen").addClass("homePage")}page.updateOptionsMenu()},add:function(f){if(project.readOnly()){notification.add("alert","Switch to an active project before adding pages.");f.preventDefault();f.stopImmediatePropagation();return false}if(!/canvas|hint|viewport/.test($(f.target).attr("id"))){return}if(project.get("currentZoom")==1){return}var a=$("#cmLink").data("lastClicked")||0;if((new Date()).getTime()<a+600){return}if(!f.offsetX){var i=$("#canvas").offset();f.offsetX=f.pageX-i.left;f.offsetY=f.pageY-i.top}var h={top:f.offsetY,left:f.offsetX};if(f.target.id!=="canvas"){h.left=f.originalEvent.pageX+$("#viewport").get(0).scrollLeft;h.top=f.originalEvent.pageY+$("#viewport").get(0).scrollTop}if(!(h.top>=0&&h.left>=0)){var d=$("#canvas");var c=$("#viewport");var h={top:(Math.abs(parseInt(d.css("top"),10))+Math.round(c.height()/2)),left:(Math.abs(parseInt(d.css("left"),10))+Math.round(c.width()/2))}}var b=page.create(h.top,h.left);if(project.get("pages").length===1){fluidMenu.setCanvasFirstPage()}tracker.record("addPage",1,b,f);return b},correctPageCoords:function(f,e){var a=project.get("currentZoom");var c=project.get("canvasWidth")*a;var d=project.get("canvasHeight")*a;var b=project.get("pageWH");if(e+b[1]*a>d){e=d-b[1]*a}if(f+b[0]*a>c){f=c-b[0]*a}return{left:~~f/a,top:~~e/a}},create:function(d,e,h){var f=page.correctPageCoords(e,d);if(!fluid.main.fire("page.beforeAdd")){return}var c=project.get("pageWH");var b=project.get("orientation");var a={x:f.left,y:f.top,width:c[0],height:c[1],orientation:b,widgets:[]};var i=utils.guid("x");project.addPage(i);if(!pagesCache[i]){pagesCache[i]={}}pagesCache[i].box=[a.x,a.y,a.width,a.height];storage.set(i,a);page.template(a,i,h);return i},hideOptionsMenu:function(a){page.hideNotes();page.pageMenuClick();$("#pageMenus").children().addClass("hide")},toggleOptionsMenu:function(b){var a=document.getElementById("pageMenu"),c=!a.classList.contains("hide");page.pageMenuClick();page.updateOptionsMenu();page.toggleMenus();if(!c){a.classList.remove("hide")}},toggleSnapSettings:function(){var a=document.getElementById("snapSettingsPanel");visible=!a.classList.contains("hide");if(visible){page.hideOptionsMenu();return}page.showDefaultSnapOptions()},showDefaultSnapOptions:function(){page.toggleMenus();document.getElementById("snapSettingsPanel").classList.remove("hide");var b=account.get("gridStatus");var a=account.get("snapToWidget");(b=="on")?$("#gridSwitchOn").show():$("#gridSwitchOff").show();(a=="on")?$("#snapSwitchOn").show():$("#snapSwitchOff").show()},resize:function(e,c,j){var h=project.get("pageWH");var i=project.get("orientation");var f=page.get(e,"orientation");if(f!=i){h=[h[1],h[0]]}if((c<h[0])||(isNaN(c))){c=h[0]}else{if(c>h[0]){$(".pageSize").filter(".width").val(c)}}if((j<h[1])||(isNaN(j))){j=h[1]}else{if(j<h[1]){$(".pageSize").filter(".height").val(j)}}var b=$("#"+e+" .page");page.update({width:c,height:j},e);hint.show("library");b.parent(".screen").css({width:c,height:j});b.css({width:c,height:j});b.children(".widgetHolder").css({width:c,height:j});var a=$("#"+e+" .backgroundWidget");var d={top:0,left:0,width:c,height:j};page.autoWidth(b.parent(".screen"));grid.showGrid();return false},get:function(a,c){if(typeof a!="string"){return""}var b=storage.get(a);if(typeof b==="undefined"||!b){return""}return b[c]},updateDragPos:function(a){var e=$(a);var b=project.get("currentZoom");var f=e.position();if(!e.data().draggable){return}var d=Math.round(e.data().draggable.position.top/b);var c=Math.round(e.data().draggable.position.left/b);e.css({top:d+"px",left:c+"px"});e.data().draggable.position.top=d;e.data().draggable.position.left=c;pagesCache[$(a).attr("id")].box[0]=c;pagesCache[$(a).attr("id")].box[1]=d;link.update(e);if(intersectTrash(e)==true){$("#trash").addClass("droppableStyle")}else{$("#trash").removeClass("droppableStyle")}},dragStart:function(b){if((project.readOnly())||($("#canvas").data("zooming"))){return false}var a=project.get("currentZoom");if(a==1){$("#canvasLinks").hide()}},drag:function(){page.updateDragPos(this)},dragStop:function(f){var j=$(this).position();var i=storage.get($(this).attr("id"));var h=storage.get(project.get("id"));var c=h.canvasWidth-i.width;var b=h.canvasHeight-i.height;var k=project.get("currentZoom");var a=Math.min(Math.max(Math.round(j.left/k),0),c);var l=Math.min(Math.max(Math.round(j.top/k),0),b);var d=$(this);fluid.command.create("move",{id:$(this).attr("id"),x:a,y:l}).dispatchTo("fluid.controllers.page");d.appendTo(d.parent("#canvasPages"));link.showahrefs();$("#canvasLinks").fadeIn(200)},selectStart:function(a){if(project.readOnly()){a.preventDefault();a.stopPropagation();return false}},selectStop:function(b){var a=document.querySelectorAll("#canvasPages .ui-selected");widget.resetSelection();widget.selectMulti=true;fluid.util._.forEach(a,function(d){var c=d.dataset.lockto;widget.select("pass",$("#"+c),true)});widget.selectMulti=false;contextMenu.place()},updatePageName:function(){var a=$(this).val();var b=$(this).parents(".screen").attr("id");page.update({name:a},b)},template:function(b,h,f){var e=$.extend(true,{},b);e.id=h;var d=page.get(h,"width");var a=page.get(h,"height");e.screenWH=[d,a];var c=$("#tmplPage").tmpl(e).appendTo("#canvasPages");if(e.id===project.get("homepage")){c.addClass("homePage")}if(f!="init"&&f!="actionHistory"&&f!="useCache"){c.bounce()}},updatePagePreviewButton:function(){var b=$("#pagePreview"),a=$(".canvasObject.active").attr("id");if(a&&storage.get(a).widgets.length){b.animate({opacity:1},300);b.css("pointer-events","")}else{b.animate({opacity:0},300);b.css("pointer-events","none")}},updateNotesIcon:function(){var b=document.querySelector(".canvasObject.active"),a=document.getElementById("pageAddNote");if(!b||!a){return}var c=storage.get(b.id).notes;if(c&&c[3]){a.classList.add("written")}else{a.classList.remove("written")}},hideNotes:function(){var a=document.getElementById("pageNote");if(!a){return}if(!a.classList.contains("hide")){page.saveNotesInput()}a.classList.add("hide")},showNotes:function(){page.hideOptionsMenu();var a=document.getElementById("pageNote");if(!a){return}page.setNotesTextboxValue();a.classList.remove("hide")},saveNotesInput:function(){var b=$(".canvasObject.active").attr("id"),a=$("#pageNote textarea");page.update({notes:[a.width(),a.height(),"",a.val()]},b);page.updateNotesIcon()},setNotesTextboxValue:function(){var b=document.getElementById("pageNote"),a=document.querySelector(".canvasObject.active").id,c=page.get(a,"notes")||[200,120,"",""];$("textarea",b).css({width:c[0],height:c[1]}).val(c[3])},toggleNotes:function(){var a=document.getElementById("pageNote");if(a.classList.contains("hide")){page.showNotes()}else{page.hideNotes()}},toggleMenus:function(){page.hideOptionsMenu();$("#pageMenus").show()},activate:function(b,a,c){if(typeof(b)==="string"){b=$("#"+b)[0]}function d(){if(canvas2.isZoomedOut()){return}$("#canvasPages .screen").removeClass("active").filter($(b)).addClass("active");var f=document.querySelector("#canvasPages .active");$(".screen").selectable("destroy").removeData("initSelectable");$(".screen").draggable("destroy").removeData("initDraggable");if(!project.readOnly()&&f){page.attachFrameTo(f)}grid.zoomIn();page.updateOptionsMenu();staticWidgets.zoomInBoundary();var j=a==undefined?true:a;page.displayMenu(j);if($(b).find(".page-preview").length){page.drawDetailed($(b).attr("id"),"init")}if(c==="wdgDrag"){var h=$([]);for(var e=0;e<widget._dragStartSelection.length;e++){h=h.add("#"+widget._dragStartSelection[e])}widget.select(null,h)}group.drawExisting()}page.detachFrame();if(c!="actionHistory"){setTimeout(d,410)}else{d()}},detachFrame:function(){if(page.frameVisible){page.frame.parentNode.removeChild(page.frame);page.menu.parentNode.removeChild(page.menu);page.frameVisible=page.displayingMenu=false;page.frame.style.display="none"}},attachFrameTo:function(a){page.frame=page.frame||document.getElementById("pageFrame");page.menu=page.menu||document.getElementById("pageMenus");a.appendChild(page.menu);a.querySelector(".page").appendChild(page.frame);page.frame.style.display="block";page.frameVisible=page.displayingMenu=true;page.setNotesTextboxValue();page.updatePagePreviewButton()},displayMenu:function(b){var d=b==undefined?true:b;var e=true;if((project.readOnly()||(canvas2.isZoomedOut()))){e=false}if(e){page.updateNotesIcon();page.updatePagePreviewButton()}if(d&&e){function c(){if((page.displayingMenu)&&($("#pageSettingsMenuContainer").css("display")=="none")){$("#pageSettingsMenuContainer").fadeIn(300)}page.displayingMenu=false}page.displayingMenu=true;page.displayMenuTimer=setTimeout(c,200)}else{if(e){var a=widget.getRoots(".ui-selected");if((a.length==1)&&($(".ui-selected").hasClass("backgroundWidget"))){page.displayMenu();return}}page.displayingMenu=false;$("#pageSettingsMenuContainer").stop(true,true).hide()}},del:function(b){function a(d){$(d).remove();var c=project.get("pages");if(c.length==0){fluidMenu.setCanvasNoPages(true);return}if(!project.hasWidgets()){$("#previewView, #preview, #pagePreview").animate({opacity:0},300);$("#preview, #pagePreview").css("pointer-events","none")}if(canvas2.isZoomedOut()){hint.restart()}}b.each(function(){var c=$(this);var e=c.attr("id");var f=c.find("#canvasPages .widgetHolder > .pageWidget");f.each(function(){var i=$(this);widget.del(i)});link.remove(c);project.deletePage(e);storage.remove(e);if(e==project.get("homepage")){var h=project.get("pages");var d=h&&h.length?h[0]:null;page.removeHome(d)}c.fadeOut(450,a(c))})},deleteManual:function(c){hint.hide();var b=$(".screen.active");var a=project.get("pages");if(a.length>1){page.navigateWithKeys()}else{canvas2.zoomOut(c)}setTimeout(function(){page.del(b)},300)},drawRasterised:function(c,b){page.checkIntegrity(c);var a=page.calculateWdgPositions(c);this.renderer.afterPageRendered=b;if(!a||a.widgets===0){return}this.renderer.renderPage(a)},draw:function(b,h){page.checkIntegrity(b);var j=page.calculateWdgPositions(b);this.renderer.afterPageRendered=null;var i=$("#"+b);if(i.length===0){page.template(j,b,h);i=$("#"+b)}else{var a=i.find(".pageWidget");setTimeout(function(){a.remove()},500)}var c=i.find(".widgetHolder");if(h==="useCache"&&pagesCache[b]["img"]){i.find(".page-preview, .pageWidget").remove();var e=new Image();e.src=pagesCache[b]["img"];c.append(e);c.find("img").addClass("page-preview");return}if(!j||j.widgets===0){return}var f=this.renderer.renderPage(j);group.erase();i.find(".page-preview").remove();if(f.length){var d;if(f[0].$shapeRendition){d=f[0].$shapeRendition}else{if(f[0].$textRendition){d=f[0].$textRendition}else{if(f.length&&f[0].segments){d=f[0].segments[0].$shapeRendition}}}if(d){d.addClass("page-preview");c.append(d)}}},calculateWdgPositions:function(f){if(!this.renderer){this.renderer=new fluid.wdgRenderer()}if(project.useLocalDb){this}var a=$.extend({},storage.get(f));if(a.widgets&&a.widgets.length>0){var c={};for(var b=0;b<a.widgets.length;b++){c[a.widgets[b]]=$.extend({},widget.get(a.widgets[b]))}}a.widgets=c||[];a.id=f;this.renderer.canvasSize=[a.width,a.height];var d=$.extend({},a);for(var e in d.widgets){if(d.widgets.hasOwnProperty(e)){d.widgets[e].box=this.renderer.calculatePageBox(d,e);if(!window.widgetsCache){window.widgetsCache={}}widgetsCache[e]={};widgetsCache[e].box=d.widgets[e].box;widgetsCache[e].pageBox=[d.x,d.y,d.width,d.height];widgetsCache[e].pageId=f}}if(!window.pagesCache){window.pagesCache={}}if(!pagesCache[f]){pagesCache[f]={}}pagesCache[f].box=[d.x,d.y,d.width,d.height];return d},drawDetailed:function(h,f,d){page.calculateWdgPositions(h);var c=$.extend({},storage.get(h));if(!c){return false}var a=$();var b=$("#"+h);if(b.length===0){page.template(c,h,f)}else{a=b.find(".pageWidget")}if(c.widgets.length>0){widget.load(h,c.widgets);updateTLWH()}var e=$("#"+h).find(".page-preview");setTimeout(function(){e.remove()},200);a.remove();if(d&&d.restoreSelection){$("#"+d.restoreSelection).click()}},updateView:function(a,b){var c=true;if(b&&b.zoomedOutOnly){c=false}if(!c&&project.get("currentZoom")===1&&$("#"+a).hasClass("active")){page.drawDetailed(a,"init")}else{if(project.get("currentZoom")!==1){page.draw(a,"init")}}},move:function(e,a,d){page.update({x:a,y:d},e);pagesCache[e].box[0]=a;pagesCache[e].box[1]=d;var b=$("#"+e);var c=b.position();if(c.left!=a||c.top!=d){b.css({left:a+"px",top:d+"px"});link.update(b)}},update:function(b,d){var a=storage.get(d);if(!a){return}for(var c in b){a[c]=b[c]}storage.set(d,a)},orderWidgets:function(d){var b=$(d).parents("li.canvasObject").attr("id");var c=$(d).find(".pageWidget");var a=[];c.each(function(){a.push($(this).attr("id"))});page.update({widgets:a},b)},addWidget:function(b,d,a){var c=storage.get(b);if(a&&a.st&&a.st==="b"){c.widgets.unshift(d)}else{c.widgets.push(d)}storage.set(b,c)},removeWidget:function(a,d){var c=storage.get(a);if(!c){return}var b=$.inArray(d,c.widgets);c.widgets.splice(b,1);storage.set(a,c)},enableSelectableWidgetHolder:function(a){if($(".selectArea").data("selectable")){var c=$(".selectArea").selectable("option","cancel").split(/\s*,\s*/);var b=c.indexOf(".widgetHolder");if(a||a===undefined){if(b>-1){c.splice(b,1);$(".selectArea").selectable("option","cancel",c.join(","))}}else{if(b==-1){c.push(".widgetHolder");$(".selectArea").selectable("option","cancel",c.join(","))}}}},isLinked:function(b,h){var e=project.get("links");var d=project.get("pages");var a=page.get(b,"widgets");var f;for(var c=0;c<a.length;c++){f=e.linkOrigin.indexOf(a[c]);if(f!=-1){if(e.linkDest[f]==h){return e.linkCanvId[f]}}}return false},checkIntegrity:function(b){if(b){var c=page.get(b,"widgets");if(c){var a=storage.get(b);$.each(c,function(d,e){if(!widget.checkIntegrity(e,a)){return false}})}}},autoWidth:function(h){var c=$(h).children(".page");var e=$(h).attr("id");var i=c.children(".widgetHolder");var d=i.children(".rootWidget");for(var f=0;f<d.length;f++){var l=$(d[f]);var b=l.attr("id");var k=storage.get(b);if((typeof(k.tlwh[0])==="string")||(typeof(k.tlwh[1])==="string")||(typeof(k.tlwh[2])==="string")||(typeof(k.tlwh[3])==="string")){var a=widget._setTMPLVars(b,k,[0,0,c.width(),c.height()]);l.css({top:a.absTLWH[0],left:a.absTLWH[1],width:a.absTLWH[2],height:a.absTLWH[3]});widget._resize(l,e,a.tlwh)}}link.update($(h))},duplicate:function(f){var a=$(".screen.active");var d=$(".page",a);var h=a.attr("id");var c=page.get(h,"orientation");var b={top:parseFloat(a.css("top")),left:parseFloat(a.css("left"))+parseFloat(d.css("width"))+100};var j={width:parseFloat(d.css("width")),height:parseFloat(d.css("height"))};var m=page.get(h,"name");var i=m==undefined||m==""?"":m+" - Copy";var l=page.create(b.top,b.left,"init");if(l){var n=$("#"+l);page.update({orientation:c},l);page.update({name:i},l);page.resize(l,j.width,j.height);var o=$.extend(true,{},widget._copies);widget.resetSelection();var k=$("#canvasPages .active .pageWidget");widget._copy(f,k);$(".screen").removeClass("active").filter(n).addClass("active");zoomInAndCenterOnPage(n,1,1,200);page.activate(n);if(widget._copies["oldId"].length>0){widget._paste(f)}widget._copies=$.extend(true,[],o);o=null;widget.resetSelection();setZoomedInActions()}tracker.record("addPageClone",2,l,f);return l},createNew:function(h,d){var k=$("#canvas");var m=project.get("currentZoom");if(!m){m=k.hasClass("canvas100")?1:0.25}var j=project.get("pages");var l=(m===1);var a;d=d||"init";if(l){var b=$(".screen.active").attr("id");if(!b){if(j.length){b=j[j.length-1]}}if(b){var i=storage.get(b);a={top:i.y,left:i.x+i.width+100}}else{var f=$("#viewport");a={top:Math.abs(parseInt(k.css("top"),10))+Math.round(f.height()/2),left:Math.abs(parseInt(k.css("left"),10))+Math.round(f.width()/2)+450}}}else{var f=$("#viewport");a={top:(f.get(0).scrollTop+Math.round(f.height()/2))/m,left:(f.get(0).scrollLeft+Math.round(f.width()/2))/m};d=""}a={top:a.top*m,left:a.left*m};var c=page.create(a.top,a.left,d);if(c){page.postCreate(c)}tracker.record("addPage",1,c,h);return c},postCreate:function(c,b){if(!canvas2.isZoomedOut()){var a=$("#"+c);page.activate(a,undefined,b);zoomInAndCenterOnPage(a,1,1,200);widget.resetSelection();setZoomedInActions()}else{if(project.get("pages").length==1){fluidMenu.setCanvasFirstPage()}}},serialize:function(h){var d=storage.get(h);if(!d){return}var c={id:h};c[h]=d;var f=d.widgets;for(var b=0,a=f.length;b<a;b++){var e=storage.get(f[b]);if(!e){continue}c[f[b]]=e}return JSON.stringify(c)},deserialize:function(i,c){var k=JSON.parse(i);if(k){var a=k.id;var e=k[a];if(!e){return}storage.set(a,e);project.addPage(a);var f=e.widgets;for(var j=0,d=f.length;j<d;j++){var b=f[j];var h=k[b];if(h){storage.set(b,h)}}if(canvas2.isZoomedOut()){page.draw(a,c)}else{page.drawDetailed(a,c)}page.postCreate(a,c)}},navigateWithKeys:function(i){if(canvas2.isZoomedOut()||!canvas2.isEditorVisible()){return true}var j=i!=undefined?utils.getNavigationKeyDirection(i.keyCode):"right";if(j==""){return true}var b=$(".ui-selected").not(".backgroundWidget");if(b.size()>0){return}var c=project.get("pages");if(c<2){return}var f={distance:Number.MAX_VALUE,id:""};var d={distance:0,id:""};var h=$(".screen.active").attr("id");var l={x:page.get(h,"x"),y:page.get(h,"y")};$.each(c,function(m,e){if(h!=e){var o={x:page.get(e,"x"),y:page.get(e,"y")};var n=page._getNavigationDistanceFrom(l,o,j);if((n>=0)&&(n<f.distance)){f={distance:n,id:e}}else{if((n<0)&&(n<d.distance)){d={distance:n,id:e}}}}});var a=f.id!=""?f.id:d.id;if(a!=""){hint.hide();var k=$("#"+a);$(".screen").removeClass("active").filter(k).addClass("active");zoomInAndCenterOnPage(k,1,1,200);page.activate(k);widget.resetSelection();setZoomedInActions()}},_getNavigationDistanceFrom:function(a,d,c){if(a==d){return -1}var b=0;if((c=="left")||(c=="right")){b=d.x-a.x}else{b=d.y-a.y}if(((c=="left")||(c=="top"))&&(b<0)){return Math.abs(b)}else{if(((c=="right")||(c=="bottom"))&&(b>0)){return b}}return Math.abs(b)*-1},pageMenuClick:function(){$("input","#pageMenus").blur();return false},renderBlurs:function(a){a=a||((a=document.querySelector(".canvasObject.active"))&&a.id);if(!a){return}page.calculateWdgPositions(a);storage.get(a).widgets.forEach(function(b){var c=document.getElementById(b);if(!c){return}if(storage.get(b).blur){widget.blurLayers[b]=widget.renderBlurLayer(b,a);widget.setBlurBG(c)}})}};var grid={toggle:function(){var a=account.get("gridStatus");(a=="on")?grid.hideGridSettingsMenu():grid.showGridSettingsMenu();return false},hideGridSettingsMenu:function(){$("#gridSwitchOn, #gridControls, #gridControlHeading, #gridSliderArea, #gridSpaceSlider, #gridSpacingInput").hide();$("#gridSwitchOff").show();grid.hideGrid();snap.disableGridSnap();account.set({gridStatus:"off"})},gridSliderText:false,gridSliderLimit:false,showGridSettingsMenu:function(){$("#gridSwitchOff, #gridControls").hide();$("#gridSwitchOn").show();$("#gridControls, #gridControlHeading, #gridSliderArea, #gridSpaceSlider, #gridSpacingInput").show();account.set({gridStatus:"on"});var b=$("#gridSpaceSlider");grid.gridSliderText=$("#gridSpacingInput");var a=parseInt(b.css("width"));var c=parseInt($("#gridSliderArea").css("width"));grid.gridSliderLimit=c-a;grid.getGridSpacing();snap.setSnapToGrid();grid.showGrid()},selectInputText:function(){$(this).select()},changeGridSpacing:function(d,c){var f=c.position.left;var a=Math.abs((100-4)/(grid.gridSliderLimit));var b=parseInt((a*f)+4);grid.gridSliderText.text(b+" px");account.set({gridSpacing:b});snap.checkSnapStatus();snap.setSnapToGrid();grid.drawGrid()},getGridSpacing:function(){var c=account.get("gridSpacing");var a=(100-4)/(grid.gridSliderLimit);var b=Math.abs((c-4)/a);snap.setSnapToGrid();grid.updateSliderPos(b,c)},sliderPosClick:function(h){if(h.target.id=="gridSpacingInput"){return}var a=parseInt($("#gridSliderArea").offset().left);var k=parseInt(h.pageX);var f=parseInt($("#gridSliderArea").css("width"));var d=parseInt($("#gridSpaceSlider").css("width"));var b=(f-d)/f;var c=Math.abs((k-a)*b);var i=Math.abs((100-4)/(f*b));var j=parseInt((c*i)+4);grid.updateSliderPos(c,j);account.set({gridSpacing:j});snap.setSnapToGrid();snap.checkSnapStatus();grid.drawGrid()},updateSliderPos:function(b,a){$("#gridSpaceSlider").css("left",b);grid.gridSliderText.text(a+"px")},pageDims:false,currentPageID:false,currentPageGridHolder:false,getPageProps:function(){var e=project.getActivePageId();var b=$("#"+e).find(".page").find(".widgetHolder");grid.currentPageID=e;grid.currentPageGridHolder=b;var c=page.get(e,"width");var a=page.get(e,"height");var d={width:c,height:a};grid.pageDims=d;return b},showGrid:function(b,a){if(project.readOnly()){return false}$("#gridSquares").remove();var d=grid.getPageProps();var c=d.find(".backgroundWidget").attr("id");if(c){$("#tmplGrid").tmpl(grid.pageDims).appendTo("#"+c)}else{$("#tmplGrid").tmpl(grid.pageDims).prependTo(d)}grid.drawGrid()},drawGrid:function(){function a(){f.beginPath();f.strokeStyle="rgb(127,185,240)";for(var c=(e*5);c<grid.pageDims.height;c+=(e*5)){f.moveTo(0,c+0.5);f.lineTo(grid.pageDims.width,c+0.5)}for(var c=(e*5);c<grid.pageDims.width;c+=(e*5)){f.moveTo(c+0.5,0);f.lineTo(c+0.5,grid.pageDims.height)}f.stroke()}if(account.get("gridStatus")!="on"){return}var e=account.get("gridSpacing");var b=$("#gridSquares");if(b.size()==0){return}var f=(b[0]).getContext("2d");f.clearRect(0,0,grid.pageDims.width,grid.pageDims.height);if(e<4){f.clearRect(0,0,grid.pageDims.width,grid.pageDims.height);return}f.beginPath();f.strokeStyle="rgb(176,217,255)";for(var d=e;d<grid.pageDims.height;d+=e){f.moveTo(0,d+0.5);f.lineTo(grid.pageDims.width,d+0.5)}for(var d=e;d<grid.pageDims.width;d+=e){f.moveTo(d+0.5,0);f.lineTo(d+0.5,grid.pageDims.height)}f.stroke();a(e)},hideGrid:function(){$("#gridSquares").remove()},selectBackground:function(){var a=project.get("currentZoom");if(a==1){var b=account.get("gridStatus");if(b=="on"){grid.showGrid()}else{return}}},zoomIn:function(){if(project.readOnly()){return}var a=account.get("gridStatus");if(a=="on"){grid.showGridSettingsMenu()}else{if(a=="off"){grid.hideGridSettingsMenu()}}snap.checkSnapStatus()}};var snap={closeSnapSettings:function(){var a=$("#snapSettingsPanel");if(a.hasClass("openPanel")){page.showDefaultSnapOptions()}},toggle:function(b){var a=account.get("snapToWidget");(a=="on")?snap.disableWidgSnap():snap.setSnapToWidgEdges()},checkSnapStatus:function(){var b=account.get("gridStatus");var a=account.get("snapToWidget");if(a=="off"||b=="off"){return false}if(a=="on"){snap.setSnapToWidgEdges()}if(b=="on"){snap.setSnapToGrid()}},setSnapToGrid:function(){var a=account.get("gridSpacing");if(a<4){$("#canvasPages .pageWidget").draggable("option","grid",false)}else{$("#canvasPages .pageWidget").draggable("option","grid",[a,a])}return false},topDiff:0,leftDiff:0,topConstant:0,leftConstant:0,groupConstantTop:0,groupConstantLeft:0,setMovementConstant:function(e,h,j){snap.topConstant=0;snap.leftConstant=0;snap.groupConstantTop=0;snap.groupConstantLeft=0;if(e.length>1){e=e.eq(1);var a=true}else{var a=false}if(widget._activeGroup){var b=$("#"+widget._activeGroup);snap.groupConstantTop=parseInt(b.css("top"));snap.groupConstantLeft=parseInt(b.css("left"))}if(e.hasClass("rootWidget")){snap.topDiff=0;snap.leftDiff=0}else{var f=account.get("gridSpacing");var k=e.attr("data-lockto");var i=e.siblings(".rootWidget").filter('[data-lockto="'+k+'"]').offset();var c=e.offset();snap.topDiff=(c.top-i.top)%f;snap.leftDiff=(c.left-i.left)%f}if(j=="on"&&a==true){var f=account.get("gridSpacing");$("#canvasPages .pageWidget").draggable("option","grid",[f,f]);var m=widget._selectionBoxCoord;var d=m.left;var l=m.top;snap.topConstant=l;snap.leftConstant=d}},widgetSnapToGrid:function(d,c,b){var a=account.get("gridSpacing");if(widget._activeGroup){d.data().draggable.position.top=c-((c+snap.groupConstantTop)%a);d.data().draggable.position.left=b-((b+snap.groupConstantLeft)%a);return}if(widget._moveMultiSelection==true){d.data().draggable.position.top=c-(snap.topConstant%a);d.data().draggable.position.left=b-(snap.leftConstant%a)}else{d.data().draggable.position.top=c+snap.topDiff-(c%a);d.data().draggable.position.left=b+snap.leftDiff-(b%a)}},snapResize:function(c){if(c=="on"){var b=account.get("gridSpacing");var a=[b,b]}else{if(c=="off"){var a=false}}return a},snapResizeDragStart:function(i,f){var h=account.get("gridSpacing");var b=i.originalPosition;var c=i.originalSize;var a=h-((b.top+c.height)%h);var e=h-((b.left+c.width)%h);var j=b.top%h;var d=b.left%h;if(widget._resizeAxis=="se"||widget._resizeAxis=="sw"){$(f).data().resizable.originalSize.height+=a;$(f).data().resizable.originalSize.width+=e}else{if(widget._resizeAxis=="ne"||widget._resizeAxis=="nw"){$(f).data().resizable.originalSize.width+=d;$(f).data().resizable.originalSize.height+=j}else{if(widget._resizeAxis=="w"){$(f).data().resizable.originalPosition.left-=d;$(f).data().resizable.originalSize.width+=d}else{if(widget._resizeAxis=="e"){$(f).data().resizable.originalSize.width+=e}else{if(widget._resizeAxis=="n"){$(f).data().resizable.originalPosition.top-=j;$(f).data().resizable.originalSize.height+=j}else{if(widget._resizeAxis=="s"){$(f).data().resizable.originalSize.height+=a}}}}}}},libraryGridSnapOn:function(a,c){if(a){return}if(c){return}else{var b=account.get("gridSpacing");$(".libraryWidget").draggable("option","snap",false);$(".libraryWidget").draggable("option","grid",[b,b])}},libraryGridSnapOff:function(a){if(a){return}else{$(".libraryWidget").draggable("option","grid",false);$(".libraryWidget").draggable("option","snap","#canvasPages .widgetHolder, #canvasPages  .pageWidget")}},setSnapToWidgEdges:function(){account.set({snapToWidget:"on"});$("#snapSwitchOn, #snapSwitchOff").hide();$("#snapSwitchOn").show()},disableWidgSnap:function(){account.set({snapToWidget:"off"});$("#snapSwitchOn, #snapSwitchOff").hide();$("#snapSwitchOff").show()},multiSelDLeft:false,multiSelDTop:false,multiSelOffset:function(a){if(widget._moveMultiSelection==true){var b=$("#multiSelBox").offset();if(!b){b={left:0,top:0}}snap.multiSelDLeft=a.left-b.left;snap.multiSelDTop=a.top-b.top}else{snap.multiSelDLeft=0;snap.multiSelDTop=0}},snapToWidgEdges:function(j,k,b){function e(s,r){j.data().draggable.position.left=(r)?r+snap.multiSelDLeft+snap.leftDiff:s+snap.multiSelDLeft+snap.leftDiff;$("#tmplVsnapHelper").tmpl({left:s}).appendTo("#"+grid.currentPageID);setTimeout(function(){return},m)}function f(r,s){j.data().draggable.position.top=(s)?s+snap.multiSelDTop+snap.topDiff:r+snap.multiSelDTop+snap.topDiff;$("#tmplHsnapHelper").tmpl({top:r}).appendTo("#"+grid.currentPageID);setTimeout(function(){return},m)}function c(s,r){j.data().draggable.position.top=r+snap.topDiff+snap.multiSelDTop;$("#tmplMidHsnapHelper").tmpl({top:s}).appendTo("#"+grid.currentPageID);setTimeout(function(){return},m)}function n(s,r){j.data().draggable.position.left=r+snap.multiSelDLeft+snap.leftDiff;$("#tmplMidVsnapHelper").tmpl({left:s}).appendTo("#"+grid.currentPageID);setTimeout(function(){return},m)}snap.removeAlignGuides();var o=b+snap.widgWidth;var a=k+snap.widgHeight;var h=grid.pageDims.width+80;var d=grid.pageDims.height+80;var q=-80;var p=-80;if(((a>p)&&(k<d))&&((o>q)&&(b<h))){var m=1500;var l=account.get("gridStatus");var i=(l=="on")?3:6;var b=b-snap.multiSelDLeft-snap.leftDiff;var k=k-snap.multiSelDTop-snap.topDiff;$.each(snap.leftSnapArr,function(v){var t=snap.leftSnapArr[v];var r=t-i;var w=t+i;var u=b+snap.widgWidth;if(b>r&&b<w){e(t)}else{if(u>r&&u<w){var s=t-snap.widgWidth;e(t,s)}}});$.each(snap.topSnapArr,function(u){var s=snap.topSnapArr[u];var t=s-i;var w=s+i;var r=k+snap.widgHeight;if(k>t&&k<w){f(s)}else{if(r>t&&r<w){var v=s-snap.widgHeight;f(s,v)}}});$.each(snap.midTopSnapArr,function(t){var u=snap.midTopSnapArr[t];var v=u-i-snap.widgMidPointHeight;var r=u+i-snap.widgMidPointHeight;var s=u-snap.widgMidPointHeight;if(k>v&&k<r){c(u,s)}});$.each(snap.midLeftSnapArr,function(r){var v=snap.midLeftSnapArr[r];var u=v-i-snap.widgMidPointWidth;var s=v+i-snap.widgMidPointWidth;var t=v-snap.widgMidPointWidth;if(b>u&&b<s){n(v,t)}})}},originalResizePosRight:false,originalResizePosBottom:false,setResizeEdgeBounds:function(a){snap.originalResizePosRight=a.originalSize.width+a.originalPosition.left;snap.originalResizePosBottom=a.originalSize.height+a.originalPosition.top},resizeToWidgEdges:function(f,m){function l(n,q){var r=(n)?n:q;d.data().resizable.size.width=r-f.originalPosition.left;d.data().resizable.position.left=f.originalPosition.left;if(n){$("#tmplVsnapHelper").tmpl({left:r}).appendTo("#"+grid.currentPageID)}else{$("#tmplMidVsnapHelper").tmpl({left:r}).appendTo("#"+grid.currentPageID)}setTimeout(function(){return},h)}function p(n,q){var r=(n)?n:q;d.data().resizable.position.left=r;d.data().resizable.size.width=snap.originalResizePosRight-r;if(n){$("#tmplVsnapHelper").tmpl({left:r}).appendTo("#"+grid.currentPageID)}else{$("#tmplMidVsnapHelper").tmpl({left:r}).appendTo("#"+grid.currentPageID)}setTimeout(function(){return},h)}function b(r,q){var n=(r)?r:q;d.data().resizable.position.top=n;d.data().resizable.size.height=snap.originalResizePosBottom-n;if(r){$("#tmplHsnapHelper").tmpl({top:n}).appendTo("#"+grid.currentPageID)}else{$("#tmplMidHsnapHelper").tmpl({top:n}).appendTo("#"+grid.currentPageID)}setTimeout(function(){return},h)}function j(r,q){var n=(r)?r:q;d.data().resizable.position.top=f.originalPosition.top;d.data().resizable.size.height=n-f.originalPosition.top;if(r){$("#tmplHsnapHelper").tmpl({top:n}).appendTo("#"+grid.currentPageID)}else{$("#tmplMidHsnapHelper").tmpl({top:n}).appendTo("#"+grid.currentPageID)}setTimeout(function(){return},h)}var k=f.position.left;var e=f.size.width+f.originalPosition.left;var a=f.position.top;var o=f.size.height+f.originalPosition.top;resizeDirX=(f.position.left!=f.originalPosition.left)?"left":"right";resizeDirY=(f.position.top!=f.originalPosition.top)?"up":"down";var i=account.get("gridStatus");var c=(i=="on")?3:8;var h=1500;snap.removeAlignGuides();var d=$(m);if(f.originalSize.width>4){$.each(snap.leftSnapArr,function(s){var n=snap.leftSnapArr[s];var r=n-c;var q=n+c;if(resizeDirX=="right"){if(e>r&&e<q){l(n)}}else{if(resizeDirX=="left"){if(k>r&&k<q){p(n)}}}})}if(f.originalSize.height>4){$.each(snap.topSnapArr,function(q){var s=snap.topSnapArr[q];var n=s-c;var r=s+c;if(resizeDirY=="up"){if(a>n&&a<r){b(s)}}else{if(resizeDirY=="down"){if(o>n&&o<r){j(s)}}}})}if(f.originalSize.height>4){$.each(snap.midTopSnapArr,function(q){var s=snap.midTopSnapArr[q];var n=s-c;var r=s+c;if(resizeDirY=="up"){if(a>n&&a<r){b(false,s)}}else{if(resizeDirY=="down"){if(o>n&&o<r){j(false,s)}}}})}if(f.originalSize.width>4){$.each(snap.midLeftSnapArr,function(r){var q=snap.midLeftSnapArr[r];var s=q-c;var n=q+c;if(resizeDirX=="right"){if(e>s&&e<n){l(false,q)}}else{if(resizeDirX=="left"){if(k>s&&k<n){p(false,q)}}}})}},removeAlignGuides:function(){$("#canvasPages .hGuide, #canvasPages .vGuide, #canvasPages .midHGuide, #canvasPages .midVGuide").remove()},widgWidth:false,widgHeight:false,widgMidPointWidth:false,widgMidPointHeight:false,selectedWidgSnapPos:function(){snap.widgWidth=widget._selectionTLWH.width;snap.widgHeight=widget._selectionTLWH.height;snap.widgMidPointWidth=snap.widgWidth/2;snap.widgMidPointHeight=snap.widgHeight/2},leftSnapArr:false,topSnapArr:false,midLeftSnapArr:false,midTopSnapArr:false,initSnapPositions:function(){function d(){snap.leftSnapArr=false;snap.topSnapArr=false;snap.midLeftSnapArr=false;snap.midTopSnapArr=false}var c=account.get("snapToWidget");if(c=="on"){var h=grid.getPageProps();var b=$("#canvasPages .ui-selected");var a=$([]);var f=[];b.each(function(){var k=$(this);if(k.hasClass("rootWidget")){var l=k.attr("id");a=a.add($('[data-lockto="'+l+'"]')).not(".rootWidget")}else{var j=widget.getRoots(k);var i=$(j).attr("id");f.push(i)}});if($(h).find(b).length==0){d();return}var e=$(h).children().not(b).not(".backgroundWidget").not(a).filter(".rootWidget");snap.leftSnapArr=new Array();snap.topSnapArr=new Array();snap.midLeftSnapArr=new Array();snap.midTopSnapArr=new Array();e.each(function(){var q=$(this);var n=parseInt(q.css("top"));var l=parseInt(q.css("left"));var j=parseInt(q.css("width"));var p=parseInt(q.css("height"));var i=n+p;var o=l+j;var m=f.indexOf(q.attr("id"));if(m<0){var r=parseInt(n+(p/2));var k=parseInt(l+(j/2))}snap.leftSnapArr.push(l,o);snap.topSnapArr.push(n,i);snap.midLeftSnapArr.push(k);snap.midTopSnapArr.push(r)})}},disableGridSnap:function(){$("#canvasPages .pageWidget").draggable("option","grid",false)}};var widget={editing:false,selectMulti:false,widgetOffset:null,locked:null,currSelection:null,useCanvas:false,get:function(b){var a;if(typeof widgets!=="undefined"){a=widgets.summary&&widgets.summary[b]&&$.extend(true,{id:b},widgets.summary[b])}if(a==undefined){a=storage.get(b)}return a||false},set:function(b,d){var a=storage.get(d);if(!a){return false}for(var c in b){a[c]=b[c]}storage.set(d,a)},containsText:function(e){for(var c=0;c<e.length;c++){var a=e.eq(c).attr("id");var b=widget.get(a);if(b.tc){return true}else{var d=widget.getDependents(a);if(d.length>0){return widget.containsText(d)}}}return false},getSubTextElements:function(d){var c=[];var a=d.id,e=widget.getDependents(a),b=widget.get(a);fluid.util._.forEach(e,function(f){c=c.concat(widget.getSubTextElements(f))});if(b.tc){c.push(d)}return c},getRoots:function(b){if(typeof b==="string"){b=document.querySelectorAll(b)}var a=[];fluid.util._.forEach(b,function(h){if(h.classList.contains("rootWidget")){a.push(h)}else{var d=h.dataset.lockto,f=h.parentNode.children;for(var e=0,c=f.length;e<c;e++){if(f[e]!==h&&$(f[e]).is(".rootWidget[data-lockto="+d+"]")){a.push(f[e])}}}});return $(fluid.util._.uniq($(a)))},getLockTos:function(c){var a=widget.getRoots(c);var b=Array.prototype.reduce.call(a,function(e,d){fluid.util._.forEach(document.querySelectorAll('[data-lockto="'+d.id+'"]'),function(f){if(e.indexOf(f)===-1){e.push(f)}});return e},[]);return $(b)},getSelectedOnly:function(c){function a(d){c.each(function(){if($(this).attr("data-segment")==$(this).attr("id")){if($(this).attr("data-lockto")==d){b=b.add($(this))}else{return}}})}var b=$([]);c.each(function(){if($(this).hasClass("ui-selected")){var d=widget.get($(this).attr("id"));if(d.sc&&!d.bg){var e=$(this).attr("id");a(e)}else{b=b.add($(this))}}});return b},getDependentsCache:[],getDependents:function(a,d,c){if(c&&widget.getDependentsCache[a]){return widget.getDependentsCache[a]}if(!c){widget.getDependentsCache=[]}var d=d||widget.getLockTos($("#"+a));var b=fluid.util._.reduce(d,function(f,e){var h=widget.get(e.id);if(h.of==a){f.push(e)}return f},[]);$all=$(b);widget.getDependentsCache[a]=$all;return $all},getPageOf:function(e){var c=project.get("pages");var d;for(var b=0;b<c.length;b++){d=page.get(c[b],"widgets");for(var a=0;a<d.length;a++){if(e==d[a]){return c[b]}}}},saveTempFile:function(b,a){storage.setTempItem(b+"_file",a)},getTempFile:function(a){return storage.get(a+"_file")},removeTempFile:function(a){storage.remove(a+"_file")},verticalAlign:function(c){var f=c.find(".widgetText");if(f.length==0){return}var k=parseInt(c.css("height"));var j=f.css("font-size");var a=f.css("font-family");f.contents().wrapAll("<span></span>");var e=f.find("span").eq(0);e.css("font-size",j);e.css("font-family",a);var d=parseFloat(e.css("height"));e.contents().eq(0).unwrap();var i=(parseFloat(f.css("top"))/k)*100;var b=(k-d)*i;b=(b<=0)?0:b;f.css("padding-top",b+"px");updateTLWH();var h=widget.get(c.attr("id"));h.ts=f.attr("style");widget.set(h,h.id)},autoWidth:function(c,d){var a=[c.tlwh[2],c.tlwh[3]];var b=d!="library"?project.getActivePage().find(".widgetHolder").width():320;if(b==null&&a[0]=="a"){a[0]=320}else{if(a[0]=="a"){a[0]=b}}return a},addUploads:function(){var a=account.get("uploads");for(var b in a){var c=storage.get(a[b].id);widgets.summary[a[b].id]=c}},_redraw:function(f,d,c){if(d.segment){var e=widget.get(d.lockTo);var a=widget._setupSegments(e);widget._updateSegments(e,a,c)}var b=$(".screen.active").attr("id");var h=widget._setTMPLVars(f.attr("id"),d,[0,0,parseInt(page.get(b,"width")),parseInt(page.get(b,"height"))]);widget._drawCanvasOrImage(f,h)},hasOwnColorProperties:function(a){if(typeof a=="string"){a=widget.get(a)}return !a.srps&&Boolean(a.bg||a.bgc||a.b)},serialize:function(d){function c(e){widget.getDependents(e).each(function(){var f=$(this).attr("id");a[f]=storage.get(f);c(f)})}var b=storage.get(d);if(!b){return}var a={id:d,};a[d]=b;a[d].insertAfterId=$("#"+d).prev().attr("id");if($("#"+d).prev().length==0){a[d].insertAfterId="first"}c(d);return JSON.stringify(a)},deserialize:function(f,j,b,c){var m=JSON.parse(f);if(m){var d=m.id;var h=m[d];var l=$("#"+j);var a=l.find(".widgetHolder");var i=[0,0,a.outerWidth(),a.outerHeight()];var k=h.insertAfterId;widget._save(d,h,l);widget._draw(d,a,i,false,false,k);var e=b&&storage.get(b);if(e&&e.seg&&"segment" in h&&h.segment==d){widget._insertSegmentObj(e,d,h,c)}k=d;delete m.id;delete m[d];for(d in m){h=m[d];if(h){widget._save(d,h,l);widget._draw(d,a,i,false,false,k);k=d}}}},checkIntegrity:function(d,b){var c=widget.get(d);if(!c){return true}if(c.name){var a={"blackSearch":"widget201010120","tablerowsliderlongblank":"widget201010120","pROGRESSBAR":"widget893","iconStatusBarDark":"widget730","iconStatusBarLight":"widget729","iconStatusBarTrans":"widget731","webLoading":"widget615","webUrlEntry":"widget613","webShortcuts":" widget614","barmapbottomwithtext":"widget910","iPHONEMENUSDARK1":"widget917","rOWCONTENTX1SELECTED":"widget926","spinner":"widget308","dIALINGPAD":"widget908","mEDIAPLAYER":"widget3071","buttonbackandnext":"widget919","switchonwithtext":"widget309","iconLibrary":"widget137","iconAdd":"widget127","iconNext":"widget133","iconRemove":"widget135","sortAlpha":"widget788","iconsorthandles":"widget789","iconAttach":"widget128","iconBack":"widget129","iconForward":"widget130","iconForward1":"widget1301293847","iconInfo":"widget131","'iconTick":"widget136","iconTick1":"widget1342343236","iconWorking":"widget132"};if(a[c.name]){widget.replace(d,a[c.name])}}if(!c.tlwh){widget.fixTLWH(d,c,b)}return true},load:function(b,c,h){var l=$("#"+b).find(".widgetHolder");var a=[0,0,l.outerWidth(),l.outerHeight()];if(h==true){var f=$("#"+b).find(".fixedWidgetHolderFront");var e=l}for(var d=0;d<c.length;d++){if(h==true){var k=widget.get(c[d]);l=e;var i=false;if(k.st=="f"){i=staticWidgets.findPositionOnScreen($([]),c[d],h);if(i==true){l=f}}}widget._draw(c[d],l,a,false,false,c[d].insertAfterId)}}};widget.hover=function(d){if(project.readOnly()){return false}if(project.get("currentZoom")!=1){return true}var a=link.from($(this).attr("id"));var c=(d.type=="mouseover")?"active":"ahref";if(a){var b=link.goesTo(a);link.draw($("#"+a),$(this).attr("id"),b,c)}};widget.click=function(h){if(!$("#canvas").data("zooming")){if($(".pageWidget textarea").length>0){return true}if(project.get("currentZoom")!=1){return true}$this=$(this);var c=$(".pageWidget textarea");if(c.length>0&&c.closest(".pageWidget").attr("id")!=$this.attr("id")){widget._stopEditingText()}var b=$this.closest(".screen");var a=project.getActivePageId();if(a!=b.attr("id")){var f=300;var d=zoomInAndCenterOnPage(b,1,1,f);page.activate(b,false);setTimeout(function(){widget.select(h,$this)},f)}else{widget.select(h,$this)}page.hideOptionsMenu();if($("#fluidDropdown").is(":visible")){contextMenu.place();fluidMenu.hide()}}return false};widget.addDefault=function(f){var d=$("#canvasPages .active");var c=$(this);var b;var i=c.attr("id")||c.attr("data-id");if(d.length==1){var h={top:0,left:0};if(widgets.summary[i].dp){h.top=widgets.summary[i].dp[0];h.left=widgets.summary[i].dp[1]}var a=d.find(".widgetHolder");b=widget.add(f,{top:a.offset().top+h.top-5,left:a.offset().left+h.left-5},i,a);tracker.record("addWidget",1,i,f)}return b};widget._setupSegments=function(h,d,l,n){var i=[];var h=$.extend(true,{},h);h.sc=h.sc||1;h.sl=h.sl||"h";h.sa=h.sa||"tl";h.sp=h.sp||[0,0,0,0];var c=widget._enumSegments(h,l);if(!h.segments){for(var o=0,j=c.segments.length;o<j;o++){var f=c.segments[o];widget._setSegmentBorder(h,c.segments,o);widget.set({b:f.wObj.b},f.id)}}else{if(!n){var o=typeof l!="undefined"?l:c.segments.length-1;var f=c.segments[o];widget._setSegmentBorder(h,c.segments,o);widget.set({b:f.wObj.b},f.id)}}var m=h.tlwh||h.wh;var e=(h.sl=="h"?2:3)-(h.tlwh?0:2);if(typeof m[e]=="string"){if(!d){var b=h.of?$("#"+h.of):$("#canvasPages .active .widgetHolder");d=[0,0,b.width(),b.height()]}var a=h.sl=="h"?d[2]:d[3];if(m[e]=="a"&&c.autoSizeSegments.length>0){m[e]=a}else{var k=utils.fromPercentString(m[e],a);if(!isNaN(k)){m[e]=k}}}c.rootTlwh=m;widget._setSegmentTLWH(h,c);return c};widget._enumSegments=function(j,l){function e(E,B,A){if(!B){return}var D={wId:E,wObj:B};if(!A||l===undefined){w.push(D)}else{w.splice(l,0,D);l++}var C=B.tlwh?B.tlwh[c]:B.wh[c-2];if(B.autoSize||typeof C==="string"){B.autoSize=true;r.push(D)}else{n+=C}}var w=[];var r=[];var n=0;var c=j.sl=="h"?2:3;if(j.segments&&j.segments.length>0){if(j.segments.length>0&&j.segments[0].hasOwnProperty("id")){var b=0;var a={};for(var o=0,z=j.segments.length;o<z;o++){var p=widget.get(j.segments[o].id);if(p){var u=j.segments[o].widget;e(u,p);b++;if(a[u]){a[u]++}else{a[u]=1}}}for(var f=b;f<j.sc;f++){var q=Number.MAX_VALUE;var s;for(var t=0;t<j.seg.length;t++){var v=j.seg[t];var k=a[v]||0;if(k<q){q=k;s=v}}var d=widget.get(s);e(s,d,true)}}else{for(var o=0,z=j.segments.length;o<z;o++){var v=j.segments[o].originalID;var d=widget.get(v);if(!d){d=widget.get(j.segments[o].widget)}else{d.id=j.segments[o].widget}e(j.segments[o].widget,d)}}}else{var m=j.seg.length;for(var t=0,i=0;t<j.sc;t++,i=t%m){var v=j.seg[i];var h=widget.get(v);e(v,h)}}return{segments:w,autoSizeSegments:r,totalSize:n}};widget._setSegmentTLWH=function(k,a){var e=k.tlwh||[0,0,k.wh[0],k.wh[1]];var l=k.sl=="h"?1:0;var i=k.sl=="h"?2:3;var j=[k.sp[1]||0,k.sp[0]||0];var c=k.sp[2+l]||0;var d=e[i]-j[l]-c-a.totalSize;if(a.autoSizeSegments.length>0){var n=Math.floor(d/a.autoSizeSegments.length);var m=d-(n*a.autoSizeSegments.length);for(var o=0;o<a.autoSizeSegments.length;o++,m--){var h=a.autoSizeSegments[o].wObj;var q=n+Number(m>0);a.totalSize+=q;if(h.tlwh){h.tlwh[i]=q}else{h.wh[i-2]=q}}}if(e[i]=="a"||a.autoSize){a.autoSize=true;e[i]=a.totalSize+j[l]+c}var f=0;var b=0;if(!a.autoSize){switch(k.sa){case"br":j[l]=e[i]-c-a.totalSize;break;case"c":j[l]+=d>>1;break;case"d":f=Math.floor(d/(k.sc+1));b=d-(f*(k.sc+1));break}}for(var o=0;o<a.segments.length;o++,b--){j[l]+=f+Number(b>0);a.segments[o].pos=[j[0],j[1]];var h=a.segments[o].wObj;var p=h.tlwh||[0,0,h.wh[0],h.wh[1]];j[l]+=p[i]}if(a.autoSize){a.rootTlwh=e;if(k.tlwh){k.tlwh[i]=e[i]}else{k.wh[i-2]=e[i]}}};widget._updateSegments=function(m,h,o){var v=h.segments;var j=$("#"+m.lockTo);for(var r=0;r<v.length;r++){var b=widget._setSegmentBorder(m,v,r);var B=v[r];var w=m.segments[r].id;if(w&&(w.substr(0,2)=="w_"||(w.substr(0,1)=="w"&&w.length==33))){var p=j.position();var t=widget.get(w);var c=$("#"+w);var n=c.position();var z=B.pos[1]+p.left-n.left;var q=B.pos[0]+p.top-n.top;var l=z!=0||q!=0;var f={tlwh:$.merge([],t.tlwh)};var k=typeof f.tlwh[2]=="string"||typeof f.tlwh[3]=="string";var D=false;var A=[0,0,j.width(),j.height()];var u=widget._setTMPLVars(w,B.wObj,A);var e=$("canvas, img",c);o=o||{};var a=o.redraw=="all"||(o.redraw=="seg"&&o.segId==w);if(l){c.css({left:n.left+z+"px",top:n.top+q+"px"});f.tlwh[0]=B.pos[0];f.tlwh[1]=B.pos[1]}if(k){D=u.absTLWH[2]!=e.width()||u.absTLWH[3]!=e.height()}else{var C=[e.width(),e.height()];D=C[0]!=f.tlwh[2]||C[1]!=f.tlwh[3]}if(D||a){function s(G,H,F){H.add(G).add($("textarea, .widgetText",H)).css({width:F[2]+"px",height:F[3]+"px"});G.attr({width:F[2],height:F[3]})}if(o.redraw=="img"&&e.get(0).tagName=="CANVAS"){if(!e.data("replacing")){e.data("replacing",true);var E=new Image();E.src=e.get(0).toDataURL("image/png");E.onload=(function(H,G,I,F){return function(){if(H.data("cancelReplace")){H.data({"replacing":false,"cancelReplace":false})}else{$(G).data("origCanvas",H);H.data("replacing",false).replaceWith(G);var J=widget._setTMPLVars(I,F.wObj,[0,0,j.width(),j.height()]);s($(G),$("#"+I),J.absTLWH)}}})(e,E,w,B)}}else{s(e,c,u.absTLWH)}}if(b){f.b=$.merge([],B.wObj.b)}if(o.redraw!="none"&&o.redraw!="img"&&(b||D||a)){if(e.data("replacing")){e.data("cancelReplace",true)}else{var d=e.data("origCanvas");if(d){e.replaceWith(d).data("origCanvas",null);d.attr({width:u.absTLWH[2],height:u.absTLWH[3]}).css({width:u.absTLWH[2]+"px",height:u.absTLWH[3]+"px"})}}widget._drawCanvasOrImage(c,u)}widget.set(f,w);var i=$('#canvasPages [data-segment="'+w+'"]').not(c);widget._updateDependents(w,A,i)}}widget.set({tlwh:m.tlwh,sc:v.length,segments:m.segments},m.lockTo);widget._updateSegmentRoot(m.lockTo,m,h)};widget._updateSegmentRoot=function(j,i,b){var f=i.tlwh||[0,0,i.wh[0],i.wh[1]];var e=widget._getSegmentRootTLWH(j,i,b);if(!utils.arraysEqual(i.tlwh,e)||utils.isPercentString(e[2])||utils.isPercentString(e[3])){var a=$("#canvasPages .active .widgetHolder");var h=[0,0,a.width(),a.height()];var d=widget._setTMPLVars(j,i,h);d.tlwh=$.merge([],e);var c=$("#"+j);c.css({width:e[2]+"px",height:e[3]+"px"});widget._drawCanvasOrImage(c,d)}};widget._getSegmentRootTLWH=function(i,e,a){var b;if(a&&a.rootTlwh){b=a.rootTlwh}else{var h=!e.sl||e.sl=="h";var d=h?2:3;b=$.merge([],e.tlwh);if(b[d]=="a"){a=widget._enumSegments(e);var c=e.sp?e.sp[h?0:1]:0;var f=e.sp?e.sp[h?3:2]:0;b[d]=a.totalSize+c+f}}return b};widget._setSegmentBorder=function(h,e,b){if(!e){e=h.segments||[]}if(e&&e.length>0){var a=e.length-1;var f=h.sl||"h";var i="bs";if(a>0){switch(b){case 0:i=f=="h"?"bls":"bts";break;case a:i=f=="h"?"brs":"bbs";break;default:i="bms";break}}}var c=e[b].wObj;if(!c.hasOwnProperty("bs")){c.bs=c.b}var d=c.b;c.b=$.merge([],c[i]||c.b||[]);return !utils.arraysEqual(c.b,d||[])};widget._isMultiSegment=function(d){if(d==""){return false}var a=$("#"+d).attr("data-lockto");var c=storage.get(a);var b=c&&c.seg;if(b&&b.length>0){return true}return false};widget._addSegment=function(){var a=[];$(".ui-selected").addClass("rememberSelected").each(function(){var o=$(this).attr("id");var q=$(this).attr("data-segment");var p=Boolean(q);if(p&&$(this).attr("data-segment")!=o){o=$(this).attr("data-segment")}var j=widget.getRoots($(this));var k=j.attr("id");var f=widget.get(k);var e;if(p){e=0;for(var h=f.segments.length;e<h;e++){if(f.segments[e].id==o){e++;break}}}if(f&&f.seg){var n=$("#canvasPages .active");var i=storage.get(n.attr("id"));var c=f.of?$("#"+f.of):n.find(".widgetHolder");var m=[0,0,c.width(),c.height()];f.sc++;var b=widget._setupSegments(f,m,e);if(typeof e=="undefined"){e=b.segments.length-1}var l=b.segments[e];var d=widget._createSaveAndDraw(l.wObj,f["lockTo"],n,l.pos,c,m,j.attr("id"),true);f.segments.splice(e,0,{id:d,widget:l.wId});widget._updateSegments(f,b);a.push(d)}return false});widget.resetSelection();widget.select("dontMovePosition",$(".rememberSelected"));$(".rememberSelected").removeClass("rememberSelected");return a};widget._insertSegmentObj=function(b,d,a,c){b.segments.splice(c,0,{id:d,widget:a.wId});b.sc++;widget._updateSegments(b,widget._setupSegments(b))};widget._getLastSegment=function(b){var c=storage.get(b);var a=c&&c.segments;if(a&&a.length>0){return a[a.length-1].id}return false};widget.getSegmentsFromSelection=function(a){var b=$([]);$(a).each(function(){var d=$(this);var c=d.attr("data-segment");if(!c&&d.hasClass("rootWidget")){var c=widget._getLastSegment(d.attr("id"))}b=b.add($("#"+c))});return b};widget._deleteSegment=function(c,f){function b(){var k=$(this);var n=k.attr("data-segment");var h=k.attr("data-lockTo");if(!n){return}var i=storage.get(h);if(!i){return}var m=$.extend(true,{},storage.get(h));var j=0;for(;j<m.segments.length;j++){if(m.segments[j].id==n){break}}widget.remove(n);m.segments.splice(j,1);m.sc--;storage.set(h,m);if(m.segments.length==0){widget.del($("#"+h));contextMenu.hide();propInspector.resetPropInspector();return}var e=widget._setupSegments(m,null,j,true);widget._updateSegments(m,e);if($("#"+h).hasClass("ui-selected")){a+="#"+h+","}else{var l=(j>0)?j-1:0;a+="#"+m.segments[l].id+","}}var a="";var d=f?$("#"+f):widget.getSegmentsFromSelection(".ui-selected");d.each(b);widget.resetSelection();widget.select("dontMovePosition",a);return false};widget._getSegmentPosition=function(b){var d=$(b).attr("id");var c=storage.get($(b).attr("data-lockto"));var e=0;for(var a=c.segments.length;e<a;e++){if(c.segments[e].id==d){break}}return e};widget._drawFromRoot=function(o,n,c,j,m){j=j||widget.get(o);var d=widget._draw(o,n,c,j,m);if(j.seg&&j.sc){var b=widget._setupSegments(j,c);for(var e=0,h=b.segments.length;e<h;e++){var f=b.segments[e];var a=[f.pos[0],f.pos[1],c[2],c[3]];widget._drawFromRoot(f.wId,n,a,f.wObj,m)}}for(var e in j.ad){var k=(d.ad[e])[0];var l=(d.ad[e])[3]||"tl";var m=[(d.ad[e])[2],(d.ad[e])[1],l];var p=false;widget._drawFromRoot(k,n,d.absTLWH,p,m)}return d};widget._draw=function(i,c,b,a,h,e){var a=a||widget.get(i);if(!a){return false}var d=widget._setTMPLVars(i,a,b,h);if(d.isHelperWidget&&d.upload&&d.upload==="y"){d.data=i}var f=$("#tmplWidget2").tmpl(d);widget._drawCanvasOrImage(f,d);if(c){if(a.st=="b"){c.prepend(f)}else{if(e){if(e==="first"){c.prepend(f)}else{f.insertAfter($("#"+e))}}else{c.append(f)}}}return d};widget._setTMPLVarsCache=[];widget._setTMPLVars=function(c,i,f,k,b){if(b&&widget._setTMPLVarsCache[c]){return widget._setTMPLVarsCache[c]}if(!b){widget._setTMPLVarsCache=[]}var e=$.extend(true,{},i);e.id=c;e.useCanvas=widget.useCanvas;e.includeCanvasOrImage=(((e.b||e.bg)&&!e.srps)||e.upload||e.i)?true:false;e.isRootwidget=(c==e.lockTo)?true:false;e.isLibaryWidget=(e.lockTo!=undefined)?true:false;e.of=(e.of)?e.of:e.lockTo;e.isText=(i.ts||i.tc)?true:false;e.isBackgroundWidget=(i.st=="b")?true:false;e.isStaticWidgetForeground=(i.st=="f")?true:false;if(i.ts){var h=i.ts.match(/width:\s*100\%;\s*height:\s*100%;\s*white-space:\s*pre-wrap/g);if(h&&h.length){e.addWH=false}else{e.addWH=true}var m;var j="";if(e.ts.indexOf("font-size")!==-1){m=e.ts.substring(i.ts.indexOf("font-size")+10,e.ts.indexOf(";",e.ts.indexOf("font-size"))).trim();m=parseFloat(m)}else{var d=e.ts.match(/font:[^;]*;/g);if(d.length){var l=d[0].match(/[0-9]*px/g);if(l.length){m=parseFloat(l[0])}if(l.length&&l.length>1){j=l[1]}}}if(j===""&&e.ts.indexOf("line-height")!==-1){j=e.ts.substring(e.ts.indexOf("line-height")+12,e.ts.indexOf(";",e.ts.indexOf("line-height"))).trim()}if(m&&j.indexOf("normal")!==-1){if(e.ts.indexOf("line-height")!==-1){e.ts=e.ts.replace(/line-height:\s*normal/g,"line-height: "+Math.round(m*1.14)+"px")}else{e.ts=e.ts.replace(/[0-9]*px\/[0-9]px/g,m+"px/"+Math.round(m*1.14)+"px")}}else{if(m&&j===""){e.ts=e.ts+"; line-height: "+Math.round(m*1.14)+"px;"}}}if(!e.tlwh){var a=e.wh||[f[2],f[3]];e.tlwh=[0,0,a[0],a[1]]}e.ca=(k)?k[2]||"tl":e.ca||"tl";e.absTLWH=widget._getAbsTLWH(c,e,f,k);if(b){widget._setTMPLVarsCache[c]=e}return e};widget._getAbsTLWH=function(n,m,k,c){function h(z,A){var e=parseFloat(z);return Math.round(e*A/100)}if(!m.of||n==m.of){var l=$.extend([],k)}else{var l=$.extend([],k);var d=widget.get(m.of);if(d){l=widget._getAbsTLWH(m.of,d,k,false)}}var r,q;var a=Boolean(m.segment&&d&&d.sp);var w=a?d.sp[0]+d.sp[3]:0;var p=a?d.sp[1]+d.sp[2]:0;if((m.seg||m.segments)&&(m.tlwh[2]=="a"||m.tlwh[3]=="a")){var f=widget._getSegmentRootTLWH(n,m);r=f[2];q=f[3]}else{var r=(m.tlwh[2]==="a")?"100%":m.tlwh[2];var q=(m.tlwh[3]==="a")?"100%":m.tlwh[3]}r=(typeof(r)==="string")?h(r,l[2]-w):r;q=(typeof(q)==="string")?h(q,l[3]-p):q;var v=(c)?c[0]:m.tlwh[0];var b=(c)?c[1]:m.tlwh[1];var j=(typeof(v)==="string")?h(v,l[3]-p):v;var i=(typeof(b)==="string")?h(b,l[2]-w):b;var o=m.ca||"tl";try{var u=(o[0]=="b")?l[3]-q-j:j;var t=(o[1]=="r")?l[2]-r-i:i}catch(s){var u=0;var t=0}u=(o[0]=="c")?j+l[3]/2-q/2:u;t=(o[1]=="c")?i+l[2]/2-r/2:t;u+=l[0];t+=l[1];return[Math.round(u),Math.round(t),Math.round(r),Math.round(q)]};widget._drawCanvasOrImage=function(e,c){if(!c.includeCanvasOrImage){return false}var b={width:c.absTLWH[2],height:c.absTLWH[3]};var d=$("<canvas>").attr(b);var a=d[0].getContext("2d");widget._paintCanvas(e,a,c);return true};widget.getImageData=function(d,b){var c=storage.get(d);var a=d||false;if(a&&a.substr(0,5)!="data:"){if(b&&(!c||!c.storage||c.storage=="cloud")){a=imgCloudUrl+d+".png"}else{a=ajax.apiObjectUrl("img",d)}}else{if(tmplVars.id){if(b&&(!c||!c.storage||c.storage=="cloud")){a=imgCloudUrl+tmplVars.id+".png"}else{a=ajax.apiObjectUrl("img",tmplVars.id)}}}return a};widget._drawPreviewImageUpload=function(b,a){b.get(0).innerHTML='<img class="preview-upload-image">';$imgEl=b.find("img");$imgEl.get(0).onerror=function(){if(this.src.indexOf("/data/img")===-1){this.onerror=function(){};this.src=widget.getImageData(a.data,false)}};$imgEl.get(0).src=widget.getImageData(a.data,true)};widget._drawImageUpload=function(m,f){var d={width:f.absTLWH[2],height:f.absTLWH[3]};var e=m.find("canvas");var h=e.size()>0?e:$("<canvas/>");h.attr(d);var n=h[0].getContext("2d");function j(){if(!f.tlwh[2]||!f.tlwh[3]){f.tlwh[2]=i.width;f.tlwh[3]=i.height;m.css({width:f.tlwh[2],height:f.tlwh[3]});$(n.canvas).attr({width:f.tlwh[2],height:f.tlwh[3]});widget.scale(m.closest(".widgetParts"),f)}n.drawImage(i,0,0,f.tlwh[2],f.tlwh[3]);i.onload=null;i.onerror=null;i.src=""}function l(){if(this.src.indexOf("/data/img")===-1){var o=new Image();o.src=k(false);o.onload=j;i=o;o.onerror=function(){$(n.canvas).addClass("failureImage");n.font="32pt Arial";n.fillText("Image",35,50);n.fillText("not found",10,115)}}else{$(n.canvas).addClass("failureImage");n.font="32pt Arial";n.fillText("Image",35,50);n.fillText("not found",10,115)}this.onerror=null}function b(){if(this.src.indexOf("/data/img")===-1){delete this.crossOrigin;this.removeAttribute("crossorigin");this.src=k(false)}else{l.apply(this,arguments);widget._convertCanvasToImg($(n.canvas),m.find("img"),f)}this.onerror=null}function k(p){var q=storage.get(f.data);var o=f.data||false;if(o&&o.substr(0,5)!="data:"){if(p&&(!q||!q.storage||q.storage=="cloud")){o=imgCloudUrl+f.data+".png"}else{o=ajax.apiObjectUrl("img",f.data)}}else{if(f.id){if(p&&(!q||!q.storage||q.storage=="cloud")){o=imgCloudUrl+f.id+".png"}else{o=ajax.apiObjectUrl("img",f.id)}}}return o||l()}if((e.length||m.find("img"))&&f.simpleUploadResize){return}var c=k(true);if(f.useCanvas){var i=new Image();i.onload=j;i.onerror=l;i.src=c}else{var a=m.find("img");if(a.get(0).src.indexOf("/data/img")!==-1){c=k(false)}a.get(0).onerror=b;a.get(0).onload=function(o){if(window.uploadsCache&&!window.uploadsCache[o]){if(!project.uploadCanvas){project.uploadCanvas=document.createElement("canvas")}project.uploadCanvas.width=this.naturalWidth;project.uploadCanvas.height=this.naturalHeight;project.uploadCanvasCtx=project.uploadCanvas.getContext("2d");project.uploadCanvasCtx.drawImage(this,0,0);window.uploadsCache[o]=project.uploadCanvas.toDataURL("image/png");dbStorage.set("uploads",{id:o,data:window.uploadsCache[o]})}}.bind(a.get(0),f.data);if(window.uploadsCache&&f.data&&window.uploadsCache[f.data]){a.get(0).src=uploadsCache[f.data]}else{if(c.indexOf("data/img/")!==-1){a.get(0).crossOrigin=true}a.get(0).src=c}}};widget._convertCanvasToImg=function(d,c,b){function a(){var e=d[0].toDataURL("image/png");if(e!="data:,"){c.attr("src",e)}}a()};widget._paintCanvas=function(t,o,f){var r={blur:function(){if(f.blur&&!((browserDetect.browser==="Chrome"||browserDetect.browser==="Safari")&&document.domain==="")){var A=t[0],u,v;if(window.g_preview||!widgetsCache[f.id]){u=storage.get(window.g_preview||project.get("id")).pages;for(var w=0,c=u.length;w<c;w++){var z=u[w];if(storage.get(z).widgets.indexOf(f.id)!==-1){v=z;break}}v=v||document.querySelector(".canvasObject.active").id}else{v=widgetsCache[f.id].pageId}widget.renderBlurLayer(A.id,v,function(i){widget.blurLayers[A.id]=i;widget.setBlurBG(A)});if(widget.blurLayers[A.id]){widget.setBlurBG(A)}}},background:function(){o.save();function c(){var u=(f.bgc)?f.bgc:["#CAD1D7","#C4CBD3"];var w=[5,2];var v="v";if(f.bgd){v=f.bgd[0];w=[f.bgd[1],f.bgd[2]]}o.fillStyle=u[1];o.fill();o.fillStyle=u[0];if(v=="v"){for(var z=w[0];z<d;){o.fillRect(z,0,w[1],s);z+=w[0]}}else{for(var z=w[0];z<s;){o.fillRect(0,z,d,w[1]);z+=w[0]}}}if(!d){d=0}if(!s){s=0}if(f.bg=="c"){o.fillStyle=f.bgc[0];o.fill()}else{if(f.bg=="s"){c()}else{if(f.bg=="l"){g=o.createLinearGradient(0,0,0,s);r._gradient(g,o,f)}else{if(f.bg=="lrl"){g=o.createLinearGradient(0,0,d,0);r._gradient(g,o,f)}else{if(f.bg=="ld"){g=o.createLinearGradient(0,0,d,s);r._gradient(g,o,f)}else{if(f.bg=="ld2"){g=o.createLinearGradient(d,0,0,s);r._gradient(g,o,f)}else{if(f.bg=="r"){g=o.createRadialGradient(d/2,s/2,0,d/2,s/2,s/2);r._gradient(g,o,f)}}}}}}}o.restore()},border:function(A,u,v,i){var z=0,w=0;A.lineWidth=(typeof n)==="number"?n:b;A.strokeStyle=u.b[1];A.stroke();A.save()},path:function(ac,ai,K,F,C,i,v,B,H){ac.beginPath();var W=F+Math.floor(B/2);var aa=C+Math.floor(B/2);var ae=F+v-Math.floor(B/2);var Y=C+i-Math.floor(B/2);if(H.sh&&H.sh[3]&&H.sh[2]){W+=Math.floor(H.sh[3]-H.sh[2]/2);aa+=Math.floor(H.sh[3]-H.sh[2]/2);ae-=Math.floor(H.sh[3]+H.sh[2]/2);Y-=Math.floor(H.sh[3]+H.sh[2]/2)}if($.isArray(K)){for(var ab=0;ab<4;ab++){K[ab]=K[ab]||0}}else{K=[K,K,K,K]}if(ai=="sq"){var ad=Math.min((Y-aa)/2,(ae-W)/2);K[0]=Math.min(K[0],ad);K[1]=Math.min(K[1],ad);K[2]=Math.min(K[2],ad);K[3]=Math.min(K[3],ad);ac.moveTo(aa+K[0],W),ac.lineTo(Y-K[1],W),ac.quadraticCurveTo(Y,W,Y,W+K[1]),ac.lineTo(Y,ae-K[2]),ac.quadraticCurveTo(Y,ae,Y-K[2],ae),ac.lineTo(aa+K[3],ae),ac.quadraticCurveTo(aa,ae,aa,ae-K[3]),ac.lineTo(aa,W+K[0]),ac.quadraticCurveTo(aa,W,aa+K[0],W)}if(ai=="arrU"){var N=w<=P?(ae-W)/2:(Y-aa)+(5/4),w=ae-W,P=(Y-aa)*1.5;var U=[utils.Vector((aa+Y)/2,W+B),utils.Vector(Y-(B/2),W+N),utils.Vector((aa+Y)*0.65,W+N),utils.Vector((aa+Y)*0.65,ae),utils.Vector((aa+Y)*0.35,ae),utils.Vector((aa+Y)*0.35,W+N),utils.Vector(aa+(B/2),W+N)];utils.drawVectors(ac,U,K)}if(ai=="arrD"){var N=(Y-aa)+(5/4);var w=ae-W;var P=(Y-aa)*1.5;if(w<=P){var N=(ae-W)/2}var U=[utils.Vector((aa+Y)/2,ae-B),utils.Vector(Y-(B/2),ae-N),utils.Vector((aa+Y)*0.65,ae-N),utils.Vector((aa+Y)*0.65,W),utils.Vector((aa+Y)*0.35,W),utils.Vector((aa+Y)*0.35,ae-N),utils.Vector(aa+(B/2),ae-N),utils.Vector((aa+Y)/2,ae)];utils.drawVectors(ac,U,K)}if(ai=="arrR"){var N=(ae-W)+(5/4);var z=Y-aa;var M=(ae-W)*1.5;if(z<=M){var N=(Y-aa)/2}var U=[utils.Vector(Y-B,(W+ae)/2),utils.Vector(Y-N,ae-(B/2)),utils.Vector(Y-N,(W+ae)*0.65),utils.Vector(aa,(W+ae)*0.65),utils.Vector(aa,(W+ae)*0.35),utils.Vector(Y-N,(W+ae)*0.35),utils.Vector(Y-N,W+(B/2)),utils.Vector(Y-B,(W+ae)/2),];utils.drawVectors(ac,U,K)}if(ai=="arrL"){var N=(ae-W)+(5/4);var z=Y-aa;var M=(ae-W)*1.5;if(z<=M){var N=(Y-aa)/2}var U=[utils.Vector(aa+B,(W+ae)/2),utils.Vector(aa+N,ae-(B/2)),utils.Vector(aa+N,(W+ae)*0.65),utils.Vector(Y,(W+ae)*0.65),utils.Vector(Y,(W+ae)*0.35),utils.Vector(aa+N,(W+ae)*0.35),utils.Vector(aa+N,W+(B/2)),utils.Vector(aa+B,(W+ae)/2)];utils.drawVectors(ac,U,K)}if(ai=="image"){ac.moveTo(aa,W);ac.lineTo(Y,W);ac.lineTo(Y,ae);ac.lineTo(aa,ae);ac.lineTo(aa,W);ac.moveTo(aa,W);ac.lineTo(aa+1,W);ac.lineTo(Y,ae-1);ac.lineTo(Y,ae);ac.lineTo(Y-1,ae);ac.lineTo(aa,W-1);ac.lineTo(aa,W);ac.moveTo(Y-1,W);ac.lineTo(Y,W);ac.lineTo(Y,W-1);ac.lineTo(aa+1,ae);ac.lineTo(aa,ae);ac.lineTo(aa,ae-1);ac.lineTo(Y-1,W)}else{if(ai=="tri"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector(Y,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="trR"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="ttrL"){var U=[utils.Vector(Y,W),utils.Vector(Y,ae),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="ttrR"){var U=[utils.Vector(aa,W),utils.Vector(Y,ae),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="triU"){var U=[utils.Vector((aa+Y)/2,W),utils.Vector(Y,ae),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="triD"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector((aa+Y)/2,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="triR"){var U=[utils.Vector(aa,W),utils.Vector(Y,(W+ae)/2),utils.Vector(aa,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="triL"){var U=[utils.Vector(Y,W),utils.Vector(aa,(W+ae)/2),utils.Vector(Y,ae)];utils.drawVectors(ac,U,K)}else{if(ai=="ribU"){ac.moveTo(aa,W);ac.lineTo((aa+Y)/2,(W+ae)/4);ac.lineTo(Y,W);ac.lineTo(Y,ae);ac.lineTo(aa,ae);ac.lineTo(aa,W)}else{if(ai=="ribD"){ac.moveTo(aa,W);ac.lineTo(Y,W);ac.lineTo(Y,ae);ac.lineTo((aa+Y)/2,(3/4)*(W+ae));ac.lineTo(aa,ae);ac.lineTo(aa,W)}else{if(ai=="flagR"){ac.moveTo(aa,W);ac.lineTo(Y,W);ac.lineTo((4/5)*(aa+Y),(W+ae)/2);ac.lineTo(Y,ae);ac.lineTo(aa,ae);ac.lineTo(aa,W)}else{if(ai=="flagL"){ac.moveTo(aa,W);ac.lineTo((1/5)*(aa+Y),(W+ae)/2);ac.lineTo(aa,ae);ac.lineTo(Y,ae);ac.lineTo(Y,W);ac.lineTo(aa,W)}else{if(ai=="houseU"){var U=[utils.Vector(Y,(3/7)*(W+ae)),utils.Vector(Y,ae),utils.Vector(aa,ae),utils.Vector(aa,(3/7)*(W+ae)),utils.Vector((aa+Y)/2,W)];utils.drawVectors(ac,U,K)}else{if(ai=="houseD"){var U=[utils.Vector((aa+Y)/2,ae),utils.Vector(Y,(4/7)*(W+ae)),utils.Vector(Y,W),utils.Vector(aa,W),utils.Vector(aa,(4/7)*(W+ae))];utils.drawVectors(ac,U,K)}else{if(ai=="oct"){var ag=21/72,E=51/72,J=aa+Y,I=W+ae,U=[utils.Vector(ag*J,W),utils.Vector(E*J,W),utils.Vector(Y,ag*I),utils.Vector(Y,E*I),utils.Vector(E*J,ae),utils.Vector(ag*J,ae),utils.Vector(aa,E*I),utils.Vector(aa,ag*I)];utils.drawVectors(ac,U,K)}else{if(ai=="star"){var U=[utils.Vector((aa+Y)/2,W),utils.Vector((33/54)*(aa+Y),(39/102)*(ae+W)),utils.Vector(Y,(39/102)*(ae+W)),utils.Vector((75/108)*(aa+Y),(63/102)*(ae+W)),utils.Vector((87/108)*(aa+Y),ae),utils.Vector((aa+Y)/2,(39/51)*(ae+W)),utils.Vector((21/108)*(aa+Y),ae),utils.Vector((33/108)*(aa+Y),(63/102)*(ae+W)),utils.Vector(aa,(39/102)*(ae+W)),utils.Vector((21/54)*(aa+Y),(39/102)*(ae+W))];utils.drawVectors(ac,U,K)}else{if(ai=="pgL"){var U=[utils.Vector(aa,ae),utils.Vector(Y,ae),utils.Vector(Y,W),utils.Vector((aa+Y)/3,W),utils.Vector(aa,(W+ae)/4)];utils.drawVectors(ac,U,K)}else{if(ai=="pgR"){var U=[utils.Vector(Y,ae),utils.Vector(aa,ae),utils.Vector(aa,W),utils.Vector((2/3)*(aa+Y),W),utils.Vector(Y,(W+ae)/4)];utils.drawVectors(ac,U,K)}else{if(ai=="pointrL"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector((5/7)*(aa+Y),(3/7)*(W+ae)),utils.Vector((5/7)*(aa+Y),ae),utils.Vector(aa,W)];utils.drawVectors(ac,U,K)}else{if(ai=="pointrR"){var U=[utils.Vector(aa,W),utils.Vector(Y,W),utils.Vector((2/7)*(aa+Y),ae),utils.Vector((2/7)*(aa+Y),(3/7)*(W+ae)),utils.Vector(aa,W)];utils.drawVectors(ac,U,K)}else{if(ai=="ldL"){ac.moveTo(aa,W);ac.lineTo(aa+2,W);ac.lineTo(Y,ae);ac.lineTo(Y-2,ae);ac.lineTo(aa,W)}else{if(ai=="ldR"){ac.moveTo(Y,W);ac.lineTo(Y-2,W);ac.lineTo(aa,ae);ac.lineTo(aa+2,ae);ac.lineTo(Y,W)}else{if(ai=="dropD"){ac.moveTo((aa+Y)/2,W);ac.lineTo((aa+Y)/6,(W+ae)/2);ac.bezierCurveTo(aa-((aa+Y)*(1.5/6)),ae+((ae+W)/6.2),Y+((aa+Y)*(1.5/6)),ae+((ae+W)/6.2),(aa+Y)*(5/6),(W+ae)/2);ac.lineTo((aa+Y)/2,W)}else{if(ai=="dropU"){ac.moveTo((aa+Y)/2,ae);ac.lineTo((aa+Y)/6,(W+ae)/2);ac.bezierCurveTo(aa-((aa+Y)*(1.5/6)),W-((ae+W)/6.2),Y+((aa+Y)*(1.5/6)),W-((ae+W)/6.2),(aa+Y)*(5/6),(W+ae)/2);ac.lineTo((aa+Y)/2,ae)}else{if(ai=="oval"){ac.moveTo(aa,(ae+W)/2);ac.bezierCurveTo((aa+Y)*(1/4),W-((ae+W)/7),(aa+Y)*(3/4),W-((ae+W)/7),Y,(ae+W)/2);ac.bezierCurveTo((aa+Y)*(3/4),ae+((ae+W)/7),(aa+Y)*(1/4),ae+((ae+W)/7),aa,(ae+W)/2)}else{if(ai=="cloud"){ac.moveTo((aa+Y)*(1.5/9),ae);ac.bezierCurveTo(aa,ae,aa,(W+ae)*(7/11),(aa+Y)*(1.6/9),(ae+W)*(7/11));ac.bezierCurveTo((aa+Y)/9,(ae+W)/3,(aa+Y)/3,(ae+W)/6.3,(aa+Y)*(4/9),(ae+W)/3.2);ac.bezierCurveTo((aa+Y)*(4.5/9),W,(aa+Y)*(7.4/9),W,(aa+Y)*(7.3/9),(ae+W)/2);ac.bezierCurveTo(Y,(ae+W)/2,Y,ae,(aa+Y)*(7.7/9),ae);ac.lineTo((aa+Y)*(1.5/9),ae)}else{if(ai=="person"){ac.moveTo(aa,ae);ac.bezierCurveTo((aa+Y)/16,(W+ae)*(11/14),(aa+Y)*(3/16),(W+ae)*(10/14),(aa+Y)*(6/16),(ae+W)*(9/14));ac.bezierCurveTo((aa+Y)*(2.5/16),(W+ae)*(4/7),(aa+Y)*(2.5/16),W,(aa+Y)/2,W);ac.bezierCurveTo((aa+Y)*(13.5/16),W,(aa+Y)*(13.5/16),(W+ae)*(4/7),(aa+Y)*(10/16),(ae+W)*(9/14));ac.bezierCurveTo((aa+Y)*(13/16),(W+ae)*(10/14),(aa+Y)*(15/16),(W+ae)*(11/14),Y,ae);ac.lineTo(aa,ae)}else{if(ai=="thumbsU"){ac.moveTo(aa,(W+ae)*(16/17));ac.lineTo(aa,(W+ae)*(15/34));ac.bezierCurveTo((aa+Y)*(2/15),(W+ae)*(7/17),(aa+Y)*(9/30),(W+ae)*(4/17),(aa+Y)/3,(ae+W)*(3/34));ac.bezierCurveTo((aa+Y)*(5.2/15),W,(aa+Y)*(9/15),W,(aa+Y)*(8.5/15),(W+ae)*(2/17));ac.lineTo((aa+Y)*(7/15),(W+ae)*(11/34));ac.bezierCurveTo((aa+Y)*(9/15),(W+ae)*(13/34),(aa+Y)*(11/15),(W+ae)*(13/34),(aa+Y)*(12/15),(W+ae)*(13/34));ac.bezierCurveTo(Y,(W+ae)*(13/34),Y,(W+ae)*(19/34),(aa+Y)*(12/15),(W+ae)*(19/34));ac.bezierCurveTo((aa+Y)*(14/15),(W+ae)*(19/34),(aa+Y)*(27/30),(W+ae)*(12/17),(aa+Y)*(23/30),(W+ae)*(12/17));ac.bezierCurveTo((aa+Y)*(13/15),(W+ae)*(12/17),(aa+Y)*(25/30),(W+ae)*(29/34),(aa+Y)*(11/15),(W+ae)*(29/34));ac.bezierCurveTo((aa+Y)*(25/30),(W+ae)*(29/34),(aa+Y)*(12/15),ae,(aa+Y)*(8.5/15),ae);ac.bezierCurveTo((aa+Y)/2,ae,(aa+Y)/5,ae,aa,(W+ae)*(16/17))}else{if(ai=="thumbsD"){ac.moveTo(aa,(W+ae)/17);ac.lineTo(aa,(W+ae)*(19/34));ac.bezierCurveTo((aa+Y)*(2/15),(W+ae)*(10/17),(aa+Y)*(9/30),(W+ae)*(13/17),(aa+Y)/3,(ae+W)*(31/34));ac.bezierCurveTo((aa+Y)*(5.2/15),ae,(aa+Y)*(9/15),ae,(aa+Y)*(8.5/15),(W+ae)*(15/17));ac.lineTo((aa+Y)*(7/15),(W+ae)*(23/34));ac.bezierCurveTo((aa+Y)*(9/15),(W+ae)*(21/34),(aa+Y)*(11/15),(W+ae)*(21/34),(aa+Y)*(12/15),(W+ae)*(21/34));ac.bezierCurveTo(Y,(W+ae)*(21/34),Y,(W+ae)*(15/34),(aa+Y)*(12/15),(W+ae)*(15/34));ac.bezierCurveTo((aa+Y)*(14/15),(W+ae)*(15/34),(aa+Y)*(27/30),(W+ae)*(5/17),(aa+Y)*(23/30),(W+ae)*(5/17));ac.bezierCurveTo((aa+Y)*(13/15),(W+ae)*(5/17),(aa+Y)*(25/30),(W+ae)*(5/34),(aa+Y)*(11/15),(W+ae)*(5/34));ac.bezierCurveTo((aa+Y)*(25/30),(W+ae)*(5/34),(aa+Y)*(12/15),W,(aa+Y)*(8.5/15),W);ac.bezierCurveTo((aa+Y)/2,W,(aa+Y)/5,W,aa,(W+ae)/17)}else{if(ai=="arcL"){var i=Y-aa;var v=ae-W;var X=(v>=(i*2))?i:v/2;ac.moveTo(aa+X,W);ac.arcTo(aa,W,aa,W+X,X);ac.arcTo(aa,W+(2*X),aa+X,W+(2*X),X);ac.lineTo(aa+X,W)}else{if(ai=="arcR"){var i=Y-aa;var v=ae-W;var X=(v>=(i*2))?i:v/2;ac.moveTo(aa,W);ac.arcTo(aa+X,W,aa+X,W+X,X);ac.arcTo(aa+X,W+(2*X),aa,W+(2*X),X);ac.lineTo(aa,W)}else{if(ai=="arcU"){var i=Y-aa;var v=ae-W;var X=(i>=(v*2))?v:i/2;ac.moveTo(aa,W+X);ac.arcTo(aa,W,aa+X,W,X);ac.arcTo(aa+(2*X),W,aa+(2*X),W+(2*X),X);ac.lineTo(aa,W+X)}else{if(ai=="arcD"){var i=Y-aa;var v=ae-W;var X=(i>=(v*2))?v:i/2;ac.moveTo(aa,W);ac.arcTo(aa,W+X,aa+X,W+X,X);ac.arcTo(aa+(2*X),W+X,aa+(2*X),W,X);ac.lineTo(aa,W)}else{if(ai=="folder"){var S=K[0],i=Y-W,v=ae-W,L={x:(3/8)*(Y+aa),y:(2/15)*(W+ae)},G={x:(5/16)*(Y+aa),y:W},R={x:G.x+(L.x-G.x)/2,y:W+(L.y-W)/2},af=Math.sqrt(R.x*R.x+R.y*R.y);K[1]=Math.min(S,(i-L.x)/2,v/2);K[2]=Math.min(S,(ae-L.y)/2,(L.x-W)/2);K[4]=Math.min(S,v/2,(G.x-aa)/2),K[1]=K[4]=Math.min(K[1],K[4]);K[3]=Math.min(K[4],K[2]);K[0]=Math.min(S,af,K[4]);K[5]=K[0];ac.moveTo(L.x+K[0],L.y);ac.lineTo(Y-K[1],L.y);ac.quadraticCurveTo(Y,L.y,Y,L.y+K[1]);ac.lineTo(Y,ae-K[2]);ac.quadraticCurveTo(Y,ae,Y-K[2],ae);ac.lineTo(aa+K[3],ae);ac.quadraticCurveTo(aa,ae,aa,ae-K[3]);ac.lineTo(aa,W+K[4]);ac.quadraticCurveTo(aa,W,aa+K[4],W);ac.lineTo(G.x-K[5],G.y);ac.quadraticCurveTo(G.x,G.y,R.x,R.y);ac.quadraticCurveTo(L.x,L.y,L.x+K[0],L.y)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if(ai=="speechRight"){ac.moveTo(Y-17,ae);ac.lineTo(Y-96,ae-13);ac.lineTo(aa,ae-13);ac.lineTo(aa,W);ac.lineTo(Y,W);ac.lineTo(Y,ae-13);ac.lineTo(Y-38,ae-13);ac.lineTo(Y-17,ae)}if(ai=="speechLeft"){ac.moveTo(aa+17,ae);ac.lineTo(aa+96,ae-13);ac.lineTo(Y,ae-13);ac.lineTo(Y,W);ac.lineTo(aa,W);ac.lineTo(aa,ae-13);ac.lineTo(aa+38,ae-13);ac.lineTo(aa+17,ae)}else{if(ai=="bubr"){right=i-1;bottom=v-2;tailSize=7;if(H.b){F=F+H.b[0]/2;C=C+H.b[0]/2;right=right-H.b[0]/2;bottom=bottom-H.b[0]/2}ac.moveTo(right-tailSize,bottom-7);ac.lineTo(right-tailSize,F+K[1]);ac.quadraticCurveTo(right-tailSize,F,right-K[1]-tailSize,F);ac.lineTo(C+K[0],F);ac.quadraticCurveTo(C,F,C,F+K[0]);ac.lineTo(C,bottom-K[3]);ac.quadraticCurveTo(C,bottom,C+K[3],bottom);ac.lineTo(right-19,bottom);ac.quadraticCurveTo(right-15,bottom-1,right-14,bottom-2);ac.quadraticCurveTo(right-7,bottom+1,right-1,bottom-2);ac.quadraticCurveTo(right-tailSize,bottom-3,right-tailSize,bottom-7)}else{if(ai=="bubl"){right=i-1;bottom=v-2;tailSize=7;if(H.b){F=F+H.b[0]/2;C=C+H.b[0]/2;right=right-H.b[0]/2;bottom=bottom-H.b[0]/2}ac.moveTo(right,bottom-K[2]);ac.lineTo(right,F+K[1]);ac.quadraticCurveTo(right,F,right-K[1],F);ac.lineTo(C+K[0]+tailSize,F);ac.quadraticCurveTo(C+tailSize,F,C+tailSize,F+K[0]);ac.lineTo(C+tailSize,bottom-6);ac.quadraticCurveTo(C+4,bottom-1,C+1,bottom-2);ac.quadraticCurveTo(C+2,bottom+2,C+13,bottom-2);ac.quadraticCurveTo(C+15,bottom,C+19,bottom);ac.lineTo(right-K[2],bottom);ac.quadraticCurveTo(right,bottom,right,bottom-K[2])}else{if(ai=="arrowL"||ai=="arrowR"||ai=="arrowU"||ai=="arrowD"){var ah=2;if(H.aCurve){ah=H.aCurve}var O=12;if(H.aSize){O=H.aSize}if(ai=="arrowL"){ac.moveTo(aa+O,W);ac.lineTo(Y-K[1],W);ac.quadraticCurveTo(Y,W,Y,W+K[1]);ac.lineTo(Y,ae-K[2]);ac.quadraticCurveTo(Y,ae,Y-K[2],ae);ac.lineTo(aa+O,ae);ac.bezierCurveTo(aa+O-ah,ae,aa,((ae+W)/2)+ah,aa,(ae+W)/2);ac.bezierCurveTo(aa,((ae+W)/2)-ah,O-ah,W,aa+O,W)}else{if(ai=="arrowR"){ac.moveTo(aa+K[0],W);ac.lineTo(Y-O,W);ac.bezierCurveTo(Y-O+ah,W,Y,((W+ae)/2)-ah,Y,(W+ae)/2);ac.bezierCurveTo(Y,((W+ae)/2)+ah,Y-O+ah,ae,Y-O,ae);ac.lineTo(aa+K[3],ae);ac.quadraticCurveTo(aa,ae,aa,ae-K[3]);ac.lineTo(aa,W+K[0]);ac.quadraticCurveTo(aa,W,aa+K[0],W)}else{if(ai=="arrowD"){var A=(H.aW)?H.aW:A;var u=(aa+Y)/2;var Z=A/2;ac.moveTo(aa+K[0],W);ac.lineTo(Y-K[1],W);ac.quadraticCurveTo(Y,W,Y,W+K[1]);ac.lineTo(Y,ae-O-K[2]);ac.quadraticCurveTo(Y,ae-O,Y-K[2],ae-O);ac.lineTo(u+Z,ae-O);ac.lineTo(u,ae);ac.lineTo(u-Z,ae-O);ac.lineTo(aa+K[3],ae-O);ac.quadraticCurveTo(aa,ae-O,aa,ae-O-K[3]);ac.lineTo(aa,W+K[0]);ac.quadraticCurveTo(aa,W,aa+K[0],W)}else{if(ai=="arrowU"){var A=(H.aW)?H.aW:20;var u=(aa+Y)/2;var Z=A/2;ac.moveTo(aa+K[0],W+O);ac.lineTo(u-Z,W+O);ac.lineTo(u,W);ac.lineTo(u+Z,W+O);ac.lineTo(Y-K[1],W+O);ac.quadraticCurveTo(Y,W+O,Y,W+O+K[1]);ac.lineTo(Y,ae-K[2]);ac.quadraticCurveTo(Y,ae,Y-K[2],ae);ac.lineTo(aa+K[2],ae);ac.quadraticCurveTo(aa,ae,aa,ae-K[3]);ac.lineTo(aa,W+O+K[0]);ac.quadraticCurveTo(aa,W+O,aa+K[3],W+O)}}}}}else{if(ai=="c"){var V=i/2,T=v/2,D=Math.min(V,T),Q=Math.min(B|0,D),X=D-Q/2;if(X<0){X=0}n=Q;ac.arc(V,T,X,0,Math.PI*2,true)}}}}}ac.closePath()},_gradient:function(A,C,w){var u=["#ffffff","#000000"];var z=[0,1];if(w.bgc&&w.bgd){u=w.bgc;z=w.bgd}for(var v=0;v<u.length&&v<z.length;v++){try{A.addColorStop(z[v],u[v])}catch(B){}}C.fillStyle=A;C.fill()},_glaze:function(A,v){var E=5,B=2,w=10,u=v.absTLWH[2]-27,D=10,i=0,C=7;if(v.s=="bubl"){w+=C}r.path(A,"sq",E,B,w,u,D,i,v);var z=A.createLinearGradient(0,B+D,0,B);z.addColorStop(0,"rgba(231, 231, 231, 0.2)");z.addColorStop(0.59,"rgba(240, 240, 240, 0.25)");z.addColorStop(1,"rgba(249, 249, 249, 0.3)");A.fillStyle=z;A.fill();A.restore()},_shadow:function(u,i){u.shadowColor=i.sh[0];u.shadowOffsetX=i.sh[1];u.shadowOffsetY=i.sh[2];u.shadowBlur=i.sh[3]},_effect:function(I,v){var u=v.fx;for(var D=0;D<u.length;D++){var F=u[D];if(F[0]=="dots"){var M=F[1];var G=F[2];var L=F[3];I.fillStyle=F[4];var z=v.absTLWH[2];var w=v.absTLWH[3];var J=M+G;var E=M+L;var K=parseInt(z/J)+1;var H=parseInt(w/E)+1;var C=0;for(var B=0;B<H;B++){C=(C)?0:M;for(var A=0;A<K;A++){I.beginPath();I.arc((A*J)+C,(B*E),M/2,0,2*Math.PI);I.closePath();I.fill()}}}}},_setImage:function(A,C,w){try{if(w.useCanvas){var i={width:w.absTLWH[2],height:w.absTLWH[3]};var u=A.find("canvas").attr(i);var z=u[0].getContext("2d");z.drawImage(C.canvas,0,0)}else{var v=A.find("img");widget._convertCanvasToImg($(C.canvas),v,w)}}catch(B){}}};if(!t[0].classList.contains("ui-resizable-resizing")){r.blur()}if(typeof f.upload==="string"&&f.upload=="y"){if(window.g_preview){widget._drawPreviewImageUpload(t,f)}else{widget._drawImageUpload(t,f)}return}var q=0,h=0;var d=f.absTLWH[2];var s=f.absTLWH[3];var b=0;var e=0;var j=f.b;var n=null;if(j){b=j[0];e=j.length>3?j.slice(2):j[2]}var m=f.s?f.s:"sq";o.save();r.path(o,m,e,q,h,d,s,b,f);if(f.sh){r._shadow(o,f)}if(f.bg){r.background(o,f)}o.restore();if(j&&b>0){r.border(o,f,d,s)}if(f.glaze&&f.glaze=="y"){r._glaze(o,f)}if(f.fx&&f.fx.length>0){r._effect(o,f)}if(f.i){for(var l=0;l<f.i.length;l++){var p=f.i[l];var k=new Image();function a(){var i=p[5];if(typeof(i)=="string"&&i.search("%")!=-1){i=(d*parseInt(i)/100)-p[3]/2}else{if(i<0){i=parseInt(d)+p[5]-p[3]}}var c=p[6];if(typeof(c)=="string"&&c.search("%")!=-1){c=(s*parseInt(c)/100)-p[4]/2}else{if(c<0){c=parseInt(s)+p[6]-p[4]}}k.onload=function(){try{o.drawImage(k,p[1],p[2],p[3],p[4],i+h,c+q,p[3],p[4]);r._setImage(t,o,f);if(o.canvas.hasOwnProperty("onchange")){o.canvas.onchange()}}catch(u){}};k.src=p[0]}$(k).ready(a)}}else{r._setImage(t,o,f)}};widget.scale=function(f,a){var c=10;var e;if(a.ls){e=a.ls}else{if(typeof a.wh==="undefined"){e=66/80}else{if(a.wh[0]=="a"||a.wh[1]=="a"){e=66/320}else{if(a.wh[0]=="100%"||a.wh[1]=="100%"){e=66/320}else{if(typeof(a.wh[0])==="string"||typeof(a.wh[1])==="string"){var d=parseInt(a.wh[0])/640;var b=parseInt(a.wh[1])/640;e=Math.max(d,b)}else{e=Math.min(1,66/a.wh[0],66/a.wh[1])}}}}}if(e<1){$(f).css({"-webkit-transform":"scale("+e+")","-moz-transform":"scale("+e+")"})}};widget.add=function(h,i,j,b,a){var f=$(b).closest(".screen");var d=j;var c=(h)?true:false;return widget._add(d,f,c)};widget._add=function(a,j,f,i){if(project.readOnly()){return false}storage.cacheStart();widget._stopEditingText();widget.resetSelection();var l=false;var b=j.find(".widgetHolder");widget.afterAdding();var m=[0,0,b.width(),b.height()];var i=(i)?i:false;var k=false;var h=false;var d=widget._createSaveAndDraw(a,l,j,i,b,m,k,h);if(f){var c=$("#"+d);widget.select(null,c)}storage.commitCache();var e=j.attr("id");widget.renderAbove(e,d);return d};widget.renderAbove=function(b,e){var d=storage.get(b).widgets;var a=false;for(var c=0;c<d.length;c++){if(a&&storage.get(d[c]).blur){page.drawDetailed(b,"init",{restoreSelection:$(".pageWidget.ui-selected").attr("id")});return}if(d[c]===e){a=true}}};widget._createSaveAndDraw=function(a,l,h,i,b,m,j,d){var c=utils.guid("w");var k=typeof a=="string"?widget.get(a):a;if(!k){return false}var f=$.extend(true,{},k);f.lockTo=(l)?l:c;f.tlwh=widget._getRelativeTLWH(c,f,h,i);var e=f.ca||(i&&i[2]);f.ca=(e)?e:"tl";if(j){f.of=j}if(d===true){d=c}if(d){f.segment=d}widget._removeUnnecesaryProps(f);if((f.upload)&&(!f.data)){f.data=a}widget._save(c,f,h);page.calculateWdgPositions(h.attr("id"));widget._draw(c,b,m);h[0].querySelector(".page-preview")&&page.drawDetailed(h[0].id,"init");if(f.seg&&f.sc){widget._dropSegments(c,f,h,b,m)}if(f.ad){widget._dropAds(c,f,h,b,m,d);delete f.ad;widget.set(f,c)}return c};widget._dropSegments=function(f,h,l,a,m){var b=widget._setupSegments(h,m);h.segments=[];var k=b.segments.length;for(var e=0;e<k;e++){var j=b.segments[e];var d=true;var c=widget._createSaveAndDraw(j.wObj,h["lockTo"],l,j.pos,a,m,f,d);h.segments.push({id:c,widget:j.wId})}};widget._dropAds=function(f,h,j,a,l,c){for(var d in h.ad){var k=h.ad[d];var b=k[3]||"tl";var e=[k[2],k[1],b];widget._createSaveAndDraw(k[0],h["lockTo"],j,e,a,l,f,c)}};widget._getRelativeTLWH=function(k,j,c,f){if(typeof j.st!=="undefined"&&j.st=="b"){return[0,0,"a","a"]}var b=0;var l=0;if(j.wh||j.tlwh){b=j.tlwh?j.tlwh[2]:j.wh[0];l=j.tlwh?j.tlwh[3]:j.wh[1]}if(j.upload==="y"){var i=storage.get(c[0].id),h=utils.getFitSize({object:{width:b,height:l},frame:{width:i.width,height:i.height}});b=h.width;l=h.height}if(f){return[f[0],f[1],b,l]}var m=$("#libraryWidgetDragging");if(m.length>0){var a=$("#libraryWidgetDragging").position();var e=$(c).offset();return[a.top-e.top+8,a.left-e.left+8,b,l]}if(k==j["lockTo"]){var d=(j.dp)?j.dp:[0,0];return[d[0],d[1],b,l]}return[0,0,b,l]};widget._removeUnnecesaryProps=function(a){delete a.title;delete a.g;delete a.t;delete a.dp;delete a.x;delete a.id;delete a.wh};widget._save=function(c,b,a){page.addWidget(a.attr("id"),c,b);storage.set(c,b);if(typeof b.st!=="undefined"&&b.st=="b"&&a.find(".backgroundWidget").length>0){widget.del(a.find(".backgroundWidget"))}};widget.afterAdding=function(){var d=$(".screen.active");var a=d.attr("id");var c=project.hasWidgets()?false:true;var b=page.get(a,"widgets").length>0?false:true;if((c)||(!project.get("homepage"))){$("#previewView, #preview, #pagePreview").animate({opacity:1},300);$("#preview, #pagePreview").css("pointer-events","auto");page.makeHome(null,d)}if(b){$("#trash").fadeIn(300)}};widget.duplicate=function(a){widget._duplicate(a);return false};widget.cut=function(b,a){widget._cut(b,a);return false};widget.copy=function(a){widget._copy(a);return false};widget.paste=function(a){widget._paste(a);return false};widget.replace=function(b,a){widget._replace(b,a)};widget.editText=function(a){widget._editText(a,this);return false};widget._copies=null;widget._copyOriginPageId=null;widget._editText=function(i,j){if(project.readOnly()){return false}if($("#canvasPages .pageWidget textarea").length>0){widget._stopEditingText()}var j=$(j);if(j.length!=1){return}j.addClass("editing");var h=j.closest(".pageWidget");var c=widget.get(h.attr("id"));var k=c.tlwh[3]-parseInt(j.css("padding-top"))-parseInt(j.css("padding-bottom"));var b=c.tlwh[2]-parseInt(j.css("padding-left"))-parseInt(j.css("padding-right"));j.hide();var a=j.attr("style");var d=parseFloat(j.css("padding-top"));var f={width:"100%",height:c.tlwh[3]-d};$("<textarea>").attr("style",a).css(f).text(c.tc).insertAfter(j).show().focus().select();return false};widget._stopEditingText=function(){$(".widgetText").removeClass("editing");var a=$("#canvasPages .pageWidget textarea");if(a.length==0){return}var b=a.val();var c=a.closest(".pageWidget").attr("id");fluid.command.create("setText",{id:c,text:b}).dispatchTo("fluid.controllers.widget");a.siblings(".widgetText").show();a.remove();return false};widget._duplicate=function(c){if(widget.editing==true){return true}var a=$.extend(true,{},widget._copies);var b=widget.getLockTos("#canvasPages .ui-selected");widget._copy(c,b);widget._paste(c);widget._copies=$.extend(true,[],a);a=null};widget._cut=function(c,b){var a=widget.getLockTos(b||"#canvasPages .ui-selected");widget._copy(null,a,true);widget.del(a);widget.resetSelection();contextMenu.hide();propInspector.resetPropInspector();return false};widget._copy=function(c,b,a){widget._copies={oldId:[],data:[],newId:[]};widget._copyOriginPageId=$("#canvasPages .ui-draggable .ui-selected").closest(".screen").attr("id");if(!b){var b=widget.getLockTos("#canvasPages .ui-selected")}b.each(function(){var e=$(this).attr("id");var d=$.extend(true,{},widget.get(e));(widget._copies.oldId).push(e);(widget._copies.data).push(d);widget._copies.cut=a});group.copy(widget._copies.oldId);return false};widget._paste=function(p){if(!widget._copies){return true}if($(".pageWidget textarea").length){return true}var b=$("#canvasPages .active");var a=b.attr("id");if(!b.length){notification.add("alert","Cannot paste. No active page selected.");return false}widget._copies["newId"]=[];for(var m in widget._copies["oldId"]){(widget._copies["newId"])[m]=utils.guid("w")}widget.afterAdding();var c=b.find(".widgetHolder");var r=[0,0,c.outerWidth(),c.outerHeight()];var l="";for(var m in widget._copies["oldId"]){var f=(widget._copies["newId"])[m];var k=$.extend(true,{},(widget._copies["data"])[m]);var s=$.inArray(k.lockTo,widget._copies["oldId"]);k.lockTo=(widget._copies["newId"])[s];if(k.segment){var d=$.inArray(k.segment,widget._copies["oldId"]);k.segment=(widget._copies["newId"])[d]}if(widget._copies.data[m].segments){var j=widget._copies.data[m];for(var q=0,o=j.segments.length;q<o;q++){var n=$.inArray(j.segments[q].id,widget._copies["oldId"]);k.segments[q].id=widget._copies["newId"][n]}}if(k.of){var h=$.inArray(k.of,widget._copies["oldId"]);k.of=(widget._copies["newId"])[h]}if(widget._copyOriginPageId==a&&k.lockTo==f&&k.st!="b"&&!widget._copies.cut){k.tlwh[0]+=5;k.tlwh[1]+=5}widget._save(f,k,b);widget._draw(f,c,r,false,false);if(!k.of){l+="#"+(widget._copies["newId"])[m]+", "}}widget.resetSelection();group.paste(widget._copies.newId,group.copyGroups);widget.select(null,$(l));return false};widget.del=function(d){$("#multiSelBox").remove();if(d.jquery){$(d).each(function(){widget.remove($(this).attr("id"))})}else{if(d.length){for(var c=0;c<d.length;c++){widget.remove(d[c])}}}if(!project.hasWidgets()){$("#previewView, #preview, #pagePreview").animate({opacity:0},300);$("#preview, #pagePreview").css("pointer-events","none")}var b=$(".screen.active").attr("id");var a=page.get(b,"widgets").length>0?true:false;if(!a){hint.show("library")}else{hint.show("selectWidget")}$("#trash").removeClass("droppableStyle")};widget.remove=function(a){var e=$("#"+a);if(e.size()==0){if(widgetsCache[a].pageId){page.removeWidget(widgetsCache[a].pageId,a)}storage.remove(a);e.remove();return false}var d=widget.getDependents(a);d.each(function(){widget.remove($(this).attr("id"))});var c=link.from(a);if(c!=false){link.del(c)}var b=e.closest(".screen").attr("id");page.removeWidget(b,a);storage.remove(a);e.remove();grid.selectBackground()},widget.select=function(f,l,j){if(project.readOnly()){return false}var c=false;if($("#canvasPages .ui-selected").length>0&&$(" #canvasPages .ui-selected").closest(".screen").attr("id")!=$(l).closest(".screen").attr("id")){c=true;widget.resetSelection()}if(f&&(f.metaKey||f.ctrlKey)){var i=$(l);var d=$("#"+$(l).attr("data-segment"));if(i.hasClass("ui-selected")||(d.length>0&&d.hasClass("ui-selected"))){i.add(d).removeClass("ui-selected");widget._makeNonResizable(i.add(d));if(!j){if($("#canvasPages .ui-selected").length==0){contextMenu.hide()}else{contextMenu.place(f);updateTLWH();widget.addResizeSettings($(".ui-selected").eq(0))}}return}}var b=$(".ui-selected");if(f!=null&&!(f.metaKey||f.ctrlKey)&&f!="pass"){widget.resetSelection()}if(widget.selectMulti==false){if(!$(this).hasClass("ui-selected")){widget.resetSelection()}}if(browserDetect.browser=="Safari"){widget._safariDragHandleFixSel=$("#canvasPages .page *").addClass("safariResizeHandleZFix")}var d=$(l).attr("data-segment");if(d&&d==$(l).attr("id")){var k=$(l).attr("data-lockto");var h=$("#"+k);var a=b.attr("data-lockto");if((b.filter(h).size()==0&&a!=h.attr("id"))||b.filter($(l)).size()>0){l=h}}$(l).addClass("ui-selected");if(!j){if(c){setTimeout(contextMenu.place,500)}else{contextMenu.place()}}updateTLWH();widget.addResizeSettings(l);$(":focus").blur();if(f!=null&&f.stopPropagation!=undefined){f.stopPropagation()}grid.selectBackground();snap.initSnapPositions();page.hideOptionsMenu();return false};widget._selected=null;widget.addResizeSettings=function(a){$("#multiSelBox").remove();var c=$("#canvasPages .ui-selected");widget._selected=group.select(c);var b=widget._selected.length;widget._makeNonResizable(widget._selected);if(b<2){widget._makeResizable(a)}else{updateTLWH();widget.drawMultiSelBox(widget._selected)}};widget.drawMultiSelBox=function(f){var h=f.eq(0);var i=(h.hasClass("backgroundWidget"))?f.eq(1):h;var a=parseInt(i.css("top"));var c=parseInt(i.css("left"));var e=a-widget._selectionTLWH.top;var b=c-widget._selectionTLWH.left;widget._selectionTLWH.top=e*-1;widget._selectionTLWH.left=b*-1;$("#tmplSelBoundingBox").tmpl(widget._selectionTLWH).prependTo("#"+i.attr("id"));var d=$("#multiSelBox");d.css("z-index","");if(browserDetect.browser=="Firefox"){$(i).css("outline","")}};widget.resetSelection=function(){$("#multiSelBox").remove();if(browserDetect.browser=="Safari"){$("#canvas *").removeClass("safariResizeHandleZFix");widget._safariDragHandleFixSel=null}$("#trash").removeClass("droppableStyle");$("#widgetTL, #widgetWH").text("");$("#canvasPages .pageWidget.ui-selected").removeClass("ui-selected");widget._makeNonResizable();hint.show("selectWidget");contextMenu.hide();group.deselect()};widget._replace=function(j,b){var i=widget.get(j);if(i){try{var a=widget.getPageOf(j);var h=i.top;var f=i.left;var c=$("#"+j);widget.del(c);widget.add(null,{top:h,left:f},b,$("#"+a).find(".widgetHolder"))}catch(d){}}};widget.fixTLWH=function(i,f,c){if(!f.wh){return false}var b=f.top.toString();var d=f.left.toString();if(b.indexOf("%")>-1){b=b.substring(0,b.indexOf("%")+1)}if(d.indexOf("%")>-1){d=d.substring(0,d.indexOf("%")+1)}if((f.lockTo!=i)&&(b.indexOf("%")==-1)){var a=widget.get(f.lockTo);var h=(!a||isNaN(a.tlwh[0]))?0:a.tlwh[0];b=f.top-h}if((f.lockTo!=i)&&(d.indexOf("%")==-1)){var a=widget.get(f.lockTo);var h=(!a||isNaN(a.tlwh[1]))?0:a.tlwh[1];d=f.left-h}if(b.toString().indexOf("%")==-1){b=parseFloat(b)}if(d.toString().indexOf("%")==-1){d=parseFloat(d)}if((f.wh[0]).toString().indexOf("%")==-1){f.wh[0]=parseFloat(f.wh[0])}if((f.wh[1]).toString().indexOf("%")==-1){f.wh[1]=parseFloat(f.wh[1])}if(f.st!="b"){var e=[b,d,f.wh[0],f.wh[1]];f.tlwh=e}f.ca="tl";delete f.top;delete f.left;delete f.wh;delete f.id;delete f.title;delete f.dp;delete f.x;storage.set(i,f)};widget._resizeEl=null;widget._resizePageId=null;widget._resizeAxis=null;widget._resizeLockTos=null;widget._resizeFromTLWH=null;widget._dragResizeStart=function(f,d){storage.cacheStart();widget._stopEditingText();widget._resizeEl=$(d.element);widget._resizePageId=$(this).closest(".screen").attr("id");widget._resizeLockTos=widget.getLockTos($(this));widget._resizeAxis=$(this).data("resizable").axis;widget._resizeFromTLWH=[parseInt(widget._resizeEl.css("top")),parseInt(widget._resizeEl.css("left")),widget._resizeEl.width(),widget._resizeEl.height()];var b=account.get("gridStatus");var c=account.get("snapToWidget");$(this).resizable("option","grid",snap.snapResize(b));if(b=="on"){snap.snapResizeDragStart(d,this)}if(c=="on"){snap.setResizeEdgeBounds(d)}var a=true;widget.posScaleHelperInit(this,a)};widget._dragResize=function(f,d){var c=account.get("snapToWidget");if(c=="on"){snap.resizeToWidgEdges(d,this)}var b=widget._resize(widget._resizeEl,widget._resizePageId,false,true);var a=widget._resizeEl[0].id,h=document.querySelector(".canvasObject.active");if(storage.get(a).blur){widget.blurLayers[a]=widget.blurLayers[a]||widget.renderBlurLayer(a,h.id);widget.setBlurBG(widget._resizeEl[0])}};widget._dragResizeStop=function(b,a){fluid.command.create("resize",{id:widget._resizeEl.attr("id"),pageId:widget._resizePageId,fromTLWH:widget._resizeFromTLWH}).dispatchTo("fluid.controllers.widget");$("#widgPosDragHelper").remove();snap.removeAlignGuides();widget._resizeEl=widget._resizePageId=widget._resizeLockTos=null;storage.commitCache()};widget._resizeTextContainer=function(b){var a=b.find(".widgetText");if(a.length>0&&a.length<2){widget.verticalAlign(b)}else{return}};widget._resize=function(e,h,c,j){var k=true;var a=e.attr("id");var f=widget.get(a);h=h?h:widget.getPageOf(a);var b=$("#"+h);var l=[0,0,b.width(),b.height()];var c=c||[parseInt(e.css("top")),parseInt(e.css("left")),e.width(),e.height()];var q=$.merge([],f.tlwh);delete widget._setTMPLVarsCache[a];var i=widget._setTMPLVars(a,f,l,false,k);var u=f.of||f.lockTo;var v=widget.get(u);var m=u==a;var n=l;if(!m){n=widget._setTMPLVars(u,v,l,false,k).absTLWH}var r=c[2]=="a"?"100%":c[2];var o=c[3]=="a"?"100%":c[3];q[2]=(q[2]=="a")?c[2]:q[2];q[3]=(q[3]=="a")?c[3]:q[3];q[2]=(typeof q[2]==="string")?utils.toPercent(r,n[2],5)+"%":r;q[3]=(typeof q[3]==="string")?utils.toPercent(o,n[3],5)+"%":o;var p=(typeof c[0]==="string")?utils.fromPercentString(c[0],n[3]):c[0]-n[0];var w=(typeof c[1]==="string")?utils.fromPercentString(c[1],n[2]):c[1]-n[1];p=(i.ca[0]=="b")?n[3]-p-o:p;w=(i.ca[1]=="r")?n[2]-w-r:w;p=(i.ca[0]=="c")?p+(o/2)-(n[3]/2):p;w=(i.ca[1]=="c")?w+(r/2)-(n[2]/2):w;q[0]=(typeof q[1]==="string")?utils.toPercent(p,n[3],5)+"%":p;q[1]=(typeof q[1]==="string")?utils.toPercent(w,n[2],5)+"%":w;if(i.segments||f.segment){q[0]=(f.tlwh[0]=="a")?"a":q[0];q[1]=(f.tlwh[1]=="a")?"a":q[1];q[2]=(f.tlwh[2]=="a")?"a":q[2];q[3]=(f.tlwh[3]=="a")?"a":q[3]}widget.set({tlwh:q},a);if(!j){i=widget._setTMPLVars(a,f,l,false,false)}else{if(f.upload&&f.upload==="y"){i.simpleUploadResize=true}}widget._drawCanvasOrImage(e,i);if(i.segments){segData=widget._setupSegments(f);widget._updateSegments(f,segData,j?{redraw:"img"}:{redraw:"all"})}else{if(f.segment){var s=widget.get(f.lockTo);segData=widget._setupSegments(s);widget._updateSegments(s,segData,j?{redraw:"img"}:{redraw:"seg",segId:a})}else{var t=widget._resizeLockTos||widget.getLockTos($("#"+a));widget._updateDependents(a,l,t)}}updateTLWH();var d=true;widget.posScaleHelperDrag(false,d);return q};widget._updateDependents=function(a,e,f){function d(){var i=$(this);var h=i.attr("id");var p=widget.get(h);var l={};var j=widget._setTMPLVars(h,p,e,false,true);var k=widget._resizeAxis||"br";var n=j.ca;var o=false;var m=false;o=true;l.top=j.absTLWH[0];l.left=j.absTLWH[1];delete widget._setTMPLVarsCache[h];if((typeof j.tlwh[2]==="string"&&(k.indexOf("e")>-1||k.indexOf("w")>-1))||(typeof j.tlwh[3]==="string"&&(k.indexOf("n")>-1||k.indexOf("s")>-1))){m=true;l.width=j.absTLWH[2];l.height=j.absTLWH[3];delete widget._setTMPLVarsCache[h]}i.css(l);if(o||m){widget._updateDependents(h,e,f)}if(m){}}var f=f||widget._resizeLockTos||widget.getLockTos($("#"+a));var c=true;var b=widget.getDependents(a,f,c);b.each(d)};widget._makeResizable=function(a){$(a).each(function(){$t=$(this);var d=$t.attr("id");var c=storage.get(d);if(!c){return}if(c.upload=="y"){c.r="y"}if(c.r){var b="n, e, s, w, ne, nw, se, sw";if(c.r=="h"){b="e,w"}else{if(c.r=="v"){b="n,s"}else{if(c.r=="se"){b="se"}}}if($t.data("resizable")){$t.resizable("enable")}else{$t.resizable({handles:b,start:widget._dragResizeStart,grid:false,resize:fluid.util.debounce(widget._dragResize,17),stop:widget._dragResizeStop})}if(c.r=="h"){$t.find(".ui-resizable-e").addClass("ui-resizable-eO");$t.find(".ui-resizable-w").addClass("ui-resizable-wO")}if(c.r=="v"){$t.find(".ui-resizable-n").addClass("ui-resizable-nO");$t.find(".ui-resizable-s").addClass("ui-resizable-sO")}}})};widget._makeNonResizable=function(b){var a=b?b:$("#canvasPages .pageWidget.ui-resizable");a.resizable("disable")};widget.toggleUploadFit=function(e){var j=storage.get(e),h=widgets.summary[j.data],b=document.querySelector(".canvasObject.active").id,f=storage.get(b),a={width:h.wh[0],height:h.wh[1],},i=utils.getFitSize({object:a,frame:f}),c=j.tlwh,d;if(i.width===j.tlwh[2]&&i.height===j.tlwh[3]){d=[j.tlwh[0],j.tlwh[1],h.wh[0],h.wh[1]]}else{d=[j.tlwh[0],j.tlwh[1],i.width,i.height]}fluid.command.create("resize",{id:e,pageId:b,fromTLWH:c,toTLWH:d}).dispatchTo("fluid.controllers.widget")};widget.toggleSelectedUploadsFit=function(){fluid.util._.each(document.querySelectorAll(".canvasObject .ui-selected"),function(b){if(storage.get(b.id).upload==="y"){try{widget.toggleUploadFit(b.id)}catch(a){}}})};widget.uploadFullSize=function(c){var a=document.querySelector(".canvasObject.active").id,e=storage.get(c),b=widgets.summary[e.data],f=e.tlwh,d=[f[0],f[1],b.wh[0],b.wh[1]];fluid.command.create("resize",{id:c,pageId:a,fromTLWH:f,toTLWH:d}).dispatchTo("fluid.controllers.widget")};widget.fit100=function(){fluid.util._.each(document.querySelectorAll(".canvasObject .ui-selected"),function(b){if(storage.get(b.id).upload==="y"){try{widget.uploadFullSize(b.id)}catch(a){}}})};widget.uploadFit=function(e,d){var h=storage.get(e),c=widgets.summary[h.data],b=document.querySelector(".canvasObject.active").id,f=storage.get(b),a={top:h.tlwh[0],left:h.tlwh[1],bottom:h.tlwh[0]+h.tlwh[3],right:h.tlwh[1]+h.tlwh[2]};sourceSize={width:c.wh[0],height:c.wh[1],},fitSize=utils.getFitSize({object:sourceSize,frame:f,expand:d}),originalTLWH=h.tlwh,newTLWH=[h.tlwh[0],h.tlwh[1],fitSize.width,fitSize.height];newTLWH[0]=typeof fitSize.top==="number"?fitSize.top:newTLWH[0];newTLWH[1]=typeof fitSize.left==="number"?fitSize.left:newTLWH[1];fluid.command.create("resize",{id:e,pageId:b,fromTLWH:originalTLWH,toTLWH:newTLWH}).dispatchTo("fluid.controllers.widget")};widget.fitExpand=function(){fluid.util._.each(document.querySelectorAll(".canvasObject .ui-selected"),function(b){if(storage.get(b.id).upload==="y"){try{widget.uploadFit(b.id,true)}catch(a){}}})};widget.fitShrink=function(){fluid.util._.each(document.querySelectorAll(".canvasObject .ui-selected"),function(b){if(storage.get(b.id).upload==="y"){try{widget.uploadFit(b.id)}catch(a){}}})};widget.libraryDrag=function(b,a){widget._libraryDrag(b,a,this)};widget.libraryDragStart=function(b,a){if($("#pageMenu").is(":visible")){page.hideOptionsMenu()}};widget.dragWidgetCreate=function(b,a){widget._dragCreate(b,a,this)};widget.dragWidgetStart=function(b,a){if(project.readOnly()){return false}page.hideOptionsMenu();widget._dragStart(b,a,this);widget.posScaleHelperInit(this)};widget.dragWidget=function(b,a){widget._drag(b,a,this)};widget.dragWidgetStop=function(b,a){if(project.readOnly()){return false}widget._dragStop(b,a,this)};widget._dragSelection=null;widget._originalDragPos=null;widget._topDiff=null;widget._leftDiff=null;widget._dragCreate=function(c,a,b){if(project.get("currentZoom")!=1){$(b).draggable("disable")}};widget.posScaleHelperInit=function(e,c){var a=-35;if(c){var d=$(e)}else{if(widget._moveMultiSelection==true){var d=$("#multiSelBox")}else{if($(e).hasClass("rootWidget")){var d=$(e)}else{var b=$(e).attr("data-lockTo");var d=$("#"+b)}}}$("#tmplPosHelper").tmpl({topAlign:a}).appendTo(d)};widget.posScaleHelperDrag=function(c,d){if(c){$("#TLindicator").show();return}if(d){var b=15;var a=-35;$("#WHindicator").show();$("#widgPosDragHelper").css("top",a)}};widget.getRootsForDrag=function(c){widget._activeGroup=false;var b=project.get("widgetGroups");var a=widget.getRoots(c);if(b){var d=group.createSelArray(a,b);if(d.length==1&&d[0].charAt(0)=="g"){widget._activeGroup=d[0]}a.each(function(){var m=$(this).attr("id");for(var k in b){var e=b[k];var l=e.indexOf(m);if(l>-1){for(var f=0;f<e.length;f++){var h=$("#"+e[f]);a=a.add(h)}}}})}return a};widget._moveMultiSelection=null;widget._dragStart=function(h,d,f){var f=$(f);widget.draggingFromId=f.parents(".screen").attr("id");widget._originalDragPos=f.offset();widget._dragStartSelection=[];$(".ui-selected").each(function(){widget._dragStartSelection.push($(this).attr("id"))});f.parents(".screen").addClass("dragging-wdg-from");if(f.hasClass("ui-selected")||$("#"+f.attr("data-lockto")).hasClass("ui-selected")){f=f.add($(".ui-selected"))}var a=widget.getRootsForDrag(f);widget.resetSelection();widget._moveMultiSelection=(a.length>1)?true:null;widget.select(null,a);var b=account.get("gridStatus");var c=account.get("snapToWidget");if(b=="on"||c=="on"){snap.setMovementConstant(f,d,b);if(c=="on"){grid.getPageProps();snap.selectedWidgSnapPos();snap.multiSelOffset(widget._originalDragPos)}}contextMenu.place("hide");page.displayMenu(false);$("#canvasLinks").hide();widget._dragSelection=$([]);$(a).not(".backgroundWidget").each(function(){var e=$('[data-lockto="'+$(this).attr("data-lockto")+'"]');widget._dragSelection=widget._dragSelection.add(e)});widget._dragSelection.each(function(){var e=$(this);e.data("offset",e.offset());e.addClass("ui-draggable-dragging");e.resizable("option","disabled",true)})};widget.lastTime=null;widget._drag=function(j,m,k){k=$(k);var l=k.data().draggable?k.data().draggable.position.top:parseInt(k.css("top"),10);var h=k.data().draggable?k.data().draggable.position.left:parseInt(k.css("left"),10);var p=account.get("snapToWidget");if(p=="on"){snap.snapToWidgEdges(k,l,h)}var n=account.get("gridStatus");if(n=="on"){snap.widgetSnapToGrid(k,l,h)}function o(){var e=$(this).data("offset");$(this).css({top:e.top+f+"px",left:e.left+i+"px"})}var f=m.position.top-widget._originalDragPos.top;var i=m.position.left-widget._originalDragPos.left;var d=(widget._dragSelection).not(k);$.each(d,o);updateTLWH();var b=true;widget.posScaleHelperDrag(b);intersectTrash(k,j);var a=document.querySelectorAll(".pageWidget.ui-selected"),c=((c=document.querySelector(".canvasObject.active"))&&c.id);fluid.util._.forEach(a,function(q){var e=q.id;if(storage.get(e).blur){widget.blurLayers[e]=widget.blurLayers[e]||widget.renderBlurLayer(e,c.id);widget.setBlurBG(q)}})};widget._dragStop=function(h,d,f){snap.removeAlignGuides();if(intersectTrash(f,h)){widget.del(".ui-selected");$("#trash").removeClass("droppableStyle");widget._dragSelection=null;return}function i(){var e=$(this);e.removeClass("rememberSelected");(widget._moveMultiSelection==true)?e.resizable("option","disabled",true):e.resizable("option","disabled",false);e.removeClass("ui-draggable-dragging")}var b=$("#canvasPages .ui-selected");var a=widget.getRoots(b);var c=a.parents(".screen").attr("id");$("#"+widget.draggingFromId).removeClass("dragging-wdg-from");fluid.command.create("move",{id:a.map(function(){return $(this).attr("id")}).get(),fromPage:widget.draggingFromId,toPage:c}).dispatchTo("fluid.controllers.widget");group.select(a);widget.draggingFromId=null;widget.selectMulti=false;if(widget._dragStartSelection.length){$.each(widget._dragSelection,i)}else{setTimeout(function(){b.click()},50)}$("#widgPosDragHelper").remove();$("#canvasLinks").fadeIn(200);if(widget._dragStartSelection.length){contextMenu.place()}else{page.displayMenu();$(".ui-selected").removeClass("ui-selected")}widget._dragSelection=null};widget._savePosition=function(b){function a(d,e){var f=$(e).attr("id");var h=widget.get(f);var c=$.extend([],h.tlwh);c[0]=parseInt($(e).css("top"));c[1]=parseInt($(e).css("left"));widget.set({tlwh:c},f)}$.each(b,a)};widget._libraryDrag=function(c,a,b){b=$(b);b.data().draggable.position.top-=3;b.data().draggable.position.left-=3;if(b.parents("#uploadTabs").length==1){intersectTrash($(a.helper),c)}};widget.moveTo=function(c,a){var b=widget.get(c);widget._moveBy(c,b,[a[0]-b.tlwh[0],a[1]-b.tlwh[1]])};widget._moveBy=function(d,c,a,b){$('[data-lockto="'+d+'"]').css({"top":"+="+a[0],"left":"+="+a[1]});link.update($("#"+d).parent(".screen"));if(!(b&&b.debounce)){c.tlwh[0]+=a[0];c.tlwh[1]+=a[1];widget.set({tlwh:c.tlwh},d)}else{if(!widget.adjustWdgPosDebounced){widget.adjustWdgPosDebounced=fluid.util._.debounce(widget.adjustWdgPos,500)}widget.adjustWdgPosDebounced(d)}};widget.adjustWdgPos=function(d){var a=widget.getRoots($(".ui-selected")),b=[],c=[];a.each(function(){var e=$(this),f;f=widget.get(e.attr("id"));c.push([parseInt(e.css("top")),parseInt(e.css("left"))]);b.push([f.tlwh[0],f.tlwh[1]])});fluid.command.create("move",{id:a.map(function(){return $(this).attr("id")}).get(),fromPage:widgetsCache[d].pageId,toPage:widgetsCache[d].pageId,fromPos:b,toPos:c,skipViewAdjustment:true}).dispatchTo("fluid.controllers.widget")};widget.nudge=function(a){return widget._nudge(a)};widget._nudge=function(d){var b=d.keyCode;var f=(d.shiftKey||d.ctrlKey)?10:1;storage.cacheStart();var c=$(".ui-selected").not(".backgroundWidget");var a=widget.getRoots(c);if(c.children("textarea").length>0){return false}a.each(function(){var h=$(this).attr("id");var e=[0,0];switch(b){case"left":case 37:e[1]=-f;break;case"up":case 38:e[0]=-f;break;case"right":case 39:e[1]=+f;break;case"down":case 40:e[0]=+f;break}widget._moveBy(h,widget.get(h),e,{debounce:true})});updateTLWH()};widget._changePage=function(f,h,e){var f=f.not(".backgroundWidget");var b=widget.getLockTos(f);var d=$.extend([],page.get(h,"widgets"));var c=$.extend([],page.get(e,"widgets"));b.each(function(){var j=$.inArray($(this).attr("id"),d);if(j==-1){return true}d.splice(j,1);c.push($(this).attr("id"))});page.update({widgets:d},h);page.update({widgets:c},e);var a=page.get(e,"y")-page.get(h,"y");var i=page.get(e,"x")-page.get(h,"x");b.detach().css({top:"-="+a,left:"-="+i}).appendTo($("#"+e).find(".widgetHolder"));if(widget._dragStartSelection.length){page.activate($("#"+e),false,"wdgDrag")}else{page.activate($("#"+e),true);setTimeout(widget.resetSelection,300)}group.drawExisting()};var ajax={maxSyncRetryCount:2,submit:function(i){var h=$(this);var j=h.attr("id");var c=h.hasClass("createForm");var f=h.hasClass("shareSendMail");if(j!="feedbackForm"&&!c&&!(f&&$(".shareSend").attr("disabled")===undefined)&&j!=="upgradeForm"&&j!=="errorContact"){return false}if(h.find(":submit").hasClass("inactive")){return false}var b=h.find("input").not(":hidden, :submit").length;var a=h.find(".formCorrect").length;if(f){fluid.main.fire("beforeShareMail")}if(b==a){h.find(":submit").val("Sending...").removeClass("accept").addClass("inactive")}else{h.find(":submit").removeClass("accept").addClass("inactive")}try{tracker.record("Submitting Form",1,j,i)}catch(i){}var d=h.serialize();$.ajax({url:"./index.php",type:"POST",data:d,complete:ajax.complete,error:ajax.error});return false},syncUp:function(d,h,i,j,a){if(i){account.syncPending[i]=h}else{if(h=="projectSync"||h=="imageSync"){var k="Empty object ID. Type: "+h+".";try{please.show.me.call.stack()}catch(f){if("stack" in f){k+=" Call stack: "+f.stack}}throw k}}var c=JSON.stringify(d);var b={t:h,data:c,objectId:i};$.ajax({url:"./index.php",type:"POST",data:b,success:function(e,n,m){var l=JSON.parse(e);if(l.r=="f"&&l.t=="retry"){if(a===undefined){a=ajax.maxSyncRetryCount}if(a>0){ajax.syncUp(d,h,i,j,--a);return}}ajax.syncSuccess(e,n,m,h,i);if($.isFunction(j)){j(e)}},error:function(e,m,l){ajax.syncError(e,m,l,h,i)},complete:function(e,l){ajax.syncComplete(e,l,h,i)}})},syncDown:function(b,d,f,c){if($.isFunction(d)){c=arguments[2];f=arguments[1];d=false}var a=$.isArray(b);var e={t:"syncDown",objectId:a?b.join(","):b,multiple:a};if(d){e.unloaded=true}$.ajax({url:"./index.php",type:"POST",data:e,success:f,error:c||ajax.syncError})},snapshot:function(a,b,d){var c={t:"snapshot",objectId:a,type:b};$.ajax({url:"./index.php",type:"POST",data:c,success:d,error:ajax.snapshotError})},remove:function(a,c){var b={t:"remove",objectId:a};$.ajax({url:"./index.php",type:"POST",data:b,success:c,error:ajax.syncError})},restore:function(a,c){var b={t:"restore",objectId:a};$.ajax({url:"./index.php",type:"POST",data:b,success:c,error:ajax.syncError})},syncSuccess:function(f,h,e,d,b){switch(d){case"imageSync":var c=account.findUpload(b);if(c){tracker.record("ImageUploaded",1);c.upload.s=true}break;case"emailRegd":account.emailChecked(f);break;case"accountState":var a=$.parseJSON(e.responseText);if(a.r==="s"){$("body").addClass("signed-in")}else{$("body").removeClass("signed-in")}account.requireRefresh(a);break}},syncError:function(c,e,d,b,a){},syncComplete:function(c,d,b,a){if(a){delete account.syncPending[a]}},complete:function(b,d){var a;try{a=$.parseJSON(b.responseText)}catch(c){return false}switch(a.a){case"contact":upgrade.errorSubmitted(a);break;case"feedback":fluidMenu.feedbackAjaxResponse(a);break;case"login":account.login(a);break;case"previewMail":share.actionMailSent(a);break}return false},apiCall:function(c,h,a,e,d,f){var i={},j=e;if(e instanceof Blob){var b=new FormData();b.append("file",e);e=b;h="post";i={processData:false,contentType:false};account.syncPending[a]=c}$.ajax($.extend(i,{url:this.apiObjectUrl(c,a),type:h?h.toUpperCase():"POST",data:e,success:function(m,n,l){if(h=="post"){var k=account.findUpload(a);if(k){k.upload.s=true;account.uploadSynced(a,true)}}if($.isFunction(d)){d(m,a,j)}},error:function(k,m,l){ajax.syncError(k,m,l,c,a);if($.isFunction(f)){f(e,a,j)}},complete:function(k,l){delete account.syncPending[a]}}))},apiObjectUrl:function(b,c){var a="data/"+b+(c?"/"+c:"");return a},sendMessage:function(h,a,c,f,e){var d={from:h,subject:a,message:c};var b={t:"contact",data:JSON.stringify(d)};$.ajax({url:"index.php",type:"POST",data:b,success:function(j,k,i){if($.isFunction(f)){f()}},error:function(i,k,j){if($.isFunction(e)){e()}else{if($.isFunction(f)){f()}}}})},generalRequest:function(c,b,e,d){var a=d?$.extend({t:b},c):{t:b,data:JSON.stringify(c)};$.ajax({url:"index.php",type:"POST",data:a,success:function(h,i,f){if($.isFunction(e)){e(h)}},error:function(f,i,h){if($.isFunction(e)){e(null,h)}}})},userSettingsRequest:function(b,a,d,c){return ajax.generalRequest(b,a,d,c)}};jQuery.fn.liveDraggable=function(a){this.live("mouseover",function(){if(!$(this).data("initDraggable")){var b=$(this).hasClass("screen")&&$(this).hasClass("active");if((project.get("currentZoom")<1)||(!b)||((b)&&($(this).data("initSelectable")))){$(this).data("initDraggable",true).draggable(a)}canvas2.setPageContainment(this)}});return $(this)};jQuery.fn.liveSelectable=function(a){this.live("mouseover",function(){if(!project.readOnly()&&!$(this).data("initSelectable")){$(this).data("initSelectable",true).selectable(a)}});return $(this)};var storage={tempStorage:{},cachedUpdates:{},caching:false,lastUpdate:new Date().getTime(),get:function(b){if(storage.tempStorage[b]){return storage.tempStorage[b]}if(localStorage){var a=localStorage.getItem(b);if(a){storage.tempStorage[b]=JSON.parse(a);return storage.tempStorage[b]}}return null},tabSynchronisationCheckInterval:3000,lastTabSynchronisationCheck:null,set:function(j,f,a){var i=a==undefined?true:a;if(this.lastTabSynchronisationCheck+this.tabSynchronisationCheckInterval<new Date().getTime()){var c=localStorage.getItem("instanceId");if(c&&parseInt(c)!=g_instanceId){var h=localStorage.getItem("restoreMyInstanceId");if(h){storage._setItem("instanceId",g_instanceId);localStorage.removeItem("restoreMyInstanceId");return}utils.reloadWithMessage("tab");return}}if(typeof(f)=="string"){f=JSON.parse(f)}storage.lastUpdate=this.lastTabSynchronisationCheck=new Date().getTime();if((f)&&(i)){f.updated=storage.lastUpdate}var b=JSON.stringify(f);try{if(this.caching){this.cachedUpdates[j]=f}else{storage._setItem(j,b)}this.tempStorage[j]=f}catch(d){}fluidEvent.triggerEditor("storageChanged",{id:j,obj:f,timeUpdated:i})},remove:function(a){delete this.tempStorage[a];delete this.cachedUpdates[a];localStorage.removeItem(a)},cacheStart:function(){this.caching=true},commitCache:function(){if(!this.caching){return}this.caching=false;for(var a in this.cachedUpdates){this.set(a,this.cachedUpdates[a]);delete (this.cachedUpdates[a])}},setTempItem:function(b,a){this.tempStorage[b]=a},removeItem:function(a){localStorage.removeItem(a)},clear:function(){tempStorage={};cachedUpdates={};localStorage.clear()},_setItem:function(d,a){var c=false;while(!c){try{localStorage.setItem(d,a);c=true}catch(b){if(b&&(b.name=="QUOTA_EXCEEDED_ERR"||b.name=="NS_ERROR_DOM_QUOTA_REACHED"||b.code===22)){project.unloadOldest()}else{throw b}}}}};var project={isInitialized:false,isModified:false,activeProjectTooltip:"",autoPreviewTimeout:300000,inactiveProjectTooltip:"This project is inactive. Editing is disabled.",colors:{hStart:5,hEnd:210,s:"90%",l:"50%"},unloadedProps:["name","created","updated","active","preview"],recentProjectDays:15,lastProjectClosed:false,orient:function(h,b){var b=h!=undefined?$(h.target).attr("data-for"):b;var c=project.get("pageWH");var k=parseInt(c[0],10);var j=parseInt(c[1],10);var d=Math.min(k,j);var l=Math.max(k,j);c=b=="Portrait"?[d,l]:[l,d];project.set({orientation:b});project.set({pageWH:c});var a=project.get("pages");for(var f in a){page.update({orientation:b,width:c[1],height:c[0]},a[f])}$(".screen").each(page.resizeAfterOrient);hint.show("library");page.updateOptionsMenu()},isMultiOrientation:function(){var d=project.get("pages");var f=project.get("orientation");var c=false;for(var b=0,a=d.length;b<a;b++){var e=page.get(d[b],"orientation");if(e!=f){c=true;break}}return c},setNumber:function(j,f){if(j===undefined||f===undefined){j=0;f=0;var c=account.get("projectIds");for(var i=0,d=c.length;i<d;i++){var b=storage.get(c[i]);if(b){if(b.active===false){f++}else{j++}}}}$("#projectList h2").text("Active Projects"+(j>0?" ("+j+")":""));$("#inactiveProjectList h4").text("Inactive Projects"+(f>0?" ("+f+")":""));var h=(j+f);var e=h==1?"1 Project":h+" Projects";var a=$(".projectSettingsButton");$(".projectSettingsButton span").text(e);a.removeClass("buttonDisabled");$("#logout").removeClass("hidden")},hoverIn:function(){$(this).children(".foreground").addClass("projectHover");$(this).children(".popOutPage").addClass("popOutPageHover")},hoverOut:function(){$(this).children(".foreground").removeClass("projectHover");$(this).children(".popOutPage").removeClass("popOutPageHover")},_template:function(a,c){a["id"]=c;a["name"]=a.name||"New Project";a["date"]=fluid.i18n.formatDate(a.created);a["dateCreate"]=moment(a.created).format("YYYY/MM/DD HH:mm:ss");a["dateUpdate"]=moment(a.updated).format("YYYY/MM/DD HH:mm:ss");a["tooltip"]=a.active===false?project.inactiveProjectTooltip:project.activeProjectTooltip;a["nameLower"]=a.name.toLowerCase();var b=$("#tmplProjectThumb").tmpl(a);if(a.active===false){b.addClass("inactivePrj")}else{b.addClass("activePrj")}b.insertAfter("#projectAdd");projectSettings.updateThumbnail(c);delete a["dateCreate"];delete a["dateUpdate"];delete a["nameLower"];return b},hasWidgets:function(){var b=account.get("lastOpenProject");var c=storage.get(b);var a=false;if((c)&&(c.pages)){$.each(c.pages,function(d,f){var e=page.get(f,"widgets");if((e)&&(e.length>0)){a=true;return false}})}return a},hasLinks:function(){var a=project.get("links");if((a)&&(a.linkOrigin.length>0)){return true}return false},get:function(b){var a=account.get("lastOpenProject");if(b=="id"){return a}var c=storage.get(a);if(!c){if(b=="pages"){return[]}return null}return c[b]},set:function(a){var b=account.get("lastOpenProject");project.loadIfUnloaded(b,function(){var c=storage.get(b);if(!c){return}for(var d in a){c[d]=a[d]}storage.set(b,c)})},changeScreenSize:function(i,b){if(typeof b==="object"){var f=b[0];var a=b[1]}else{var f=parseInt($(".screenSize").filter(".width").val());var a=parseInt($(".screenSize").filter(".height").val())}var d=50;var h=50;if((isNaN(f))||(isNaN(a))){f=project.get("pageWH")[0];a=project.get("pageWH")[1];$(".screenSize").filter(".width").val(f);$(".screenSize").filter(".height").val(a)}else{f=f<d?d:f;a=a<h?h:a;f=parseInt(f,10);a=parseInt(a,10);project.set({"pageWH":[f,a]});var c=a>=f?"Portrait":"Landscape";project.orient(null,c)}hint.show("library");staticWidgets.zoomInBoundary()},save:function(){var b=project.get("id");var a=storage.get(b);a.updated=new Date().getTime();storage.set(b,a)},dragStart:function(o,j){var d=$(this).hasClass("inactiveProject");var c=$("#projects").outerHeight();var a=$("#projects").closest(".viewport").height();var m=$("#projects").parent().position().top;var e=d?$("#projectList"):$("#inactiveProjectList");var p=e.outerHeight();var k=e.children("h2, h3, h4, h5");var l=k.outerHeight(true)||50;var n=d?m+p:p-c+a-m;var s=n<l;var f=0;if(s){var q=d?-1:1;f=q*(n-l-k.position().top);if(d){f+=2;k.css({"-webkit-transform":"translate(0, "+(p-l-8)+"px)","-moz-transform":"translate(0, "+(p-l-8)+"px)"});e.children(".addProject, .project").css({"-webkit-transform":"translate(0, -"+(k.outerHeight()||0)+"px)","-moz-transform":"translate(0, -"+(k.outerHeight()||0)+"px)"})}e.removeClass("bouncing").css({"top":n<0?n+4+"px":"","z-index":1}).addClass("bouncing scrolledIntoView");var b=parseInt(e.css("-webkit-transition-duration"));var i=n>=0?n/l:1;b=b*i+(b>1?"ms":"s");e.css({"top":f+"px","-webkit-transition-duration":b,"-moz-transition-duration":b,"-webkit-animation-delay":b,"-moz-animation-delay":b});var h=$("#projects .project").first().outerHeight(true)||0;var r=f-q*h;$("#projects").data("popoutAreaHeight",h).data("popoutTranslateTop",r)}$("#projects").data("showDest",s)},drag:function(b,j){var i=$(this);var h=$("#fluidDropdown .viewport");if($("#projects").is(":visible")&&utils.isMouseOver(b,h)){var a=$(this).hasClass("inactiveProject");var f=a?$("#projectList"):$("#inactiveProjectList");var e=$("#projects");var k=e.data("popoutAreaHeight");var d=e.data("popoutTranslateTop");var c=utils.relativeMousePos(b,h).top;if(e.data("showDest")&&((a&&c<k)||(!a&&h.height()-c<k))){f.removeClass("bouncing").css({"top":d+"px","-webkit-transition":"top 0.2s ease-in-out","-moz-transition":"top 0.2s ease-in-out"}).bind("webkitTransitionEnd",function(){f.unbind("webkitTransitionEnd")})}project._updateDroppables(b,i)}else{$("#projectList, #inactiveProjectList").removeClass("hover")}if(intersectTrash(i.data().draggable.helper)==true){$("#trash").addClass("droppableStyle")}else{$("#trash").removeClass("droppableStyle")}},_updateDroppables:function(c,b){var a=[{elem:$("#projectList"),accept:".inactiveProject"},{elem:$("#inactiveProjectList"),accept:".project:not(.inactiveProject)"}];$.each(a,function(d,f){var e=f.elem;if(utils.isMouseOver(c,e)&&b&&b.is(f.accept)){if(!e.hasClass("hover")){e.addClass("hover")}}else{if(e.hasClass("hover")){e.removeClass("hover")}}})},dragStop:function(a){$("#projectList, #inactiveProjectList").removeClass("hover");$("#projects").data("showDest",false);var b=$(this).hasClass("inactiveProject")?$("#projectList"):$("#inactiveProjectList");b.removeClass("bouncing").animate({"top":"0px"},200,function(){b.removeClass("scrolledIntoView").children("h2, h3, h4, h5, .addProject, .project").removeAttr("style")});$("#trash").removeClass("droppableStyle")},dropToActive:function(b,a){var a=a==undefined?false:true;var c=false;if(fluid.main.fire("project.beforeActivate")&&!a){if(project.isOpen(b)){notification.removeAll("alert","projectInactive")}notification.removeAll("alert","projectLimit");project._handleActiveInactiveDrop(b,false);tracker.record("dropActive",1);projectSettings.getItemById(b).removeClass("inactivePrj").addClass("activePrj");projectSettings.displayStatus(true);projectSettings.applyFilter();$("#canvasPages .pageWidget").draggable("option","disabled",false);c=true}page.displayMenu();setTimeout(hint.restart,600);$("#projectList, #inactiveProjectList").removeClass("hover");return c},dropToInactive:function(a){var b=false;project._handleActiveInactiveDrop(a,true);notification.removeAll("alert","projectLimit");tracker.record("dropInactive",1);hint.cleanup();page.displayMenu(false);$("#projectList, #inactiveProjectList").removeClass("hover");projectSettings.getItemById(a).addClass("inactivePrj").removeClass("activePrj");projectSettings.applyFilter();$("#canvasPages .pageWidget").draggable("option","disabled",true);b=true;return b},_handleActiveInactiveDrop:function(b,a){project.loadIfUnloaded(b,function(){var c=storage.get(b);c.active=!a;c.updated=new Date().getTime();storage.set(b,c);if(b==account.get("lastOpenProject")){project.isModified=true}project.sync(b);project.setNumber()})},updateInactiveProjectList:function(){var h=$("#inactiveProjectList");var f=h.find(".inactiveProject");var b=h.children(".promptContainer");var a=b.css("display")!="none";var e=b.is(":visible");if(f.size()==0){if(!a){if(e){b.fadeIn(300)}else{b.show()}}}else{if(a){if(e){b.fadeOut(300)}else{b.hide()}}}var c=h.find(".projectPlaceholder");var d=c.size();c.hide().slice(-1*(d-f.size()%d)).fadeIn(300);h.removeWhitespace()},isEmpty:function(b){if(b===undefined||b===null){b=account.get("lastOpenProject")}var a=storage.get(b);return !a||!a.pages||a.pages.length==0},unbundle:function(a,b){b(a)},checkIntegrity:function(b){var e=storage.get(b);if(e.unloaded){delete e.unloaded}project.save();if(!e){account.logout();localStorage.setItem("postloadMessage","loginAgain");location.reload()}if(!project.get("canvasWidth")){project.set({canvasWidth:24004})}if(!project.get("canvasHeight")){project.set({canvasHeight:16004})}if(!project.get("canvasPosX")&&project.get("canvasPosX")!==0){project.set({canvasPosX:1000})}if(!project.get("canvasPosY")&&project.get("canvasPosY")!==0){project.set({canvasPosY:1000})}if(!project.get("currentZoom")){project.set({currentZoom:0.25})}if(typeof project.get("lastTransition")==="undefined"){project.set({"lastTransition":"pop"})}if(typeof project.get("pageWH")==="undefined"){project.set({"pageWH":[320,480]})}if(typeof project.get("orientation")==="undefined"){project.set({"orientation":"Portrait"})}if(typeof project.get("defaultTransition")==="undefined"){project.set({"defaultTransition":"slide"})}if(typeof project.get("defaultGesture")==="undefined"){project.set({"defaultGesture":"tap"})}if(typeof project.get("widgetGroups")==="undefined"){project.set({"widgetGroups":{}})}if(!e.pages){e.pages=[]}if(!project.lastVisiblePages){project.lastVisiblePages={}}if(!storage.get(e.homepage)&&e.pages.length){project.set({"homepage":e.pages[0]})}for(var k=0;k<e.pages.length;k++){var c=storage.get(e.pages[k]);if(!c){e.pages.splice(k,1);k--;continue}if(c.x>e.canvasWidth){page.update({x:c.x/4},e.pages[k])}if(c.y>e.canvasHeight){page.update({y:c.y/4},e.pages[k])}if(!c.height){page.update({height:480},e.pages[k])}if(!c.width){page.update({width:320},e.pages[k])}if(!c.orientation){page.update({orientation:"Portrait"},e.pages[k])}if(c.width!==~~c.width){page.update({width:~~c.width},e.pages[k])}if(c.height!==~~c.height){page.update({height:~~c.height},e.pages[k])}var h,a;for(var f=0;f<c.widgets.length;f++){h=storage.get(c.widgets[f]);if(!h){page.removeWidget(e.pages[k],c.widgets[f]);continue}else{if(h.upload&&h.upload==="y"){a=storage.get(h.data);if(!a&&account.syncedUploads){storage.remove(c.widgets[f]);page.removeWidget(e.pages[k],c.widgets[f]);continue}}}if(!widgetsCache[c.widgets[f]]){widgetsCache[c.widgets[f]]={}}widgetsCache[c.widgets[f]].pageId=e.pages[k]}if(!pagesCache[e.pages[k]]){pagesCache[e.pages[k]]={}}}var m=project.get("links");if(!m){m={linkCanvId:[],linkDest:[],linkOrigin:[],linkType:[],transType:[],triggerType:[]};e.links=m}if(typeof m.transType==="undefined"){m.transType=(m.linkType).slice(0);for(var k in m.transType){m.transType[k]=(m.linkType[k]=="ahref")?project.get("defaultTransition"):null}}if(typeof m.triggerType==="undefined"){m.triggerType=(m.linkType).slice(0);for(var k in m.triggerType){m.triggerType[k]=(m.linkType[k]=="ahref")?project.get("defaultGesture"):null}}var l=false;var d;for(var k=0;k<m.linkDest.length;k++){l=false;if(!pagesCache[m.linkDest[k]]){m.linkCanvId.splice(k,1);m.linkDest.splice(k,1);m.linkOrigin.splice(k,1);m.linkType.splice(k,1);m.transType.splice(k,1);m.triggerType.splice(k,1);k--}else{if(!widgetsCache[m.linkOrigin[k]]){m.linkCanvId.splice(k,1);m.linkDest.splice(k,1);m.linkOrigin.splice(k,1);m.linkType.splice(k,1);m.transType.splice(k,1);m.triggerType.splice(k,1);k--}else{if(!pagesCache[m.linkDest[k]].linksTo){pagesCache[m.linkDest[k]].linksTo=[]}if(!pagesCache[m.linkDest[k]].linksFrom){pagesCache[m.linkDest[k]].linksFrom=[]}pagesCache[m.linkDest[k]].linksTo.push(m.linkCanvId[k]);d=widgetsCache[m.linkOrigin[k]].pageId;if(!pagesCache[d].linksFrom){pagesCache[d].linksFrom=[]}if(!pagesCache[d].linksTo){pagesCache[d].linksTo=[]}pagesCache[d].linksFrom.push(m.linkCanvId[k]);if(!pagesCache[d].pagesLinked){pagesCache[d].pagesLinked={}}if(!pagesCache[d].pagesLinked[m.linkDest[k]]){pagesCache[d].pagesLinked[m.linkDest[k]]=[]}pagesCache[d].pagesLinked[m.linkDest[k]].push(m.linkCanvId[k])}}}project.save()},bundle:function(a){var e={uploads:{}};var c=storage.get(a);e[a]=c;if(!c.pages){return e}for(var f=0;f<c.pages.length;f++){var b=storage.get(c.pages[f]);if(!b){continue}e[c.pages[f]]=b;for(var d=0;d<b.widgets.length;d++){var h=storage.get(b.widgets[d]);if(h==null){continue}e[b.widgets[d]]=h;if(h.upload){var l=h.title;if(!l){var k=storage.get(h.data);if(k){l=k.title||k.name}}e.uploads[h.data]={title:l,type:h.type,wh:h.wh}}}}return e},notifySyncAttempt:function(a,b){},sync:function(d,c){if(account.get("accType")=="New"){return}var b=account.get("lastOpenProject");if(d===undefined||d===null){d=b}function a(e){if($.isFunction(c)){c.call(null,e)}}project.loadIfUnloaded(d,function(){var h=d==b?project.isModified:true;project.notifySyncAttempt(h,d);if(h){var f=storage.get(d);f["saved"]=new Date().getTime();storage.set(d,f,false);var i=project.bundle(d);var e=$.extend(true,{},i);if(project.get("id")!==d&&project.lastVisiblePages&&project.lastVisiblePages[d]){e[d].visiblePages=project.lastVisiblePages[d]}else{e[d].visiblePages=project.getPagesInViewport()}dbStorage.set("projects",{id:d,data:e});ajax.syncUp(i,"projectSync",d,function(j){a({data:j,synced:true})})}else{a({synced:false})}if(d==b){project.setModified(false)}})},setName:function(b){var a=storage.get(b.id);if(!a){return}a.name=b.name;storage.set(b.id,a);if(account.get("lastOpenProject")==b.id){account.set({"name":b.name})}},deletePage:function(d){var c=null;var a=project.get("pages");for(var b=0;b<a.length;b++){if(a[b]==d){c=b;break}}a.splice(c,1);project.set({"pages":a});project._deletePageWidgets(d)},_deletePageWidgets:function(d){var c=storage.get(d);if(c){for(var b=0,a=c.widgets.length;b<a;b++){storage.remove(c.widgets[b])}}},sort:function(){var a=account.get("projectIds");var b=$.merge([],a);b.sort(function(d,c){var f=storage.get(d)?storage.get(d).created:0;var e=storage.get(c)?storage.get(c).created:0;return f-e});account.set({"projectIds":b})},load:function(){account.setLoadingStep(2);if($(".submenuLink .fluidSubmenuActive").length==0){$("#fluidDropdownSubmenu a:first").addClass("fluidSubmenuActive")}project.sort();var e=account.get("accType");var c=account.get("projectIds");var i=account.get("maxActiveProjects");var j=0;if(i!=0&&project.activeProjectCount()>i){j=project.activeProjectCount()-i}projectSettings.displayFrame();$("#fluidDropdown .project").not(".addProject").remove();$(".projectThumb").not("#projectAdd").remove();projectSettings.resetFilter();for(var h in c){var b=storage.get(c[h]);if(b){var a=b.active!==undefined?b.active:true;if(j>0&&a){b.active=false;j--}b=project.ensureHeaderIntegrity(b);var d=project._template(b,c[h]);if(a&&b.active===false){var f=c[h];project.loadIfUnloaded(f,function(){b=storage.get(f);b.active=false;storage.set(f,b);project.sync(f)})}}}project.setNumber();if(userSettings.isOpen){projectSettings.open()}this.updateInactiveProjectList()},ensureHeaderIntegrity:function(a){if(!a.name){a.name="New Project"}return a},windowClose:function(){storage.commitCache();if(project.isEmpty()==false){project.sync()}},windowClose2:function(){alert("Close!");storage.commitCache();if(project.isEmpty()==false){project.sync()}},close:function(b){if(!project.lastVisiblePages){project.lastVisiblePages={}}project.lastVisiblePages[project.get("id")]=project.getPagesInViewport();fluid.command.history.reset();fluid.command.create("hideButton").dispatchTo("fluid.controllers.timeline");page.detachFrame();var a=account.get("lastOpenProject");$("#canvas").removeClass("loaded");$(".project").removeClass("open");$(".projectThumb").removeClass("open");$(".screen").remove();$("#canvasLinks").empty();if($("#dragCanvas").length==0){$("#tmplDragCanv").tmpl({}).appendTo($("#canvas"))}hint.hide();if(a&&storage.get(a)&&!project.isEmpty(a)&&!project.lastProjectClosed){project.sync(null,b)}project.lastProjectClosed=true},open:function(a,c){$("#canvas").removeClass("loaded");project.afterOpenedCallback=c;project.openStartTime=new Date().getTime();project.uploadPreload=true;project.useLocalDb=true;fluid.command.history.reset();account.setLoadingStep(3);if($("#previewHolder").is(":visible")){preview.close()}$("#pagePreview",page.frame||document).css("opacity",0);notification.removeAll("alert",["projectInactive","projectLimit"]);if(!project.lastProjectClosed){project.close()}if(a=="last"){a=account.get("lastOpenProject");var b=storage.get(a);if(!a||!b){a=project.add("","New Project")}}account.set({lastOpenProject:a});project.lastProjectClosed=false;if(project.useLocalDb){if(!project.preloader){project.preloader=new fluid.projectPreloader()}project.preloader.firstPreload(a,function(){})}project.loadIfUnloaded(a,project.afterLoaded.bind(this,a))},drawThumbnail:function(e){var d=$("#profile");d.find(".projectThumb").remove();var b={id:"opened_"+e,name:project.get("name")};var f=$("#tmplProjectThumb").tmpl(b);f.addClass(project.get("active")===false?"inactivePrj":"activePrj");var c=project.get("preview");if(!project.get("pages")||project.get("pages").length===0){f.append('<div class="project-thumb">Project empty</div>')}else{if(c&&c.src){f.append('<img class="project-thumb" src="'+c.src+'">')}}var a=$("#tmplProjectSettingsFrame").tmpl();$(".selectedProjectName",a).text(f.attr("title"));$(".projectOptionsButtonSettings",a).click(fluid.util.debounce(function(){projectSettings.lastSelectedId=project.get("id");project.sync();projectSettings.goToSettingsUpdate();userSettings.open(null,$("#projectSettingsPanelSettings"))},500));a.css({opacity:0.75,display:"block"}).appendTo(f);f.addClass("selectedPrj");d.prepend(f);f.click(function(){fluidMenu.hide()})},afterLoaded:function(e){if(storage.get(account.get("id")).email.indexOf("@")===-1){$("#profile .projectThumb").remove()}else{project.drawThumbnail(e)}widgetsCache={};pagesCache={};project.checkIntegrity(e);var b=project.get("canvasPosX");var f=project.get("canvasPosY");var c=project.get("canvasWidth");var a=project.get("canvasHeight");var d=$("#canvas");d.parents("#viewport").get(0).scrollLeft=-b;d.parents("#viewport").get(0).scrollTop=-f;canvas2.zoom({newZoom:0.25,currentZoom:1,duration:0,centerY:f,centerX:b},function(){d.data("lastOutX",b).data("lastOutY",f).css({width:parseInt(c/4,10),height:parseInt(a/4,10),border:"10px solid #ffffff"});d.parents("#viewport").get(0).scrollLeft=-b;d.parents("#viewport").get(0).scrollTop=-f;project.preparePages(e)})},preparePages:function(b){link.newLinks=true;if(project.uploadPreload){project.projectLoadedTime=new Date().getTime();project.preloader.projectLoaded(function(){project.onPagesPrepared(b)})}else{var c=project.getPagesInViewport("init");for(var a=0;a<c.length;a++){page.draw(c[a],"init")}project.onPagesPrepared(b)}},onPagesPrepared:function(c){canvas2.updatePages(canvas2.updateLinks);projectSettings.getItemById(c).addClass("open");document.title=project.get("name")+" :: Fluidui.com";var b=false;$(".pageWidget").draggable("disable");$("#startMenu").delay(300).fadeIn(300);project.isInitialized=true;if(project.readOnly()){fluid.command.create("hideButton").dispatchTo("fluid.controllers.timeline");if(account.canAddProjects()){notification.add("alert",'This project is inactive and read-only. Please <span class="inlineLink alertLinkToSettings close">activate the project</span> in order to edit it.',{scope:"projectInactive",permanent:true})}else{notification.add("alert",account.alerts.projectLimitHit.onOpenInactive,{scope:"projectInactive",permanent:true})}$("#canvasPages .pageWidget").draggable("option","disabled",true);fluidMenu.setCanvasFirstPage()}else{if(project.get("pages").length>0){fluidMenu.setCanvasFirstPage()}else{fluidMenu.setCanvasNoPages()}if(b){project.resetCanvas()}}if(!project.previewRenderer){project.previewRenderer=new fluid.wdgRenderer()}project.previewRenderer.renderProjectPreview(project.bundle(c),function(e,d){project.onPreviewReady(e,d,"projectopen")});if(account.get("loggedIn")=="yes"){$("#projectName").hide().html(project.get("name")).fadeIn(1000).delay(1000).fadeOut(500)}var a=project.get("pages");if(!a||a.length==0){fluidMenu.setCanvasNoPages(false)}project.setModified(false);if($.isFunction(project.afterOpenedCallback)){project.afterOpenedCallback.call(null);project.afterOpenedCallback=null}$("#canvasPages").fadeIn(300);$("#canvas").addClass("loaded");$("#"+project.get("homepage")).addClass("homePage");if(!project.readOnly()){hint.restart()}},onPreviewReady:function(h,b,e){$("#profile .projectThumb .loader-wrap").remove();var d=b.get(0).toDataURL();var a=storage.get(h);if(a.unloaded){return}a.preview={src:d};storage.set(h,a,false);projectSettings.updateThumbnail(h);if(project.get("id")===h){var c=project.get("pages");if(!c||c.length===0){$("#profile .project-thumb").remove();$("#profile .projectThumb").prepend('<div class="project-thumb">Project empty</div>')}else{$("#profile div.project-thumb").remove();var f=$("#opened_"+h+"Thumb img.project-thumb");if(f.length){f.attr("src",d)}else{$("#profile .projectThumb").prepend('<img class="project-thumb" src="'+d+'">')}}}if(e!=="autopreviewgen"){project.renderMissingPreviews(e!=="projectopen"?h:null)}if(e==="projectopen"){setTimeout(project.initAutoPreviewGen.bind(this,h),project.autoPreviewTimeout)}},initAutoPreviewGen:function(a){if(account.get("lastOpenProject")!==a){return}project.previewRenderer.renderProjectPreview(project.bundle(account.get("lastOpenProject")),function(c,b){project.onPreviewReady(c,b,"autopreviewgen")});setTimeout(project.initAutoPreviewGen.bind(this,a),project.autoPreviewTimeout)},renderMissingPreviews:function(c){var a=$(".projectThumb div.preview").not(".empty");var b;if(a.length>0){b=projectSettings.getSelectedId(a.eq(0).parents(".projectThumb").attr("id"));project.renderPreview(b)}},renderPreview:function(a,c){var b=c||"missingpreview";if(a===project.get("id")){$('<div class="loader-wrap"><img class="ajax-loader" src="img/ajax-loader.gif"/></div>').insertAfter("#profile .project-thumb")}project.loadIfUnloaded(a,function(){project.previewRenderer.renderProjectPreview(project.bundle(a),function(e,d){project.onPreviewReady(e,d,b);if(!project.isOpen(e)){project.sync(e,function(){project.unload(e)})}})})},isOpen:function(a){if(!a){a=this.id}return a==account.get("lastOpenProject")},addWithoutLimit:function(a){project._freeSlotForProject();project.add(a,null,true)},add:function(k,a,l){var l=l==undefined?false:true;if((!account.canAddProjects())&&(!l)){notification.removeAll("alert","projectLimit");notification.add("alert",account.alerts.projectLimitHit.onAddActive,{scope:"projectLimit","stopBuggingCallBack":project.addWithoutLimit});return false}var c;if(a==undefined){var a="";var i=storage.get("projectsCount");var d=account.get("projectIds");if(!i){i=d.length+1}else{i+=1}function j(e){d.forEach(function(n){if(storage.get(n).name===e){i+=1;e=j("Project "+i)}});return e}storage.set("projectsCount",i);a=j("Project "+i)}var f=new Date().getTime();c=utils.guid("p");var h={name:a,created:f,updated:f,canvasWidth:24004,canvasHeight:16004,canvasPosX:-2000*0.5,canvasPosY:-2000*0.5,currentZoom:0.25,orientation:"Portrait",pages:[],pageWH:[320,568],deviceModel:"iPhone5",lastTransition:"pop",defaultTransition:"pop",defaultGesture:"tap",links:{linkOrigin:[],linkDest:[],linkCanvId:[],linkType:[],transType:[],triggerType:[]}};account.addProjectId(c);storage.set(c,h);var m=$(".project:not(.addProject, .inactiveProject)");m.css({"-webkit-transform":"translate(-"+(m.outerWidth(true)||0)+"px,0px)","-moz-transform":"translate(-"+(m.outerWidth(true)||0)+"px,0px)"});var b=project._template(h,c);b.hide().fadeIn(800);m.css({"-webkit-transition":"all 0.20s ease-in-out","-moz-transition":"all 0.20s ease-in-out","-webkit-transform":"translate(0px,0px)","-moz-transform":"translate(0px,0px)"});setTimeout(function(){$(".project").css({"-webkit-transition":"none","-moz-transition":"none"})},200);project.setNumber();projectSettings.applyFilter();project.sync(c,false);return c},addPage:function(b){var a=project.get("pages")||[];a.push(b);project.set({"pages":a})},del:function(e,d){function c(){lib.handleUploadsRemovedFromPage(Object.keys(project.bundle(e).uploads),e,$("#project-"+e));function f(){$("#fluidDropdown #"+e).draggable("destroy").fadeOut(300,function(){var j=$(this).hasClass("inactiveProject");$(this).remove();if(j){project.updateInactiveProjectList()}});var h=account.get("projectIds");h.splice($.inArray(e,h),1);account.set({"projectIds":h});var i=project.unload(e);storage.remove(e);project.setNumber();projectSettings.displayFrame();projectSettings.getItemById(e).remove();projectSettings.refreshListHeader();if(d){d.call(null,i)}}ajax.remove(e,f)}var b=project.isOpen(e);if(b){project.close()}var a=storage.get(e);a.removed=true;a.updated=new Date().getTime();storage.set(e,a);if(project.isEmpty(e)){c()}else{project.sync(e,c)}notification.removeAll("alert","projectAction");notification.add("alert","Your project has been deleted.  In case you want to restore, please visit the bin...",{scope:"projectAction"});$("#trash").show().css({opacity:1})},_deleteProjectPages:function(e){var d=storage.get(e);if((d)&&(d.pages!=undefined)&&!d.unloaded){for(var b=0,a=d.pages.length;b<a;b++){var c=d.pages[b];project._deletePageWidgets(c);storage.remove(c)}}},rename:function(b){var c=userSettings.isOpen?projectSettings.lastSelectedId:$(b.target).closest(".project").attr("id");var a=$(b.target).val();project.setName({name:a,id:c});project.sync(c,false);if(project.isOpen(c)){document.title=project.get("name")+" :: Fluidui.com"}$(".title","#"+c).val(a);$(".selectedProjectName").text(a);projectSettings.getItemById(c).attr({"data-name":a.toLowerCase(),title:a,alt:a});fluid.main.trigger("projectNameChanged");return false},activeProjectCount:function(){var d=0;var c=account.get("projectIds");for(var b=0,a=c.length;b<a;b++){if(storage.get(c[b])&&storage.get(c[b]).active!==false){d++}}return d},getLatestActiveProject:function(){var c;var b=account.get("projectIds");for(var a=b.length-1;a>=0;a--){if(storage.get(b[a]).active!==false){c=b[a];break}}return c},readOnly:function(){return project.get("active")===false},setModified:function(a){if(!project.readOnly()){var b=a===false?false:true;project.isModified=b}else{project.isModified=false}},storageChangeProjectHandler:function(b,a){if((!a)||(!a.timeUpdated)){return}var c=a.id.substr(0,1);if((c=="x")||(c=="w")||(c=="p")){if((c=="p")&&(a.id!=account.get("lastOpenProject"))){return}project.setModified(true)}},unload:function(c,a){if(!a){a=storage.get(c)}if(this.previewRenderer){this.previewRenderer.onProjectUnloaded(c)}if(!a.unloaded){project._deleteProjectPages(c);for(var b in a){if(a.hasOwnProperty(b)&&$.inArray(b,project.unloadedProps)==-1){delete a[b]}}a.unloaded=true;storage.set(c,a)}return a},unloadOldest:function(){var i,d,c;var e=account.get("projectIds");for(var b=0,a=e.length;b<a;b++){var h=e[b];if(h!=account.get("lastOpenProject")){var f=storage.get(h);if(!f.unloaded&&(!c||c>f.updated)){c=f.updated;i=h;d=f}}}if(d){project.unload(i,d)}else{throw"Could not find a project to unload"}},loadIfUnloaded:function(d,c){function a(){if($.isFunction(c)){c.call()}}var b=storage.get(d);if(b&&b.unloaded){ajax.syncDown(d,function(f,k,h){var i=JSON.parse(h.responseText).t;if(i.length){i=i[0].replace(/[\r\n]/g,"\\n")}else{i=i.replace(/[\r\n]/g,"\\n")}var e=JSON.parse(i);if(e.unloaded){delete e.unloaded}if(e.uploads){delete e.uploads}for(var j in e){if(e.hasOwnProperty(j)){storage.set(j,e[j],false)}}a()})}else{a()}},resetCanvas:function(){var a=-1000,b=-1000;project.set({canvasPosY:b,canvasPosX:a});$("#viewport").get(0).scrollLeft=a;$("#viewport").get(0).scrollTop=b},updateOnSignup:function(){project.setNumber();project.previewRenderer.renderProjectPreview(project.bundle(account.get("lastOpenProject")),function(b,a){project.onPreviewReady(b,a,"projectopen")})},_freeSlotForProject:function(){var f=false;if(!account.canAddProjects()){var b=account.get("projectIds");for(var a in b){var e=b[a];var d=storage.get(e);if(d){var c=d.active!==undefined?d.active:true;if(c){if(!project.isOpen(e)){project.dropToInactive($("#"+e));f=true;break}}}}}if(!f){project.dropToInactive($("#"+account.get("lastOpenProject")))}},getPagesInViewport:function(e){var j=[];var h=document.getElementById("viewport");var a=$.extend([],project.get("pages"));var m=project.get("currentZoom");var k={left:e==="init"?-project.get("canvasPosX")/m:h.scrollLeft/m,top:e==="init"?-project.get("canvasPosY")/m:h.scrollTop/m,width:window.innerWidth/m,height:window.innerHeight/m};k.right=k.left+k.width;k.bottom=k.top+k.height;var n,f,l,d;var b;for(var c=0;c<a.length;c++){b=a[c];a[c]=$.extend({},storage.get(a[c]));n=a[c].x;f=a[c].x+a[c].width;l=a[c].y;d=a[c].y+a[c].height;if(((n<=k.right)&&(k.left<=f)&&(l<=k.bottom)&&(k.top<=d))){j.push(b)}}return j},getLinksInViewport:function(e){var c=project.getPagesInViewport(e);var b=project.get("links");var d={linkCanvId:[],linkDest:[],linkOrigin:[],linkType:[],transType:[],triggerType:[]};for(var a=0;a<b.linkCanvId.length;a++){if(c.indexOf(b.linkDest[a])!==-1||c.indexOf(widgetsCache[b.linkOrigin[a]].pageId)!==-1){d.linkCanvId.push(b.linkCanvId[a]);d.linkDest.push(b.linkDest[a]);d.linkOrigin.push(b.linkOrigin[a]);d.linkType.push(b.linkType[a]);d.transType.push(b.transType[a]);d.triggerType.push(b.triggerType[a])}}return d},getActivePage:function(){return $("#canvasPages > .screen.active").first()},getActivePageId:function(){return project.getActivePage().attr("id")}};(function(){var b=0;var c=["ms","moz","webkit","o"];for(var a=0;a<c.length&&!window.requestAnimationFrame;++a){window.requestAnimationFrame=window[c[a]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[c[a]+"CancelAnimationFrame"]||window[c[a]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame){window.requestAnimationFrame=function(i,e){var d=new Date().getTime();var f=Math.max(0,16-(d-b));var h=window.setTimeout(function(){i(d+f)},f);b=d+f;return h}}if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(d){clearTimeout(d)}}}());var utils={reloadWithMessage:function(b){function a(){storage._setItem("postloadMessage",b);location.reload()}if(fluid.main.deferReload){fluid.main.on("deferReloadRelease",a)}else{a()}},selectText:function(a){if(a=="control+a"){$this=$(".ui-selected").find("textarea")}else{$this=$(this)}$this.focus();$this.select();return false},getTLWH:function(c){var e=$(c);if(e.length==0){return{top:0,left:0,width:0,height:0}}var b=e.offset();var d=e.outerWidth();var a=e.outerHeight();return{top:b.top,left:b.left,width:d,height:a}},getCenterPoint:function(a){var c=utils.getTLWH(a);var d=Math.floor(c.top+(c.height/2));var b=Math.floor(c.left+(c.width/2));return{top:d,left:b}},getTranslateDistanceToCenter:function(u,r){var l=$(u).outerWidth();var s=$(u).outerHeight();var f=parseFloat($(u).css("top"));var k=parseFloat($(u).css("left"));var i=utils.getCenterPoint(r);var t=utils.getTLWH(r);var n=l-t.width;var m=s-t.height;var a=Math.max(0,n,m);var d=a==n?false:true;var b=a==m?false:true;var e=-parseFloat($("#viewport").get(0).scrollTop);var h=-parseFloat($("#viewport").get(0).scrollLeft);var j=b?f+s/2:f;var c=d?k+l/2:k;var q=i.top-j-e;var p=i.left-c-h;if(m>0){var o=0.5*t.height-95;q=q-o}return{top:q,left:p}},getBoundingAreaRelative:function(b){var c=$(b);if(c.length==0){return{top:0,left:0,bottom:0,right:0}}var a={top:null,left:null,right:null,bottom:null};$(c).each(function(){$t=$(this);var d={top:parseFloat($t.css("top")),left:parseFloat($t.css("left")),width:parseFloat($t.css("width")),height:parseFloat($t.css("height"))};if($t.hasClass("screen")){var e=$(".page",$t);d={top:parseFloat($t.css("top")),left:parseFloat($t.css("left")),width:parseFloat(e.css("width")),height:parseFloat(e.css("height"))}}if((a.left>d.left)||a.left==null){a.left=d.left}if((a.top>d.top)||a.top==null){a.top=d.top}if((a.right<d.left+d.width)||a.right==null){a.right=d.left+d.width}if((a.bottom<d.top+d.height)||a.bottom==null){a.bottom=d.top+d.height}});return a},getBoundingArea:function(a){utils.boundingLeft=null;utils.boundingTop=null;utils.boundingRight=null;utils.boundingBottom=null;var c=$(a);if(c.length==0){return{top:0,left:0,bottom:0,right:0}}c.each(function(){var d=utils.getTLWH(this);if((utils.boundingLeft>d.left)||utils.boundingLeft==null){utils.boundingLeft=d.left}if((utils.boundingTop>d.top)||utils.boundingTop==null){utils.boundingTop=d.top}if((utils.boundingRight<d.left+d.width)||utils.boundingRight==null){utils.boundingRight=d.left+d.width}if((utils.boundingBottom<d.top+d.height)||utils.boundingBottom==null){utils.boundingBottom=d.top+d.height}});var b={top:utils.boundingTop,left:utils.boundingLeft,bottom:utils.boundingBottom,right:utils.boundingRight};return b},guid:function(b){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";var f=32;var d="";for(var c=0;c<f;c++){var a=Math.floor(Math.random()*e.length);d+=e.substring(a,a+1)}return b+"_"+d},prevent:function(a){a.stopPropagation();a.preventDefault();return false},arraysEqual:function(d,c){var e=d.length==c.length;if(e){for(var b=0,a=d.length;b<a;b++){e=d[b]===c[b];if(!e){break}}}return e},hslToHex:function(j){function i(l,b,o){if(o<0){o+=1}else{if(o>1){o-=1}}if(o*6<1){return l+(b-l)*o*6}if(o*2<1){return b}if(o*3<2){return l+(b-l)*(2/3-o)*6}return l}var d=j.h/360,n=j.s/100,c=j.l/100;var m,k;if(c<=0.5){k=c*(1+n)}else{k=c+n-(c*n)}m=c*2-k;var a=i(m,k,d+1/3);var e=i(m,k,d);var f=i(m,k,d-1/3);a=Math.round(a*255);e=Math.round(e*255);f=Math.round(f*255);a=parseInt(a).toString(16);e=parseInt(e).toString(16);f=parseInt(f).toString(16);if(a.length<2){a="0"+a}if(e.length<2){e="0"+e}if(f.length<2){f="0"+f}return a+e+f},hex2rgba:function(d,b){if(!d[0]=="#"){return false}if(d.indexOf("rgba(")===0){return d}if(d.indexOf("rgb(")===0){var c;d=d.replace("rgb(","rgba(");c=d.split(",");c[c.length-1]=parseInt(c[c.length-1]);c.push("1)");d=c.join(",");return d}if(d.length=="4"){d="#"+d[1]+d[1]+d[2]+d[2]+d[3]+d[3]}return"rgba("+(parseInt(d.substr(1,2),16))+","+(parseInt(d.substr(3,2),16))+","+(parseInt(d.substr(5,2),16))+","+(b||1)+")"},rgb2hex:function(a){a=a.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);function b(c){return("0"+parseInt(c).toString(16)).slice(-2)}return"#"+b(a[1])+b(a[2])+b(a[3])},toHSL:function(m){var m=(m)?m:"rgb(0, 0, 0)";m=m.replace(/ /g,"");if(m.match(/hsla/gi)){return{h:m.match(/[0-9]*/g)[5],s:m.match(/[0-9]*/g)[7],l:m.match(/[0-9]*/g)[10]}}if(m.match(/hsl/gi)){return{h:m.match(/[0-9]*/g)[4],s:m.match(/[0-9]*/g)[6],l:m.match(/[0-9]*/g)[9]}}if(m.match(/#/gi)){if(m.length==4){m="#"+m[1]+m[1]+m[2]+m[2]+m[3]+m[3]}else{if(m.length!=7){m="#000000"}}var a=parseInt(m.substring(1,3),16);var i=parseInt(m.substring(3,5),16);var k=parseInt(m.substring(5,7),16)}else{if(m.match(/rgba/gi)){var a=m.match(/[0-9]*/g)[5];var i=m.match(/[0-9]*/g)[7];var k=m.match(/[0-9]*/g)[9]}else{if(m.match(/rgb/gi)){var a=m.match(/[0-9]*/g)[4];var i=m.match(/[0-9]*/g)[6];var k=m.match(/[0-9]*/g)[8]}}}a/=255,i/=255,k/=255;var c=Math.max(a,i,k);var e=Math.min(a,i,k);var f=0;var n=0;var d=(c+e)/2;if(c!=e){var j=c-e;n=(d<0.5)?j/(c+e):j/(2-c-e);switch(c){case a:f=(i-k)/j;break;case i:f=(k-a)/j+2;break;case k:f=(a-i)/j+4;break}f/=6;if(f<0){f+=1}}f=f*360;d=d*100;n=n*100;return{h:f,s:n,l:d}},replaceRgbaAlpha:function(c,b){var d=c.match(/rgba/i);if(d){ret=c.split(",");ret[ret.length-1]=b+")";ret=ret.join(",");return ret}return c},getRgbaAlpha:function(b){if(b[0]=="#"||b.indexOf("rgb(")!=-1){return 1}var a=b.split(",");a=a[a.length-1];a=parseFloat(a);return a},getAlphaFromColor:function(a){if(a[0]=="#"){return 1}else{if(a.indexOf("rgba(")===0){a=a.split(",");a=a[a.length-1].replace(")","");return a}}return 1},isMobileDevice:function(){var a=false;if(navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/Android/i)){a=true}return a},hideBrowserBar:function(){var a=false;if(navigator.userAgent.match(/Android/i)){a=true}return a},isMouseOver:function(b,a){var c=a.offset();return b.pageX>=c.left&&b.pageX<(c.left+a.outerWidth())&&b.pageY>=c.top&&b.pageY<(c.top+a.outerHeight())},relativeMousePos:function(b,a){var c=a.offset();return{top:b.pageY-c.top,left:b.pageX-c.left}},animateRaf:function(a,e,j,d){if($.isFunction(j)){d=j;j=undefined}var b,h,f,k=false;var i=window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(l){window.setTimeout(function(){l(new Date().valueOf())},16.667)};function c(n){if(!k&&n<946684800000){if(f){b=startTimeHiResClock;h=endTimeHiResClock;k=true}else{n=new Date().valueOf()}}var l=n-b;var m=h!=b?l/e:1;if(m<1){if(j){m=j(m,l,0,1,e)}a(m);i(c)}else{a(1);if(d&&$.isFunction(d)){window.setTimeout(d,10)}}}if(e===undefined){e=300}f=window.hasOwnProperty("performance")&&window.performance.hasOwnProperty("now");b=new Date().valueOf();startTimeHiResClock=f?window.performance.now():b;h=b+e;endTimeHiResClock=startTimeHiResClock+e;if(j){j=$.easing[j]}i(c)},toPercent:function(c,f,d){if(typeof c=="string"){var e=utils.parsePercentString(c);c=e&&!isNaN(e)?e*f/100:parseFloat(c)}var a=c*100/f;var b=Math.pow(10,d);return(Math.round(a*b))/b},parsePercentString:function(c){var b=NaN;if(typeof c=="string"){var a=c.match(/^\s*(\d+(?:\.\d*)?|\.\d+)\s*\%\s*$/);if(a){b=parseFloat(a[1])}}return b},isPercentString:function(b){var a=utils.parsePercentString(b);return Boolean(a)&&!isNaN(a)},fromPercentString:function(c,b){var a=utils.parsePercentString(c);if(a&&!isNaN(a)){a*=b/100}return a},getNavigationKeyDirection:function(b){var a="";switch(b){case 37:a="left";break;case 38:a="top";break;case 39:a="right";break;case 40:a="bottom";break}return a},replaceTooltip:function(a){},Vector:(function(){function a(b,d,c){if(!(this instanceof a)){return new a(b,d,c)}if(b instanceof Object){d=b.y;c=b.z;b=b.x}c=c||0;if(typeof b!=="number"||typeof d!=="number"){b=d=c=0}this.x=b;this.y=d;this.z=c;a.created++}a.created=0;a.prototype={set:function(b,d,c){if(b instanceof Object){d=b.y;b=b.x;c=b.z}c=c||0;if(typeof b==="number"&&typeof d==="number"&&typeof c==="number"){this.x=b;this.y=d;this.z=c}return this},distanceTo:function(c){var b=this.x-c.x,e=this.y-c.y,d=this.z-c.z;return Math.sqrt(b*b+e*e+d*d)},distanceSqTo:function(c){var b=this.x-c.x,e=this.y-c.y,d=this.z-c.z;return b*b+e*e},plus:function(b){return new a(this.x+b.x,this.y+b.y,this.z+b.z)},minus:function(b){return new a(this.x-b.x,this.y-b.y,this.z-b.z)},scale:function(b){return new a(this.x*b,this.y*b,this.z*b)},dot:function(b){return this.x*b.x+this.y*b.y+this.z*b.z},magnitude:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},angle:function(b){if(!b){b=a.I}else{return this.angle()-b.angle()}if(this.y<0){return 2*Math.PI-(new a(this.x,-this.y,this.y)).angle(b)}return Math.acos(this.dot(b)/(this.magnitude()*b.magnitude()))},rotateBy:function(b){if(b>Math.PI){return this.rotateBy(-(2*Math.PI-b))}else{if(b<-Math.PI){return this.rotateBy(2*Math.PI+b)}}return new a(this.x*Math.cos(b)-this.y*Math.sin(b),this.x*Math.sin(b)+this.y*Math.cos(b))},rotateTo:function(c){var b=c-this.angle();return this.rotateBy(b)},unitVector:function(){return this.scale(1/this.magnitude())},add:function(b){this.x+=b.x;this.y+=b.y;return this},sub:function(b){this.x-=b.x;this.y-=b.y;return this},mul:function(b){this.x*=b;this.y*=b;return this},rotBy:function(b){this.x=this.x*Math.cos(b)-this.y*Math.sin(b);this.y=this.x*Math.sin(b)+this.y*Math.cos(b);return this},rotTo:function(c){var b=c-this.angle();return this.rotBy(b)},copy:function(){return new a(this.x,this.y)},};a.I=Object.freeze(new a(1,0,0));a.J=Object.freeze(new a(0,1,0));a.K=Object.freeze(new a(0,0,1));return a}()),drawVectors:function(m,n,o){var h=[],b=[],j=o[0],f=[],k=n.length;for(var a=k-1,e=0;e<k;e++){b[a]=n[e].distanceTo(n[a]);a=e}for(var e=0,a=k-1;e<k;e++){f[e]=Math.min(j,b[a]/2,b[e]/2)}for(var a=k-1,e=0;e<k;e++){h[a]=n[e].minus(n[a]).unitVector().scale(f[a]);a=e}var l=n[0].plus(h[0]);m.moveTo(l.x,l.y);for(e=0;e<k;e++){var d=e<k-1?e+1:0;l=n[d].minus(h[e]);m.lineTo(l.x,l.y);l=n[d].plus(h[d]);m.quadraticCurveTo(n[d].x,n[d].y,l.x,l.y)}},getFitSize:function(d){var e,f,c=d.object.width>d.frame.width||d.object.height>d.frame.height,a=d.frame.width/d.frame.height,h=d.object.width/d.object.height;if(!c&&!d.expand){return d.object}var b={};if(a>h){e="height";f="width";b.top=0}else{e="width";f="height";b.left=0}b[e]=d.frame[e];b[f]=(d.frame[e]/d.object[e])*d.object[f];return b}};jQuery.fn.removeWhitespace=function(){var a=this.contents().filter(function(){return this.nodeType==3&&!/\S/.test(this.nodeValue)}).remove();return this};var qrCode={setURL:function(b,a){qrCode._setCode(document.querySelector("#qrHolder img"),b,a)},setShareURL:function(b,a){var c=document.querySelectorAll(".qrContainer");fluid.util._.each(c,function(d){qrCode._setCode(d,b,a)})},_setCode:function(b,c,a){if(b instanceof HTMLImageElement){b.src=qr.dataUrl(c)}else{b.style.backgroundImage="url("+qr.dataUrl(c,a||200)+")";b.style.backgroundPosition="center";b.style.backgroundRepeat="no-repeat"}}};if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var e=Array.prototype.slice.call(arguments,1),d=this,b=function(){},c=function(){return d.apply(this instanceof b&&a?this:a,e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;c.prototype=new b();return c}}if(!window.fluid){window.fluid={}}fluid.wdgProvider=function(){var a=window.widgets?$.extend(true,{},widgets):null;return{getWidgets:function(d){var c=$.extend(true,{},a.summary);if(d){for(var b in c){if(c.hasOwnProperty(b)){c[b].originId=b}}}return c},getRootWidgets:function(e,d){var b=[];for(var c in a.summary){if(a.summary.hasOwnProperty(c)&&a.summary[c].g&&(e==undefined||a.summary[c].g.indexOf(e)!=-1)){b.push(a.summary[c]);if(d){b[b.length-1].originId=c}}}return b},getWdgGroups:function(){return $.extend(true,{},a.g)},getChildWidgets:function(b,e){var d=[];var f;var h;for(var c=0;c<b.ad.length;c++){f=b.ad[c][0];h=$.extend(true,{},a.summary[f]);if(e){h.originId=f}d.push(h)}return d},getById:function(b){return $.extend(true,{},a.summary[b])},getChildById:function(d,c){parentChildren=c&&c.ad?c.ad:null;if(parentChildren&&parentChildren.length){for(var b=0;b<parentChildren.length;b++){if(d==parentChildren[b][0]){return parentChildren[b]}}}return false}}}();fluid.widget=function(){return{handleCollection:function(f,d,e){if(f.length==undefined){var a={};f=$.extend(true,{},f);e.unshift({});for(var c in f){if(f.hasOwnProperty(c)){e[0]=f[c];a[c]=d.apply(this,e)}}return a}else{var a=[];e.unshift({});for(var b=0;b<f.length;b++){e[0]=f[b];a.push(d.apply(this,e))}return a}},setSizeLimit:function(b,c,a){return this.handleCollection(b,function(e,f,d){if(!e.wh){e.wh=[f,d]}else{if(typeof e.wh[0]=="string"){e.wh[0]=f}if(typeof e.wh[1]=="string"){e.wh[1]=d}}return e},[c,a])},setRootSizeLimit:function(b,c,a){return this.handleCollection(b,function(e,f,d){if(!e.g){return e}if(!e.wh){e.wh=[f,d]}else{if(typeof e.wh[0]=="string"){e.wh[0]=f}if(typeof e.wh[1]=="string"){e.wh[1]=d}}return e},[c,a])},hasChildWidgets:function(a){return a.ad&&a.ad.length?true:false},hasSegments:function(a){return a.sc?true:false},isTextWidget:function(a){if(a.tc){return true}else{return false}},isShapeWidget:function(a){if(a.b||a.bg||a.bgc||a.bgd||a.i){return true}else{return false}},isUploadWidget:function(a){if(a.upload==="y"){return true}else{return false}}}}();fluid.wdgRenderer=function(a,b){this.canvasSize=[a||320,b||480];this.useCanvas=true;this.renderingQueue={};this.imagesToLoad={};this.uploadsToLoad={};this.imagesLoaded={};this.canvases={};this.cropping={x:12004,y:9804,x2:0,y2:0};this.renderBlur=true;this.useOneCanvas=true;this.setCropping=function(c){if(c.x<this.cropping.x){this.cropping.x=c.x}if(c.y<this.cropping.y){this.cropping.y=c.y}if(c.x+c.width>this.cropping.x2){this.cropping.x2=c.x+c.width}if(c.y+c.height>this.cropping.y2){this.cropping.y2=c.y+c.height}};this.generateCanvas=function(c){this.canvas=$("<canvas>").attr({width:this.canvasSize[0],height:this.canvasSize[1]});if(c){this.canvas.attr({id:"pag-"+c})}this.canvases[c]=this.canvas;this.ctx=this.canvas.get(0).getContext("2d")};this.percentToPixel=function(e,f,c){var d;if(f.wh[0].indexOf&&f.wh[0].indexOf("%")!==-1){d=parseInt(f.wh[0],10)/100;d=d*c.box[2];e[2]=d}if(f.wh[1].indexOf&&f.wh[1].indexOf("%")!==-1){d=parseInt(f.wh[1],10)/100;d=d*c.box[3];e[3]=d}return e};this.getPixelDimensions=function(d,e,c){if(e.wh&&typeof e.wh[0]=="number"){d[2]=e.wh[0]}if(e.wh&&typeof e.wh[1]=="number"){d[3]=e.wh[1]}return d};this.parseBoxValue=function(d,c){if(typeof(d)==="number"){return d}else{return(parseFloat(d)/100)*c}};this.calculateBox=function(j,d,c){if(!d){d={box:[0,0,this.canvasSize[0],this.canvasSize[1]]}}var f=[0,0];var h;if(j.tlwh){f=[this.parseBoxValue(j.tlwh[1],d.box[2]),this.parseBoxValue(j.tlwh[0],d.box[3]),this.parseBoxValue(j.tlwh[2],d.box[2]),this.parseBoxValue(j.tlwh[3],d.box[3])];return f}if(!j.wh){f[2]=d.box[2];f[3]=d.box[3]}else{f=this.getPixelDimensions(f,j,d);f=this.percentToPixel(f,j,d)}if(c){if(!c[3]||c[3][1]=="l"){if(typeof c[1]=="number"){f[0]=c[1]}else{if(typeof c[1]=="string"){f[0]=(parseInt(c[1],10)/100)*d.box[2]}}}else{if(c[3][1]=="c"){var e;if(typeof c[1]=="number"){e=c[1]}else{e=(parseInt(c[1],10)/100)*d.box[2]}f[0]=(d.box[2]-f[2])/2+e}else{if(typeof c[1]=="number"){f[0]=d.box[2]-f[2]-c[1]}else{if(typeof c[1]=="string"){h=(parseInt(c[1],10)/100)*d.box[3];f[0]=d.box[2]-f[2]-h}}}}if(!c[3]||c[3][0]=="t"){if(typeof c[2]=="number"){f[1]=c[2]}else{if(typeof c[2]=="string"){f[1]=(parseInt(c[2],10)/100)*d.wh[1]}}}else{if(c[3][1]=="c"){var i;if(typeof c[2]=="number"){i=c[2]}else{i=(parseInt(c[2],10)/100)*d.box[3]}f[1]=(d.box[3]-f[3])/2+i}else{if(typeof c[2]=="number"){f[1]=d.box[3]-f[3]-c[2]}else{if(typeof c[2]=="string"){h=(parseInt(c[2],10)/100)*d.wh[1];f[1]=d.wh[1]-f[3]-h}}}}}f[0]=f[0]+d.box[0];f[1]=f[1]+d.box[1];return f};this.renderUpload=function(h,f,l){$canvas=f||this.canvas;function j(p,o){if(!h.box[2]||!h.box[3]){h.box[2]=o.width;h.box[3]=o.height}var n=p.get(0).getContext("2d");n.drawImage(o,h.box[0],h.box[1],h.box[2],h.box[3]);o.onload=null;o.onerror=null}function m(q,o,p){q.addClass("failureImage");var n=q.get(0).getContext("2d");n.font="32pt Arial";n.fillText("Image",35,50);n.fillText("not found",10,115)}function d(){m();widget._convertCanvasToImg($(ctx.canvas),widgEl.find("img"),tmplVars)}function k(){var n=h.data||false;if(n&&n.substr(0,5)!="data:"){n=ajax.apiObjectUrl("img",h.data)}else{if(h.id){n=ajax.apiObjectUrl("img",h.id)}}return n||m()}if(l){j($canvas,l);return this.canvas}var e=k();if(this.useCanvas){var i=new Image();i.onload=j.bind(this,$canvas,i);i.onerror=m.bind(this,$canvas,i);i.src=e}else{var c=widgEl.find("img");c.error(d);c.attr("src",e)}return this.canvas};this.adjustWords=function(d){var e=[];for(var c=0;c<d.length;c++){if(d[c]!==""){e.push(d[c])}else{if(browserDetect.browser==="Firefox"){e[e.length-1]+=" "}}}return e};this.wrapText=function(s,p,f,m,j,t){if(f[3]<0){return 0}var k=p.split(" ");var u="";var c="";var r=0;var i,q;var h;var o=" ";var l=f[1];if(isNaN(m)){m=13}k=this.adjustWords(k);if(p.match(/[\u3131-\uCB4C]/)){o="";k=p.split("")}for(var d=0;d<k.length;d++){i=u+k[d]+o;q=s.measureText(i).width;if(browserDetect.browser!=="Firefox"){q=q+Math.round(-0.285714286*parseFloat(t)+0.075)}if(q>f[2]&&k.length!==1){c=k[d]+o;if(browserDetect.browser!=="Firefox"&&k[d].indexOf("-")!==-1){var e=u+k[d].substring(0,k[d].indexOf("-")+1);if(s.measureText(e).width<=f[2]){u=e;c=k[d].substring(k[d].indexOf("-")+1)+o}}if(l+m*0.5>f[1]+f[3]){return r}h=s.measureText(u).width;if(browserDetect.browser!=="Firefox"){h=h+Math.round(-0.285714286*parseFloat(t)+0.075)}if(h>f[2]&&u.indexOf(" ")===u.length-1&&browserDetect.browser!=="Firefox"){c=o+c}if(j&&j[1]==="c"){s.fillText(u,f[0]+(f[2]/2)-(h/2),l)}else{if(j&&j[1]==="r"){s.fillText(u,f[0]+f[2]-h,l)}else{s.fillText(u,f[0],l)}}u=c;l+=m;r++}else{u=i}}if(l+m*0.5>f[1]+f[3]){return r}h=s.measureText(u).width;h=h+Math.round(-0.285714286*parseFloat(t)+0.075);if(j&&j[1]==="c"){s.fillText(u,f[0]+(f[2]/2)-(h/2),l)}else{if(j&&j[1]==="r"){s.fillText(u,f[0]+f[2]-h,l)}else{s.fillText(u,f[0],l)}}return r};this.renderText=function(m,l){var A=m.ts.replace(/"/g,"");if(!this.useOneCanvas){if(this.renderingMode==="singlepage"){return $('<div class="widgetText" style="'+A+';width: 100%;height:100%;">'+m.tc+"</div>")}else{return $('<div class="widgetText" style="'+A+";width:"+(m.box[2]+3)+"px;height:"+m.box[3]+"px; top:"+m.box[1]+"px; left:"+m.box[0]+'px;">'+m.tc+"</div>")}}else{var o=0;var u=m.tc.replace(/&nbsp/g," ");var f=u.split("\n");var e;var l=l||this.canvas;var r=l.get(0).getContext("2d");var p=A.match(/font:[a-zA-Z0-9\s:\/]*;/);var d=A.match(/[0-9]+px/);if(d){d=parseInt(d[0],10)}if(p){p=p[0];p=p.replace("font:","");p=p.replace(";","")}else{var h="normal";if(A.indexOf("font-style")!==-1){h=A.substring(A.indexOf("font-style")+11,A.indexOf(";",A.indexOf("font-style"))).trim()}var k="normal";if(A.indexOf("font-variant")!==-1){k=A.substring(A.indexOf("font-variant")+13,A.indexOf(";",A.indexOf("font-variant"))).trim()}var n="normal";if(A.indexOf("font-weight")!==-1){n=A.substring(A.indexOf("font-weight")+12,A.indexOf(";",A.indexOf("font-weight"))).trim()}d=A.substring(A.indexOf("font-size")+10,A.indexOf(";",A.indexOf("font-size"))).trim();var C=A.substring(A.indexOf("font-family")+12,A.indexOf(";",A.indexOf("font-family"))).trim();e=A.substring(A.indexOf("line-height")+12,A.indexOf(";",A.indexOf("line-height"))).trim();p=h+" "+k+" "+n+" "+d+" "+C}var v=A.substring(A.indexOf("color")+6,A.indexOf(";",A.indexOf("color"))).trim();if(v.indexOf("rgb(")!==-1){v=utils.rgb2hex(v)}var j=A.indexOf(";",A.indexOf("text-align"))!==-1?A.substring(A.indexOf("text-align")+11,A.indexOf(";",A.indexOf("text-align"))).trim():A.substring(A.indexOf("text-align")+11).trim();var t="";if(A.indexOf("text-decoration")!==-1){t=A.substring(A.indexOf("text-decoration")+16,A.indexOf(";",A.indexOf("text-decoration"))).trim()}var D=0;if(A.indexOf("padding-top")!==-1){o=A.indexOf(";",A.indexOf("padding-top"));if(o!==-1){D=parseInt(A.substring(A.indexOf("padding-top")+12,o).trim(),10)}else{D=parseInt(A.substring(A.indexOf("padding-top")+12).trim(),10)}}var c=0;if(A.indexOf("margin-top")!==-1){o=A.indexOf(";",A.indexOf("margin-top"));if(o!==-1){c=parseInt(A.substring(A.indexOf("margin-top")+11,A.indexOf(";",A.indexOf("margin-top"))).trim(),10)}else{c=parseInt(A.substring(A.indexOf("margin-top")+11).trim(),10)}}r.fillStyle=v;r.font=p;r.textBaseline="top";var B=0;var q=0;if(e&&parseFloat(e)){B=Math.round(-0.07*parseFloat(d)+2.66);q=Math.round(0.5*(parseFloat(e)-parseFloat(d))-2.75);e=parseFloat(e)}else{if(p.indexOf("/")!==-1&&parseFloat(p.substring(p.indexOf("/")+1))){B=Math.round(-0.07*parseFloat(d)+2.66);e=parseFloat(p.substring(p.indexOf("/")+1))}else{e=Math.round(1.14*parseFloat(d))}}if(browserDetect.browser==="Firefox"){B=B+Math.round(0.148148148*parseFloat(d)+0.5)}var s=0;var E=[m.box[0],m.box[1]+B+q+D+c,m.box[2],m.box[3]];var w=m.ca||"lt";if(j==="center"){w=w[0]+"c"}else{if(j==="right"){w=w[0]+"r"}else{if(j==="left"){w=w[0]+"l"}}}if(f.length==1){this.wrapText(r,u,E,e,w,d)}else{for(var z=0;z<f.length;z++){s=s+this.wrapText(r,f[z],[E[0],E[1]+(z+s)*e,E[2],E[3]-(z+s)*e],e,w,d)}}return l}};this.paintCanvas=function(m,k){var q=this;if(!this.useOneCanvas){k=$("<canvas>").attr({width:this.renderingMode==="singlepage"?m.box[2]:this.canvasSize[0],height:this.renderingMode==="singlepage"?m.box[3]:this.canvasSize[1]})}else{if(!k){k=this.canvas}}var u=k.get(0).getContext("2d");var q=this;var l={blur:function(){if(m.blur){if(q.renderBlur){var A=document.createElement("img"),B=widget.renderBlurLayerImmediate.call(q,m.id),c=jQuery.extend([],m.box),z,C;if(!B){return false}if(c[0]<0){c[0]=0}if(c[1]<0){c[1]=0}if(c[2]>B.width){c[2]=B.width}if(c[3]>B.height){c[3]=B.height}if(widgetsCache&&widgetsCache[m.id]){z=widgetsCache[m.id].pageId;C=pagesCache[z].box;if(!C){var i=storage.get(z);C=[0,0,i.width,i.height]}if(c[0]+c[2]>C[2]){c[2]=C[2]-c[0]}if(c[1]+c[3]>C[3]){c[3]=C[3]-c[1]}}u.drawImage(B,c[0],c[1],c[2],c[3],c[0],c[1],c[2],c[3])}}},background:function(){u.save();function B(){var E=(m.bgc)?m.bgc:["#CAD1D7","#C4CBD3"];var G=[5,2];var F="v";if(m.bgd){F=m.bgd[0];G=[m.bgd[1],m.bgd[2]]}u.fillStyle=E[1];u.fill();u.fillStyle=E[0];if(F=="v"){for(var H=G[0];H<p;){u.fillRect(H,0,G[1],o);H+=G[0]}}else{for(var H=G[0];H<o;){u.fillRect(0,H,p,G[1]);H+=G[0]}}}if(!p){p=0}if(!o){o=0}if(m.bg=="c"){u.fillStyle=m.bgc[0];u.fill()}else{if(m.bg=="s"){B()}else{if(m.bg=="l"){var i=q.useOneCanvas?m.box[0]:0;var A=q.useOneCanvas?m.box[1]:0;var z=q.useOneCanvas?m.box[1]+m.box[3]:m.box[3];g=u.createLinearGradient(i,A,i,z);l._gradient(g,u,m)}else{if(m.bg=="lrl"){g=u.createLinearGradient(m.box[0],m.box[1],m.box[0]+m.box[2],m.box[1]);l._gradient(g,u,m)}else{if(m.bg=="ld"){g=u.createLinearGradient(m.box[0],m.box[1],m.box[0]+m.box[2],m.box[1]+m.box[3]);l._gradient(g,u,m)}else{if(m.bg=="ld2"){g=u.createLinearGradient(m.box[0]+m.box[2],m.box[1],m.box[0],m.box[1]+m.box[3]);l._gradient(g,u,m)}else{if(m.bg=="r"){var c=m.box[3]/2;var D=m.box[0]+m.box[2]/2;var C=m.box[1]+c;g=u.createRadialGradient(D,C,0,D,C,c);l._gradient(g,u,m)}}}}}}}u.restore()},border:function(D,z,A,i){var C=0,B=0;D.lineWidth=(typeof d)==="number"?d:v;D.strokeStyle=z.b[1];D.stroke();D.save()},path:function(aa,z,C,O,B,T,Q,ad,S){aa.beginPath();var I=Math.floor(ad/2);var M=O+I;var X=B+I;var ac=O+Q-I;var P=B+T-I;var E=P-X;var R=ac-M;var i=["cloud","thumbsD","thumbsU"];if(S.sh&&S.sh[3]&&S.sh[2]){M+=Math.floor(S.sh[3]-S.sh[2]/2);X+=Math.floor(S.sh[3]-S.sh[2]/2);ac-=Math.floor(S.sh[3]+S.sh[2]/2);P-=Math.floor(S.sh[3]+S.sh[2]/2)}if($.isArray(C)){for(var N=0;N<4;N++){C[N]=C[N]||0}}else{C=[C,C,C,C]}if(z=="sq"){var W=Math.min((P-X)/2,(ac-M)/2);C[0]=Math.min(C[0],W);C[1]=Math.min(C[1],W);C[2]=Math.min(C[2],W);C[3]=Math.min(C[3],W);aa.moveTo(X+C[0],M),aa.lineTo(P-C[1],M),aa.quadraticCurveTo(P,M,P,M+C[1]),aa.lineTo(P,ac-C[2]),aa.quadraticCurveTo(P,ac,P-C[2],ac),aa.lineTo(X+C[3],ac),aa.quadraticCurveTo(X,ac,X,ac-C[3]),aa.lineTo(X,M+C[0]),aa.quadraticCurveTo(X,M,X+C[0],M)}if(z=="arrU"){var G=(P-X)+(5/4);var L=(X+P)/2;var T=P-X;aa.moveTo(L,M+ad);aa.lineTo(P-(ad/2),M+G);aa.lineTo(L+T*0.15,M+G);aa.lineTo(L+T*0.15,ac);aa.lineTo(L-T*0.15,ac);aa.lineTo(L-T*0.15,M+G);aa.lineTo(X+(ad/2),M+G);aa.lineTo(L,M+ad)}if(z=="arrD"){var G=(P-X)+(5/4);var L=(X+P)/2;var T=P-X;aa.moveTo(L,ac-ad);aa.lineTo(P-(ad/2),ac-G);aa.lineTo(L+T*0.15,ac-G);aa.lineTo(L+T*0.15,M);aa.lineTo(L-T*0.15,M);aa.lineTo(L-T*0.15,ac-G);aa.lineTo(X+(ad/2),ac-G);aa.lineTo((X+P)/2,ac)}if(z=="arrR"){var G=(ac-M)+(5/4);var J=(M+ac)/2;var Q=ac-M;aa.moveTo(P-ad,(M+ac)/2);aa.lineTo(P-G,ac-(ad/2));aa.lineTo(P-G,J+Q*0.15);aa.lineTo(X,J+Q*0.15);aa.lineTo(X,J-Q*0.15);aa.lineTo(P-G,J-Q*0.15);aa.lineTo(P-G,M+(ad/2));aa.lineTo(P-ad,(M+ac)/2)}if(z=="arrL"){var G=(ac-M)+(5/4);var J=(M+ac)/2;var Q=ac-M;aa.moveTo(X+ad,(M+ac)/2);aa.lineTo(X+G,ac-(ad/2));aa.lineTo(X+G,J+Q*0.15);aa.lineTo(P,J+Q*0.15);aa.lineTo(P,J-Q*0.15);aa.lineTo(X+G,J-Q*0.15);aa.lineTo(X+G,M+(ad/2));aa.lineTo(X+ad,(M+ac)/2)}if(z=="image"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M-Math.floor(ad/2));aa.moveTo(X,M);aa.lineTo(P,ac);aa.moveTo(P,M);aa.lineTo(X,ac)}else{if(z=="tri"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,M)}else{if(z=="tri"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,M)}else{if(z=="trR"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="ttrL"){aa.moveTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(P,M)}else{if(z=="ttrR"){aa.moveTo(X,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="triU"){aa.moveTo((X+P)/2,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo((X+P)/2,M)}else{if(z=="triD"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo((X+P)/2,ac);aa.lineTo(X,M)}else{if(z=="triR"){aa.moveTo(X,M);aa.lineTo(P,(M+ac)/2);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="triL"){aa.moveTo(P,M);aa.lineTo(X,(M+ac)/2);aa.lineTo(P,ac);aa.lineTo(P,M)}else{if(z=="ribU"){aa.moveTo(X,M);aa.lineTo((X+P)/2,M+(ac-M)*0.25);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="ribD"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac);aa.lineTo((X+P)/2,M+0.75*(ac-M));aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="flagR"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(X+(4/5)*E,(M+ac)/2);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M)}else{if(z=="flagL"){aa.moveTo(X,M);aa.lineTo(X+(1/5)*E,(M+ac)/2);aa.lineTo(X,ac);aa.lineTo(P,ac);aa.lineTo(P,M);aa.lineTo(X,M)}else{if(z=="houseU"){aa.moveTo((X+P)/2,M);aa.lineTo(P,M+(3/7)*R);aa.lineTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M+(3/7)*R);aa.lineTo((X+P)/2,M)}else{if(z=="houseD"){aa.moveTo((X+P)/2,ac);aa.lineTo(P,M+(4/7)*R);aa.lineTo(P,M);aa.lineTo(X,M);aa.lineTo(X,M+(4/7)*R);aa.lineTo((X+P)/2,ac)}else{if(z=="oct"){aa.moveTo(X+(21/72)*E,M);aa.lineTo(X+(51/72)*E,M);aa.lineTo(P,M+(21/72)*R);aa.lineTo(P,M+(51/72)*R);aa.lineTo(X+(51/72)*E,ac);aa.lineTo(X+(21/72)*E,ac);aa.lineTo(X,M+(51/72)*R);aa.lineTo(X,M+(21/72)*R);aa.lineTo(X+(21/72)*E,M)}else{if(z=="star"){var L=(X+P)/2;var T=P-X;var Q=ac-M;aa.moveTo(L,M);aa.lineTo(X+(33/54)*T,M+(39/102)*Q);aa.lineTo(P,M+(39/102)*T);aa.lineTo(X+(75/108)*T,M+(63/102)*Q);aa.lineTo(X+(87/108)*T,ac);aa.lineTo(L,M+(39/51)*Q);aa.lineTo(X+(21/108)*T,ac);aa.lineTo(X+(33/108)*T,M+(63/102)*Q);aa.lineTo(X,M+(39/102)*Q);aa.lineTo(X+(21/54)*T,M+(39/102)*Q);aa.lineTo(L,M)}else{if(z=="pgL"){aa.moveTo(X,ac);aa.lineTo(P,ac);aa.lineTo(P,M);aa.lineTo(X+(P-X)/3,M);aa.lineTo(X,M+(ac-M)/4);aa.lineTo(X,ac)}else{if(z=="pgR"){aa.moveTo(P,ac);aa.lineTo(X,ac);aa.lineTo(X,M);aa.lineTo(X+(P-X)*0.66,M);aa.lineTo(P,M+(ac-M)*0.25);aa.lineTo(P,ac)}else{if(z=="pointrL"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(X+(5/7)*E,M+(3/7)*R);aa.lineTo(X+(5/7)*E,ac);aa.lineTo(X,M)}else{if(z=="pointrR"){aa.moveTo(X,M);aa.lineTo(P,M);aa.lineTo(X+(2/7)*E,ac);aa.lineTo(X+(2/7)*E,M+(3/7)*R);aa.lineTo(X,M)}else{if(z=="ldL"){aa.moveTo(X,M);aa.lineTo(X+2,M);aa.lineTo(P,ac);aa.lineTo(P-2,ac);aa.lineTo(X,M)}else{if(z=="ldR"){aa.moveTo(P,M);aa.lineTo(P-2,M);aa.lineTo(X,ac);aa.lineTo(X+2,ac);aa.lineTo(P,M)}else{if(z=="dropD"){aa.moveTo((X+P)/2,M);aa.lineTo(X+E/6,(M+ac)/2);aa.bezierCurveTo(X-(E*(1.5/6)),ac+(R/6.2),P+(E*(1.5/6)),ac+(R/6.2),X+E*(5/6),(M+ac)/2);aa.lineTo((X+P)/2,M)}else{if(z=="dropU"){aa.moveTo((X+P)/2,ac);aa.lineTo(X+E/6,(M+ac)/2);aa.bezierCurveTo(X-(E*(1.5/6)),M-(R/6.2),P+(E*(1.5/6)),M-(R/6.2),X+E*(5/6),(M+ac)/2);aa.lineTo((X+P)/2,ac)}else{if(z=="oval"){aa.moveTo(X,(ac+M)/2);aa.bezierCurveTo(X+E*(1/4),M-(R/7),X+E*(3/4),M-(R/7),P,(ac+M)/2);aa.bezierCurveTo(X+E*(3/4),ac+(R/7),X+E*(1/4),ac+(R/7),X,(ac+M)/2)}else{if(z=="cloud"){aa.moveTo(X+E*(1.5/9),ac);aa.bezierCurveTo(X,ac,X,M+R*(7/11),X+E*(1.6/9),M+R*(7/11));aa.bezierCurveTo(X+E/9,M+R/3,X+E/3,M+R/6.3,X+E*(4/9),M+R/3.2);aa.bezierCurveTo(X+E*(4.5/9),M,X+E*(7.4/9),M,X+E*(7.3/9),(ac+M)/2);aa.bezierCurveTo(P,(ac+M)/2,P,ac,X+E*(7.7/9),ac);aa.lineTo(X+E*(1.5/9),ac)}else{if(z=="person"){aa.moveTo(X,ac);aa.bezierCurveTo((X+P)/16,(M+ac)*(11/14),(X+P)*(3/16),(M+ac)*(10/14),(X+P)*(6/16),(ac+M)*(9/14));aa.bezierCurveTo((X+P)*(2.5/16),(M+ac)*(4/7),(X+P)*(2.5/16),M,(X+P)/2,M);aa.bezierCurveTo((X+P)*(13.5/16),M,(X+P)*(13.5/16),(M+ac)*(4/7),(X+P)*(10/16),(ac+M)*(9/14));aa.bezierCurveTo((X+P)*(13/16),(M+ac)*(10/14),(X+P)*(15/16),(M+ac)*(11/14),P,ac);aa.lineTo(X,ac)}else{if(z=="thumbsU"){aa.moveTo(X,M+R*(16/17));aa.lineTo(X,M+R*(15/34));aa.bezierCurveTo(X+E*(2/15),M+R*(7/17),X+E*(9/30),M+R*(4/17),X+E/3,M+R*(3/34));aa.bezierCurveTo(X+E*(5.2/15),M,X+E*(9/15),M,X+E*(8.5/15),M+R*(2/17));aa.lineTo(X+E*(7/15),M+R*(11/34));aa.bezierCurveTo(X+E*(9/15),M+R*(13/34),X+E*(11/15),M+R*(13/34),X+E*(12/15),M+R*(13/34));aa.bezierCurveTo(P,M+R*(13/34),P,M+R*(19/34),X+E*(12/15),M+R*(19/34));aa.bezierCurveTo(X+E*(14/15),M+R*(19/34),X+E*(27/30),M+R*(12/17),X+E*(23/30),M+R*(12/17));aa.bezierCurveTo(X+E*(13/15),M+R*(12/17),X+E*(25/30),M+R*(29/34),X+E*(11/15),M+R*(29/34));aa.bezierCurveTo(X+E*(25/30),M+R*(29/34),X+E*(12/15),ac,X+E*(8.5/15),ac);aa.bezierCurveTo((X+P)/2,ac,X+E/5,ac,X,M+R*(16/17))}else{if(z=="thumbsD"){aa.moveTo(X,M+R/17);aa.lineTo(X,M+R*(19/34));aa.bezierCurveTo(X+E*(2/15),M+R*(10/17),X+E*(9/30),M+R*(13/17),X+E/3,M+R*(31/34));aa.bezierCurveTo(X+E*(5.2/15),ac,X+E*(9/15),ac,X+E*(8.5/15),M+R*(15/17));aa.lineTo(X+E*(7/15),M+R*(23/34));aa.bezierCurveTo(X+E*(9/15),M+R*(21/34),X+E*(11/15),M+R*(21/34),X+E*(12/15),M+R*(21/34));aa.bezierCurveTo(P,M+R*(21/34),P,M+R*(15/34),X+E*(12/15),M+R*(15/34));aa.bezierCurveTo(X+E*(14/15),M+R*(15/34),X+E*(27/30),M+R*(5/17),X+E*(23/30),M+R*(5/17));aa.bezierCurveTo(X+E*(13/15),M+R*(5/17),X+E*(25/30),M+R*(5/34),X+E*(11/15),M+R*(5/34));aa.bezierCurveTo(X+E*(25/30),M+R*(5/34),X+E*(12/15),M,X+E*(8.5/15),M);aa.bezierCurveTo(X+E/2,M,X+E/5,M,X,M+R/17)}else{if(z=="arcL"){var T=P-X;var Q=ac-M;var A=(Q>=(T*2))?T:Q/2;aa.moveTo(X+A,M);aa.arcTo(X,M,X,M+A,A);aa.arcTo(X,M+(2*A),X+A,M+(2*A),A);aa.lineTo(X+A,M)}else{if(z=="arcR"){var T=P-X;var Q=ac-M;var A=(Q>=(T*2))?T:Q/2;aa.moveTo(X,M);aa.arcTo(X+A,M,X+A,M+A,A);aa.arcTo(X+A,M+(2*A),X,M+(2*A),A);aa.lineTo(X,M)}else{if(z=="arcU"){var T=P-X;var Q=ac-M;var A=(T>=(Q*2))?Q:T/2;aa.moveTo(X,M+A);aa.arcTo(X,M,X+A,M,A);aa.arcTo(X+(2*A),M,X+(2*A),M+(2*A),A);aa.lineTo(X,M+A)}else{if(z=="arcD"){var T=P-X;var Q=ac-M;var A=(T>=(Q*2))?Q:T/2;aa.moveTo(X,M);aa.arcTo(X,M+A,X+A,M+A,A);aa.arcTo(X+(2*A),M+A,X+(2*A),M,A);aa.lineTo(X,M)}else{if(z=="folder"){var T=P-X;var Q=ac-M;aa.moveTo(X+(3/8)*T,M+(2/15)*Q);aa.lineTo(P-C[1],M+(2/15)*Q);aa.quadraticCurveTo(P,M+(2/15)*Q,P,(M+(2/15)*Q)+C[1]);aa.lineTo(P,ac-C[2]);aa.quadraticCurveTo(P,ac,P-C[2],ac);aa.lineTo(X+C[3],ac);aa.quadraticCurveTo(X,ac,X,ac-C[3]);aa.lineTo(X,M+C[0]);aa.quadraticCurveTo(X,M,X+C[0],M);aa.lineTo(X+(5/16)*T,M);aa.lineTo(X+(3/8)*T,M+(2/15)*Q)}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}if(z=="speechRight"){aa.moveTo(P-17,ac);aa.lineTo(P-96,ac-13);aa.lineTo(X,ac-13);aa.lineTo(X,M);aa.lineTo(P,M);aa.lineTo(P,ac-13);aa.lineTo(P-38,ac-13);aa.lineTo(P-17,ac)}if(z=="speechLeft"){aa.moveTo(X+17,ac);aa.lineTo(X+96,ac-13);aa.lineTo(P,ac-13);aa.lineTo(P,M);aa.lineTo(X,M);aa.lineTo(X,ac-13);aa.lineTo(X+38,ac-13);aa.lineTo(X+17,ac)}else{if(z=="bubr"){right=B+T-1;bottom=O+Q-2;tailSize=7;if(m.b){O=O+m.b[0]/2;B=B+m.b[0]/2;right=right-m.b[0]/2;bottom=bottom-m.b[0]/2}aa.moveTo(right-tailSize,bottom-7);aa.lineTo(right-tailSize,O+C[1]);aa.quadraticCurveTo(right-tailSize,O,right-C[1]-tailSize,O);aa.lineTo(B+C[0],O);aa.quadraticCurveTo(B,O,B,O+C[0]);aa.lineTo(B,bottom-C[3]);aa.quadraticCurveTo(B,bottom,B+C[3],bottom);aa.lineTo(right-19,bottom);aa.quadraticCurveTo(right-15,bottom-1,right-14,bottom-2);aa.quadraticCurveTo(right-7,bottom+1,right-1,bottom-2);aa.quadraticCurveTo(right-tailSize,bottom-3,right-tailSize,bottom-7)}else{if(z=="bubl"){right=B+T-1;bottom=O+Q-2;tailSize=7;if(m.b){O=O+m.b[0]/2;B=B+m.b[0]/2;right=right-m.b[0]/2;bottom=bottom-m.b[0]/2}aa.moveTo(right,bottom-C[2]);aa.lineTo(right,O+C[1]);aa.quadraticCurveTo(right,O,right-C[1],O);aa.lineTo(B+C[0]+tailSize,O);aa.quadraticCurveTo(B+tailSize,O,B+tailSize,O+C[0]);aa.lineTo(B+tailSize,bottom-6);aa.quadraticCurveTo(B+4,bottom-1,B+1,bottom-2);aa.quadraticCurveTo(B+2,bottom+2,B+13,bottom-2);aa.quadraticCurveTo(B+15,bottom,B+19,bottom);aa.lineTo(right-C[2],bottom);aa.quadraticCurveTo(right,bottom,right,bottom-C[2])}else{if(z=="arrowL"||z=="arrowR"||z=="arrowU"||z=="arrowD"){var V=2;if(S.aCurve){V=S.aCurve}var U=12;if(S.aSize){U=S.aSize}if(z=="arrowL"){aa.moveTo(X+U,M);aa.lineTo(P-C[1],M);aa.quadraticCurveTo(P,M,P,M+C[1]);aa.lineTo(P,ac-C[2]);aa.quadraticCurveTo(P,ac,P-C[2],ac);aa.lineTo(X+U,ac);aa.bezierCurveTo(X+U-V,ac,X,((ac+M)/2)+V,X,(ac+M)/2);aa.bezierCurveTo(X,((ac+M)/2)-V,U-V+X,M,X+U,M)}else{if(z=="arrowR"){aa.moveTo(X+C[0],M);aa.lineTo(P-U,M);aa.bezierCurveTo(P-U+V,M,P,((M+ac)/2)-V,P,(M+ac)/2);aa.bezierCurveTo(P,((M+ac)/2)+V,P-U+V,ac,P-U,ac);aa.lineTo(X+C[3],ac);aa.quadraticCurveTo(X,ac,X,ac-C[3]);aa.lineTo(X,M+C[0]);aa.quadraticCurveTo(X,M,X+C[0],M)}else{if(z=="arrowD"){var K=(S.aW)?S.aW:K;var ab=(X+P)/2;var Y=K/2;aa.moveTo(X+C[0],M);aa.lineTo(P-C[1],M);aa.quadraticCurveTo(P,M,P,M+C[1]);aa.lineTo(P,ac-U-C[2]);aa.quadraticCurveTo(P,ac-U,P-C[2],ac-U);aa.lineTo(ab+Y,ac-U);aa.lineTo(ab,ac);aa.lineTo(ab-Y,ac-U);aa.lineTo(X+C[3],ac-U);aa.quadraticCurveTo(X,ac-U,X,ac-U-C[3]);aa.lineTo(X,M+C[0]);aa.quadraticCurveTo(X,M,X+C[0],M)}else{if(z=="arrowU"){var K=(S.aW)?S.aW:20;var ab=(X+P)/2;var Y=K/2;aa.moveTo(X+C[0],M+U);aa.lineTo(ab-Y,M+U);aa.lineTo(ab,M);aa.lineTo(ab+Y,M+U);aa.lineTo(P-C[1],M+U);aa.quadraticCurveTo(P,M+U,P,M+U+C[1]);aa.lineTo(P,ac-C[2]);aa.quadraticCurveTo(P,ac,P-C[2],ac);aa.lineTo(X+C[2],ac);aa.quadraticCurveTo(X,ac,X,ac-C[3]);aa.lineTo(X,M+U+C[0]);aa.quadraticCurveTo(X,M+U,X+C[3],M+U)}}}}}else{if(z=="c"){var H=T/2,F=Q/2,Z=Math.min(H,F),D=Math.min(ad|0,Z),A=Z-D/2;d=D;aa.arc(B+H,O+F,A,0,Math.PI*2,true)}}}}}aa.closePath()},_gradient:function(D,F,A){var z=["#ffffff","#000000"];var C=[0,1];if(A.bgc&&A.bgd){z=A.bgc;C=A.bgd}for(var B=0;B<z.length&&B<C.length;B++){try{D.addColorStop(C[B],z[B])}catch(E){}}F.fillStyle=D;F.fill()},_glaze:function(D,B){var H=5,E=q.useOneCanvas?2+B.box[1]:2,A=q.useOneCanvas?10+B.box[0]:10,z=B.box[2]-27,G=10,i=0,F=7;if(B.s=="bubl"){A+=F}l.path(D,"sq",H,E,A,z,G,i,B);var C=D.createLinearGradient(0,E+G,0,E);C.addColorStop(0,"rgba(231, 231, 231, 0.2)");C.addColorStop(0.59,"rgba(240, 240, 240, 0.25)");C.addColorStop(1,"rgba(249, 249, 249, 0.3)");D.fillStyle=C;D.fill();D.restore()},_shadow:function(z,i){z.shadowColor=i.sh[0];z.shadowOffsetX=i.sh[1];z.shadowOffsetY=i.sh[2];z.shadowBlur=i.sh[3]},_effect:function(L,F){var z=F.fx;for(var G=0;G<z.length;G++){var I=z[G];if(I[0]=="dots"){var P=I[1];var J=I[2];var O=I[3];L.fillStyle=I[4];var B=F.box[2];var A=F.box[3];var M=P+J;var H=P+O;var N=parseInt(B/M)+1;var K=parseInt(A/H)+1;var E=0;for(var D=0;D<K;D++){E=(E)?0:P;for(var C=0;C<N;C++){L.beginPath();L.arc((C*M)+E,(D*H),P/2,0,2*Math.PI);L.closePath();L.fill()}}}}},_setImage:function(A,i){try{A.drawImage(A.canvas,0,0)}catch(z){}}};var j=this.renderingMode==="singlepage"?0:m.box[0];var n=this.renderingMode==="singlepage"?0:m.box[1];var p=m.box[2];var o=m.box[3];var v=0;var h=0;var r=m.b;var d=null;if(r){v=r[0];h=r.length>3?r.slice(2):r[2]}var f=m.s?m.s:"sq";u.save();l.blur();l.path(u,f,h,n,j,p,o,v,m);if(m.sh){l._shadow(u,m)}if(m.bg){l.background(u,m)}u.restore();if(r&&v>0){l.border(u,m,p,o)}if(m.glaze&&m.glaze=="y"){l._glaze(u,m)}if(m.fx&&m.fx.length>0){l._effect(u,m)}if(m.i){for(var s=0;s<m.i.length;s++){var t=m.i[s];var w=new Image();function e(){var i=t[5];if(typeof(i)=="string"&&i.search("%")!=-1){i=(p*parseInt(i)/100)-t[3]/2}else{if(i<0){i=parseInt(p)+t[5]-t[3]}}var c=t[6];if(typeof(c)=="string"&&c.search("%")!=-1){c=(o*parseInt(c)/100)-t[4]/2}else{if(c<0){c=parseInt(o)+t[6]-t[4]}}if(q.imagesLoaded[t[0]]){u.drawImage(q.imagesLoaded[t[0]],t[1],t[2],m.box[2],m.box[3],i+j,c+n,m.box[2],m.box[3])}else{w.onload=function(){try{u.drawImage(w,t[1],t[2],m.box[2],m.box[3],i+j,c+n,m.box[2],m.box[3]);if(u.canvas.hasOwnProperty("onchange")){u.canvas.onchange()}}catch(z){}};w.src=t[0]}}$(w).ready(e)}}else{}if(!this.useCanvas){k=this.canvasToImg(k)}return k};this.canvasToImg=function(d){var c=d.get(0).toDataURL("image/png");return $('<img src="'+c+'">')};this.renderOne=function(c,i,e){var h={$rendition:{},childWidgets:[]};if(!c.box){c.box=this.calculateBox(c,i,e)}if(fluid.widget.isShapeWidget(c)){h.$shapeRendition=this.paintCanvas(c)}if(fluid.widget.isUploadWidget(c)){}if(fluid.widget.isTextWidget(c)){h.$textRendition=this.renderText(c)}if(fluid.widget.hasChildWidgets(c)){var f=fluid.wdgProvider.getChildWidgets(c,true);for(var d=0;d<f.length;d++){h.childWidgets.push(this.renderOne(f[d],c,c.ad[d]))}}if(fluid.widget.hasSegments(c)){h.segments=this.renderSegments(c)}if(!h.childWidgets.length){delete h.childWidgets}return h};this.renderSegments=function(d){var e=[];var c=[];for(var f=0;f<d.sc;f++){if(d.segments&&d.segments.length){e.push({wdgObj:storage.get(d.segments[f].id),box:[]})}else{e.push({wdgObj:fluid.wdgProvider.getById(d.seg[f%d.seg.length]),box:[]})}}for(f=0;f<e.length;f++){if(e[f].wdgObj.wh){e[f].wdgObj.tlwh=[0,0,e[f].wdgObj.wh[0],e[f].wdgObj.wh[1]]}if(e[f].wdgObj.tlwh&&typeof(e[f].wdgObj.tlwh[2])==="number"){e[f].box[2]=e[f].wdgObj.tlwh[2]}else{if(e[f].wdgObj.tlwh){if(e[f].wdgObj.tlwh&&e[f].wdgObj.tlwh[2]==="a"){e[f].box[2]=d.box[2]/d.sc}else{if(e[f].wdgObj.tlwh[2].indexOf("%")!==-1){e[f].box[2]=(parseFloat(e[f].wdgObj.tlwh[2])/100)*d.box[2]}}}}if(e[f].wdgObj.tlwh&&typeof(e[f].wdgObj.tlwh[3])==="number"){e[f].box[3]=e[f].wdgObj.tlwh[3]}else{if(e[f].wdgObj.tlwh){if(e[f].wdgObj.tlwh&&e[f].wdgObj.tlwh[3]==="a"){e[f].box[3]=d.box[3]/d.sc}else{if(e[f].wdgObj.tlwh[3].indexOf("%")!==-1){e[f].box[3]=(parseFloat(e[f].wdgObj.tlwh[3])/100)*d.box[3]}}}}}if(d.sl=="h"){if(d.sa=="tl"||!d.sa){for(f=0;f<e.length;f++){e[f].box[0]=(f*(d.box[2]/d.sc));e[f].box[1]=0+d.sp[1]}}else{if(d.sa=="d"){for(f=0;f<e.length;f++){e[f].box[0]=(f*(d.box[2]/d.sc))+Math.max(d.box[2]/d.sc-e[f].box[2],0)/2;e[f].box[1]=(d.box?d.box[1]:0)+d.sp[1]}}}}else{for(f=0;f<e.length;f++){e[f].box[0]=d.box?d.box[0]:0;e[f].box[1]=(d.box?d.box[1]:0)+(f*e[f].box[3])}}for(f=0;f<e.length;f++){if(f===0&&e[f].wdgObj.bts){e[f].wdgObj.b=e[f].wdgObj.bts}else{if(f===e.length-1&&e[f].wdgObj.bbs){e[f].wdgObj.b=e[f].wdgObj.bbs}else{if(e[f].wdgObj.bms&&d.sl==="v"){e[f].wdgObj.b=e[f].wdgObj.bms}}}if(f===0&&e[f].wdgObj.bls){e[f].wdgObj.b=e[f].wdgObj.bls}else{if(f===e.length-1&&e[f].wdgObj.brs){e[f].wdgObj.b=e[f].wdgObj.brs}else{if(e[f].wdgObj.bms&&d.sl==="h"){e[f].wdgObj.b=e[f].wdgObj.bms}}}e[f].wdgObj.box=e[f].box;c.push(this.renderOne(e[f].wdgObj))}return c};this.renderRecursive=function(d,h){var f={};if(d.length){var c=[];for(var e=0;e<d.length;e++){this.generateCanvas(d[e].originId);f=this.renderOne(d[e],h);c.push(f)}}else{this.generateCanvas(d.originId);f=this.renderOne(d,h)}return c||f};this.onPageRenderFinish=function(c){if(this.afterPageRendered){var d=this.canvases[c].get(0).toDataURL("image/png");this.afterPageRendered(c,d,1,false)}};this.onRenderFinish=function(){if(typeof window.callPhantom==="function"){$("#canvas").css({top:(-this.cropping.y+15)+"px",left:(-this.cropping.x+15)+"px"});window.callPhantom({event:"finishedrendering",cropping:this.cropping})}else{if(!this.afterPageRendered){var d=[];var c=project.get("id");$("canvas.page-preview").each(function(){var f=$(this).parents(".screen").attr("id");var e=storage.get(f);if(!e||!e.widgets||!e.widgets.length){return}var h=$(this).get(0).toDataURL("image/jpeg",0.5);if(pagesCache[f]){pagesCache[f].img=h}if(project.useLocalDb){d.push({id:f,data:h,project:c})}requestAnimationFrame(function(){var i=$('<img class="page-preview" src="'+h+'">');i.insertAfter($(this));setTimeout(function(){$(this).remove()}.bind(this),500)}.bind(this))});if(project.useLocalDb){dbStorage.set("rastPages",d)}}}};this.countRemainingLoads=function(d){var e=0;if(d){for(var f in this.imagesToLoad[d]){e++}for(var f in this.uploadsToLoad[d]){e++}return e}else{for(var d in this.imagesToLoad){if(this.imagesToLoad.hasOwnProperty(d)){for(var c in this.imagesToLoad[d]){if(this.imagesToLoad[d].hasOwnProperty(c)){e++}}}}for(var d in this.uploadsToLoad){if(this.uploadsToLoad.hasOwnProperty(d)){for(var c in this.uploadsToLoad[d]){if(this.uploadsToLoad[d].hasOwnProperty(c)){e++}}}}return e}};this.onImgLoadErr=function(e,k,c){if(c.target.src.indexOf("data/img")!==-1){if(account.hasUpload(k)===false&&account.syncedUploads){page.removeWidget(e,this.uploadsToLoad[e][k]);storage.remove(this.uploadsToLoad[e][k])}if(this.imagesToLoad[e][k]){delete this.imagesToLoad[e][k]}if(this.uploadsToLoad[e][k]){delete this.uploadsToLoad[e][k]}var h=this.countRemainingLoads(e);if(h===0){for(var f=0;f<this.renderingQueue[e].length;f++){var d=this.renderingQueue[e][f];if(fluid.widget.isShapeWidget(d)){this.paintCanvas(d,this.canvases[e])}if(fluid.widget.isUploadWidget(d)){this.renderUpload(d,this.canvases[e],this.imagesLoaded[d.data])}if(fluid.widget.isTextWidget(d)){this.renderText(d,this.canvases[e])}}if(this.countRemainingLoads()===0){this.onRenderFinish()}}return}var j=new Image();j.onload=this.onImgLoad.bind(this,e,k);j.onerror=this.onImgLoadErr.bind(this,e,k);j.src="data/img/"+k};this.onImgLoad=function(e,j,c){this.imagesLoaded[j]=c.target;if(this.imagesToLoad[e][j]){delete this.imagesToLoad[e][j]}if(this.uploadsToLoad[e][j]){delete this.uploadsToLoad[e][j]}var h=this.countRemainingLoads(e);if(h===0){for(var f=0;f<this.renderingQueue[e].length;f++){var d=this.renderingQueue[e][f];if(fluid.widget.isShapeWidget(d)){this.paintCanvas(d,this.canvases[e])}if(fluid.widget.isUploadWidget(d)){this.renderUpload(d,this.canvases[e],this.imagesLoaded[d.data])}if(fluid.widget.isTextWidget(d)){this.renderText(d,this.canvases[e])}}this.onPageRenderFinish(e);if(this.countRemainingLoads()===0){this.onRenderFinish()}}if(j.indexOf("i_")===0&&window.uploadsCache&&!window.uploadsCache[j]){if(!project.uploadCanvas){project.uploadCanvas=document.createElement("canvas")}project.uploadCanvas.width=c.target.naturalWidth;project.uploadCanvas.height=c.target.naturalHeight;project.uploadCanvasCtx=project.uploadCanvas.getContext("2d");project.uploadCanvasCtx.drawImage(c.target,0,0);window.uploadsCache[j]=project.uploadCanvas.toDataURL("image/png");dbStorage.set("uploads",{id:j,data:window.uploadsCache[j]})}};this.pageRenderOne=function(d){var h={$rendition:{}};if(!this.skipImages){if(!this.imagesToLoad[this.pageId]){this.imagesToLoad[this.pageId]={}}if(!this.uploadsToLoad[this.pageId]){this.uploadsToLoad[this.pageId]={}}var e=false;if(d.i&&!this.imagesToLoad[this.pageId][d.i[0][0]]){e=true}if(d.upload==="y"&&!this.uploadsToLoad[this.pageId][d.data]){e=true}if(e||this.renderingQueue[this.pageId].length>0){if(d.i&&!this.imagesToLoad[this.pageId][d.i[0][0]]){var c=new Image();this.imagesToLoad[this.pageId][d.i[0][0]]=true;c.onload=this.onImgLoad.bind(this,this.pageId,d.i[0][0]);c.crossOrigin="Anonymous";c.src=d.i[0][0]}else{if(d.upload==="y"&&!this.uploadsToLoad[this.pageId][d.data]){var f=storage.get(d.data);var c=new Image();this.uploadsToLoad[this.pageId][d.data]=d.id;c.onload=this.onImgLoad.bind(this,this.pageId,d.data);c.onerror=this.onImgLoadErr.bind(this,this.pageId,d.data);if(window.uploadsCache&&window.uploadsCache[d.data]){c.src=uploadsCache[d.data]}else{if(!f||!f.storage||f.storage==="cloud"){c.crossOrigin="Anonymous";c.src=imgCloudUrl+d.data+".png"}else{c.src="data/img/"+d.data}}}}this.renderingQueue[this.pageId].push(d);h.$shapeRendition=this.canvas;return h}}if(fluid.widget.isShapeWidget(d)||d.segments){h.$shapeRendition=this.paintCanvas(d)}if(!this.skipImages&&fluid.widget.isUploadWidget(d)){h.$shapeRendition=this.renderUpload(d)}if(fluid.widget.isTextWidget(d)){h.$textRendition=this.renderText(d)}return h};this.foo=function(e,d){var h=[];var f=e.tlwh[2]==null?0:e.tlwh[2];if(f&&typeof(f)==="number"){h[2]=f}else{if(f&&f.indexOf("%")!==-1){h[2]=(parseFloat(f)/100)*d.box[2]}else{h[2]=d.box[2]}}var c=e.tlwh[3]==null?0:e.tlwh[3];if(c&&typeof(c)==="number"){h[3]=c}else{if(c&&c.indexOf("%")!==-1){h[3]=(parseFloat(c)/100)*d.box[3]}else{h[3]=d.box[3]}}var j=e.tlwh[0]==null?0:e.tlwh[0];if(!e.ca||e.ca[0]=="t"){if(typeof(j)==="number"){h[1]=j+d.box[1]}else{if(j.indexOf("%")!==-1){h[1]=((parseFloat(j)/100)*d.box[3])+d.box[1]}else{h[1]=parseInt(j,10)+d.box[1]}}}else{if(e.ca[0]=="c"){if(typeof(j)==="number"){h[1]=j+d.box[1]+d.box[3]/2-h[3]/2}else{if(j.indexOf("%")!==-1){h[1]=((parseFloat(j)/100)*d.box[3])+d.box[1]+d.box[3]/2-h[3]/2}else{h[1]=parseInt(j,10)+d.box[1]+d.box[3]/2-h[3]/2}}}else{if(e.ca[0]=="b"){if(typeof(j)==="number"){h[1]=d.box[1]+d.box[3]-j-h[3]}else{if(j.indexOf("%")!==-1){h[1]=d.box[1]+d.box[3]-((parseFloat(j)/100)*d.box[3])-h[3]}else{h[1]=d.box[1]+d.box[3]-parseInt(j,10)}}}}}var i=e.tlwh[1]==null?0:e.tlwh[1];if(!e.ca||e.ca[1]=="l"){if(typeof(i)==="number"){h[0]=i+d.box[0]}else{if(i.indexOf("%")!==-1){h[0]=((parseFloat(i)/100)*d.box[2])+d.box[0]}else{h[0]=parseInt(i,10)+d.box[0]}}}else{if(e.ca[1]=="c"){if(typeof(i)==="number"){h[0]=i+d.box[0]+d.box[2]/2-h[2]/2}else{if(i.indexOf("%")!==-1){h[0]=((parseFloat(i)/100)*d.box[2])+d.box[0]+d.box[2]/2-h[2]/2}else{h[0]=parseInt(i,10)+d.box[0]+d.box[2]/2}}}else{if(e.ca[1]=="r"){if(typeof(i)==="number"){h[0]=d.box[0]+d.box[2]-i-h[2]}else{if(i.indexOf("%")!==-1){h[0]=d.box[0]+d.box[2]-((parseFloat(i)/100)*d.box[2])-h[2]}else{h[0]=d.box[0]+d.box[2]-f-parseInt(i,10)}}}}}h[0]=~~h[0];h[1]=~~h[1];h[2]=~~h[2];h[3]=~~h[3];return h};this.calculatePageBox=function(d,h){var f;var e;var c=(d.widgets[h]&&d.widgets[h].of)?d.widgets[h].of:null;if(!d.widgets[h]||!d.widgets[h].tlwh){return[0,0,this.canvasSize[0],this.canvasSize[1]]}if(!c){e={box:[0,0,this.canvasSize[0],this.canvasSize[1]]};f=this.foo(d.widgets[h],e)}else{if(d.widgets[c]&&d.widgets[c].box){f=this.foo(d.widgets[h],d.widgets[c])}else{f=this.calculatePageBox(d,c)}}return f};this.exceedsPage=function(d,c){if(d.box==undefined){return false}if(d.box[0]<0||d.box[1]<0){return true}if(d.box[0]+d.box[2]>c.width){return true}if(d.box[1]+d.box[3]>c.height){return true}return false};this.renderPage=function(c){if(this.finishTimeout){clearTimeout(this.finishTimeout);delete this.finishTimeout}var f={};var d=[];var e=[];for(var h in c.widgets){c.widgets[h].id=h;c.widgets[h].box=this.calculatePageBox(c,h);if(this.useOneCanvas&&this.exceedsPage(c.widgets[h],c)){e.push(h)}}if(this.useOneCanvas&&widget._draw){widget.load(c.id,e)}this.setCropping(c);this.generateCanvas(c.id);this.pageId=c.id;this.renderingQueue[c.id]=[];f=this.pageRenderOne({st:"b",ca:"tl",bg:"c",bgc:["#ffffff"],box:[0,0,this.canvasSize[0],this.canvasSize[1]],wg:[1],id:"dummy-bg-"+(new Date().getTime())});d.push(f);for(var h in c.widgets){if(c.widgets[h].st&&c.widgets[h].st==="b"){f=this.pageRenderOne(c.widgets[h]);f.id=h;f.lockTo=c.widgets[h].lockTo;f.box=c.widgets[h].box;d.push(f)}}for(var h in c.widgets){if(!c.widgets[h].st||c.widgets[h].st!=="b"){f=this.pageRenderOne(c.widgets[h]);f.id=h;f.lockTo=c.widgets[h].lockTo;f.box=c.widgets[h].box;d.push(f)}}if(this.countRemainingLoads(c.id)===0){this.onPageRenderFinish(c.id)}if(this.countRemainingLoads()===0){this.finishTimeout=setTimeout(this.onRenderFinish.bind(this),200)}return d};this.preparePage=function(e){var d=$.extend({id:e},storage.tempStorage[e]);d.widgets=d.widgets.reduce(function(h,f){h[f]=$.extend({},storage.get(f));h[f].id=f;return h},{});for(var c in d.widgets){d.widgets[c].box=this.calculatePageBox(d,c)}return d};this.renderWidgetsBelow=function(e,h,k){h=h||this.preparePage(this.pageId);var d=0,n=storage.get(h.id).widgets,f=n.length,c=this.ctx;for(;d<f;d++){if(n[d]===e){break}var l=h.widgets[n[d]];if(!l.dm){if((fluid.widget.isUploadWidget(l)||l.i)&&k){var j=document.getElementById(n[d]),m=j?(j.querySelector("img")||j.querySelector("canvas")):null;if(m){c.drawImage(m,l.box[0],l.box[1],l.box[2],l.box[3])}}else{this.pageRenderOne(l)}}}if(this.countRemainingLoads(h.id)===0){this.onPageRenderFinish(h.id)}if(this.countRemainingLoads()===0){this.finishTimeout=setTimeout(this.onRenderFinish.bind(this),200)}};this.onProjectUnloaded=function(c){if(!this.canceledPreview){this.canceledPreview=[]}this.canceledPreview.push(c)};this.renderProjectPreview=function(v,o){v=$.extend({},v);if(this.currentProjectId&&v[this.currentProjectId]){return}this.previewSize={width:205,height:160};var F=$("<canvas></canvas>");var m=F.get(0).getContext("2d");this.canvas=F;var p=$('<canvas class="project-preview" width="'+this.previewSize.width+'" height="'+this.previewSize.height+'"></canvas>').css({position:"relative"});var A=p.get(0).getContext("2d");var n;var s;var c={};var E={};for(var l in v){if(v.hasOwnProperty(l)){if(l.indexOf("w_")===0||(l.indexOf("w")===0&&l.length==33)){E[l]=$.extend({},v[l])}else{if(l.indexOf("x_")===0||(l.indexOf("x")===0&&l.length==33)){c[l]=$.extend({},v[l])}else{if(l.indexOf("p_")===0||(l.indexOf("p")===0&&l.length==33)){n=$.extend({},v[l]);s=l}}}}}this.lastProjectId=s;this.currentProjectId=s;var r=n.pages;if(!r){o.call(this,s,p);this.currentProjectId=null;return}var d;var G={x:n.canvasWidth,y:n.canvasHeight,x2:0,y2:0};for(var C=0;C<r.length;C++){d=c[r[C]];if(!d){continue}if(d.x<G.x){G.x=d.x}if(d.y<G.y){G.y=d.y}if(d.x+d.width>G.x2){G.x2=d.x+d.width}if(d.y+d.height>G.y2){G.y2=d.y+d.height}}var w;var f=G.y2-G.y;var e=G.x2-G.x;if(e<f){w=f*n.canvasWidth/n.canvasHeight;G.x=G.x-(w-e)/2;G.x2=G.x2+(w-e)/2}else{w=(e*n.canvasHeight)/n.canvasWidth;G.y=G.y-(w-f)/2;G.y2=G.y2+(w-f)/2}var H={x:this.previewSize.width/(G.x2-G.x),y:this.previewSize.height/(G.y2-G.y)};this.skipImages=true;var k=[];for(var C=0;C<r.length;C++){if(!c[r[C]]){continue}var d=$.extend({},c[r[C]]);k.push(d);if(d.widgets&&d.widgets.length>0){var D={};for(var B=0;B<d.widgets.length;B++){D[d.widgets[B]]=E[d.widgets[B]]}}d.widgets=d.widgets.length>0?D:[];d.id=r[C];this.canvasSize=[d.width||320,d.height||480];if(!this.widgetsCache){this.widgetsCache={}}if(!this.pagesCache){this.pagesCache={}}for(var l in d.widgets){if(d.widgets.hasOwnProperty(l)&&d.widgets[l]){d.widgets[l].id=l;d.widgets[l].box=this.calculatePageBox(d,l);this.widgetsCache[l]=d.id}}this.pagesCache[d.id]=d}var h=$.extend({},n.links);var z;var q;var t;for(var C=0;C<h.linkDest.length;C++){if(!this.pagesCache[h.linkDest[C]]){continue}z=this.widgetsCache[h.linkOrigin[C]];if(z===undefined){continue}q={x:this.pagesCache[z].x+this.pagesCache[z].width*0.5,y:this.pagesCache[z].y+this.pagesCache[z].height*0.5};q.x=(q.x-G.x)*H.x;q.y=(q.y-G.y)*H.y;t={x:this.pagesCache[h.linkDest[C]].x+this.pagesCache[h.linkDest[C]].width*0.5,y:this.pagesCache[h.linkDest[C]].y+this.pagesCache[h.linkDest[C]].height*0.5};t.x=(t.x-G.x)*H.x;t.y=(t.y-G.y)*H.y;A.beginPath();A.strokeStyle="#009ecc";A.moveTo(q.x,q.y);A.lineTo(t.x,t.y);A.stroke()}function u(I){d=k[I];F.attr({width:d.width,height:d.height});m.fillStyle="#ffffff";m.fillRect(0,0,d.width,d.height);this.canvasSize=[d.width||320,d.height||480];for(var J in d.widgets){if(d.widgets.hasOwnProperty(J)&&d.widgets[J]){d.widgets[J].id=J;d.widgets[J].box=this.calculatePageBox(d,J)}}A.fillStyle="#ffffff";A.fillRect((d.x-G.x)*H.x,(d.y-G.y)*H.y,d.width*H.x,d.height*H.y);if(!pagesCache[k[I].id]||!pagesCache[k[I].id].img){for(var J in d.widgets){if(d.widgets.hasOwnProperty(J)&&d.widgets[J]){if(d.widgets[J].st&&d.widgets[J].st==="b"){this.pageRenderOne(d.widgets[J])}}}for(var J in d.widgets){if(d.widgets.hasOwnProperty(J)&&d.widgets[J]){if(!d.widgets[J].st||d.widgets[J].st!=="b"){this.pageRenderOne(d.widgets[J])}}}}var j=new Image();if(!pagesCache[k[I].id]||!pagesCache[k[I].id].img){j.src=F.get(0).toDataURL("image/jpeg")}else{j.src=pagesCache[k[I].id].img}j.onload=(function(N,L,P,O,K,M){A.drawImage(N,L,P,O,K);if(this.canceledPreview&&this.canceledPreview.indexOf(s)!==-1){var i=this.canceledPreview.indexOf(s);this.canceledPreview[i]=null}else{if(I<k.length-1){setTimeout(u.bind(this,I+1),100)}else{o.call(this,s,p);this.currentProjectId=null}}}).bind(this,j,(d.x-G.x)*H.x,(d.y-G.y)*H.y,d.width*H.x,d.height*H.y,d.id)}if(k.length>0){setTimeout(u.bind(this,0),200)}else{o.call(this,s,p);this.currentProjectId=null}return p};this.flattenRenditions=function(d){if(d.length){var e=[];for(var c=0;c<d.length;c++){e.push(this.flattenRendition(d[c]))}return e}else{return[this.flattenRendition(d)]}};this.flattenRendition=function(d){var h=[];var f=d.childWidgets;var c=d.segments;h.push(d.$rendition);if(f&&f.length){for(var e=0;e<f.length;e++){h=h.concat(this.flattenRendition(f[e]))}}if(c&&c.length){for(e=0;e<c.length;e++){h=h.concat(this.flattenRendition(c[e]))}}return h}};widget.getBlurBox=function(f,c){var e,b,h;if(pagesCache[c]&&pagesCache[c].box){h=pagesCache[c].box}else{var a=storage.get(c);h=[0,0,a.width,a.height]}if(widgetsCache[f]&&widgetsCache[f].box){b=widgetsCache[f].box}else{if(f.indexOf("helper-")===0){b=[0,0,h[2],h[3]]}else{b=[0,0,1,1]}}e=b;for(var d=0;d<2;d++){if(b[d]<0){e[d]=0;e[d+2]=e[d+2]+e[d]}}for(var d=2;d<=3;d++){if(b[d-2]+b[d]>h[d]){e[d]=h[d]-e[d-2]}}return e};widget.renderBlurLayer=function(e,d,l,j){d=d||widgetsCache[e].pageId;var i=storage.get(d),a=new fluid.wdgRenderer(i.width,i.height),c=document.createElement("canvas"),h=c.getContext("2d"),b=(b=e.match(/^helper-(.+)/))&&b[1],k,f=(b?widgets.summary[b].blur:widget.get(e).blur);i=a.preparePage(d);c.width=i.width;c.height=i.height;a.afterPageRendered=function(m,o){h.drawImage(a.canvas[0],0,0);utils.blur.canvasRGB(c,0,0,a.canvasSize[0],a.canvasSize[1],f);if(l){try{return l(c.toDataURL(0,0))}catch(n){return j?j(n):n}}};a.renderBlur=false;a.useOneCanvas=true;a.pageId=d;a.renderingQueue[d]=[];a.generateCanvas(d);a.ctx.fillStyle="white";a.ctx.fillRect(0,0,a.canvasSize[0],a.canvasSize[1]);a.renderWidgetsBelow(e,i,!l);h.drawImage(a.canvas[0],0,0);k=widget.getBlurBox(e,d);if(k[2]<=0||k[3]<=0){return null}utils.blur.canvasRGB(c,k[0],k[1],k[2],k[3],f);return c.toDataURL()};widget.renderBlurLayerImmediate=function(e,c){c=c||widgetsCache[e].pageId;var b=storage.get(c),a=document.createElement("canvas"),d,h=(h=e.match(/^helper-(.+)/))&&h[1],f=(h?widgets.summary[h].blur:widget.get(e).blur);a.width=b.width;a.height=b.height;d=widget.getBlurBox(e,c);if(d[2]<=0||d[3]<=0){return null}if(this.canvases[c]){utils.blur.canvasRGB(a,d[0],d[1],d[2],d[3],f,this.canvases[c].get(0))}else{utils.blur.canvasRGB(a,d[0],d[1],d[2],d[3],f)}return a};widget.setBlurBG=function(a){a.style.backgroundImage="url("+widget.blurLayers[a.id]+")";a.style.backgroundPosition=-parseInt(a.style.left,10)+"px "+-parseInt(a.style.top,10)+"px";a.style.backgroundRepeat="no-repeat"};widget.blurLayers={};var share={lastProjectId:null,url:null,url2:null,downloadURL:null,printURL:null,init:function(a){share.lastProjectId=a;share.setElements(a);$("input[data-default]",".ac-container-sharing").click();fluid.main.on("projectOpened,projectSharingOpened",function(){$(".shareLinkExportLocalFull, .shareLinkExportLocal").siblings(".msg").find("a").remove()})},setElements:function(a){var c=storage.get(a);var e=(document.location.href).split("?");var b=a+"."+c.updated;share.url=e[0]+"project/"+b;share.url2=e[0]+"preview/"+b;share.downloadURL=e[0]+"export/"+b;share.printURL=e[0]+"?p="+a+"&print=y&print_inter=y";var d="Mobile mockup created with FluidUI.com from @FluidUI_Team "+share.url2;qrCode.setShareURL(share.url,200);$(".previewExternal").attr("href",share.url2);$(".previewLinkLong").html(share.url2);$(".shareSendMail").find("[name=p]").val(b);$(".shareFacebook").attr("href","http://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(share.url2));$(".shareTwitter").attr("href","http://twitter.com/home?status="+encodeURIComponent(d))},actionCopyLinkOrCode:function(a){$(a.target).select()},actionAlertCopyLink:function(a){notification.add("alert","Link Copied");tracker.record("copiedPreviewLink",5,"",a);fluid.main.fire("shareLinkCopy")},actionMailSent:function(a){$(".shareSend").addClass("accept").removeClass("inactive").val("Email Mockup");$(".shareSend").siblings("span").hide().fadeIn(250).delay(1600).fadeOut(1200);share.mailClear()},actionPreviewExternal:function(){window.open(share.url2,"previewExternal")},actionParseSnapshot:function(a,f,b){try{var c=JSON.parse(b.responseText)}catch(d){notification.add("alert","Error starting export");return false}if(c.a==="PAGES"){$msgBox=$("#previewShareContainer .shareLinkExportImg").add("#projectSettingsShareTop .shareLinkExportImg").next(".msg")}else{$msgBox=$("#previewShareContainer .shareLinkExportImgFull").add("#projectSettingsShareTop .shareLinkExportImgFull").next(".msg")}if(c.r=="s"){if(c.queue===0){$msgBox.html("exporting...");$msgBox.addClass("pulsing");notification.add("alert","Export in progress. Please stick with us, this can take up to a minute.")}else{$msgBox.html("queued ("+c.queue+")...");$msgBox.addClass("pulsing");notification.add("alert","Project queued for export. Please wait.")}share.startExportPolling(c.snapshotId)}else{$msgBox.html("error...");$msgBox.removeClass("pulsing");notification.add("alert","Error starting export")}},startExportPolling:function(a){if(!share.exportPollTimeout){share.exportPollTimeout=7000;share.exportPollMaxRetries=50}share.exportPollTried=0;setTimeout(share.pollExport.bind(share,a),share.exportPollTimeout)},pollExport:function(a){$.ajax({url:"./index.php",type:"POST",data:{t:"getExportStatus",snapshotId:a},success:function(b,f,e){var c=JSON.parse(b);var d;if(c.projectId!==project.get("id")){return}if(c.stype==="PAGES"){d=$("#previewShareContainer .shareLinkExportImg").add("#projectSettingsShareTop .shareLinkExportImg").next(".msg")}else{d=$("#previewShareContainer .shareLinkExportImgFull").add("#projectSettingsShareTop .shareLinkExportImgFull").next(".msg")}if(c.status==="FAILED"){share.exportPollTried=0;d.html("failed...");d.removeClass("pulsing")}else{if(c.status==="FINISHED"){notification.add("alert",'Export done successfully. Click <a class="export-link" rel="'+c.snapshotId+'">here</a> to download');share.exportPollTried=0;d.html('<a class="export-link" rel="'+c.snapshotId+'">Download ('+c.processDate+")</a>");d.removeClass("pulsing")}else{if(c.status==="STARTED"||(c.status==="NEW"&&c.queue===0)){d.html("exporting...");d.addClass("pulsing");share.exportPollTried++;if(share.exportPollTried<share.exportPollMaxRetries){setTimeout(share.pollExport.bind(share,a),share.exportPollTimeout)}}else{if(c.status==="NEW"){d.html("queued ("+c.queue+")...");d.addClass("pulsing");share.exportPollTried++;if(share.exportPollTried<share.exportPollMaxRetries){setTimeout(share.pollExport.bind(share,a),share.exportPollTimeout)}}}}}},error:function(b,d,c){share.exportPollTried=0;$msgBox.html("error...")}})},downloadExport:function(){var a=$(this).attr("rel");window.open(document.location.origin+document.location.pathname+"snapshot/"+a,"_snapshot")},actionLogSharedProject:function(b){var a=$(b.target).attr("data-for");ajax.syncUp({target:a},"shareLog",share.lastProjectId)},actionLink:function(F){var G,k,d=[],A=share.lastProjectId,i=storage.get(A),o=i.name,n,u,p=0,q,w,l,B,E,j,f=false;var v=function(e){return e.replace(/\/|\||\?|\*|\|/g,"_")};var r=F.target.classList.toString().match(/shareLinkDownload|everUsedExport|shareLinkPrint|shareLinkExportLocalFull|shareLinkExportLocal/);if(!r){return}else{target=r[0]}if(fluid.main.fire("share.beforeAction",target)){var b=$(F.target);if(b.hasClass("shareLinkDownload")){window.open(share.downloadURL,"_export");fluid.main.fire("projectExport")}else{if(b.hasClass("shareLinkPrint")){window.g_window_print=window.open(share.printURL,"_print")}else{if(b.hasClass("shareLinkExportLocal")){notification.add("alert","Export in progress. Please stick with us, this can take up to a minute.");if(window.JSZip){G=new JSZip();q=G.folder(v(o));E=function(I,e){if(I&&e){I=v(I);e=e.slice(e.indexOf(",")+1);q.file(I,e,{base64:true})}else{notification.add("alert","Baah! Something went wrong...")}};j=function(){var e=G.generate({type:"blob"});var I=document.createElement("a");I.textContent="Download ("+(new Date().toLocaleString())+")";I.href=window.URL.createObjectURL(e);I.download=v(A)+".zip";$(".shareLinkExportLocal").siblings(".msg").find("a").remove();$(".shareLinkExportLocal").siblings(".msg").append(I);I.click()};u=i.pages;setTimeout(function(){u.forEach(function(e){page.drawRasterised(e,function(J,I){E(J+".png",I);p+=1;if(u.length===p){j()}})})},300)}else{notification.add("alert","Baah! Something went wrong...")}}else{if(b.hasClass("shareLinkExportLocalFull")){notification.add("alert","Export in progress. Please stick with us, this can take up to a minute.");B=function(K,I){var e=K[0];var J;if(I){for(J=1;J<K.length;J++){if(K[J]>e){e=K[J]}}}else{for(J=1;J<K.length;J++){if(K[J]<e){e=K[J]}}}return e};u=i.pages;var C={};var t=[],H=[],h=[],D=[];var a={xMin:null,yMin:null,xMax:null,yMax:null,padding:20};var m=0;var z=0;var s=0;var c=0;u.forEach(function(I){var J=storage.get(I);var e=J.x+J.width;var K=J.y+J.height;C[I]={x:J.x,y:J.y,width:J.width,height:J.height,data:null};t.push(J.x);H.push(J.y);h.push(e);D.push(K)});a.xMin=B(t);a.xMax=B(h,true);a.yMin=B(H);a.yMax=B(D,true);w=function(U,L){var R="",T="",W,I,Q=U[u[0]];var M=a.xMax-a.xMin+2*a.padding;var J=a.yMax-a.yMin+2*a.padding;var e=function(ao,af,ab){var ad,ar,ah,ac;var al=0,aj=0,Z=0,Y=0,am,ak;ad=af.y+ao.top+ao.height/2;ar=af.x+ao.left+ao.width/2;ah=(ab.y+ab.height/2);ac=(ab.x+ab.width/2);var aq=ac-ar;var ap=ah-ad;var ai=ap/aq;if(Math.abs(ai)>ab.height/ab.width){if(ah>ad){Z=aq-ab.height/(2*ai)}else{Z=aq+ab.height/(2*ai)}Y=Z*ai}else{if(ac>ar){Z=aq-ab.width/2}else{Z=aq+ab.width/2}Y=ai*Z}al=(ar+al);aj=(ad+aj);Z=(ar+Z);Y=(ad+Y);var an=Math.sqrt(Math.pow((al-Z),2)+Math.pow((aj-Y),2));var ae=20/an;var ag=ae*al+(1-ae)*Z;var aa=ae*aj+(1-ae)*Y;return{x1:al-a.xMin+a.padding,x2:ag-a.xMin+a.padding,y1:aj-a.yMin+a.padding,y2:aa-a.yMin+a.padding}};var X=function(Z,ab,Y,aa){return'<line stroke-linecap="butt" x1="'+Z+'" y1="'+ab+'" x2="'+Y+'" y2="'+aa+'" marker-end="url(#triangle)" stroke="#3fa9f5" stroke-width="10"/>\n'};var V=i.links;var P='<marker xmlns="http://www.w3.org/2000/svg" id="triangle" viewBox="0 0 10 10" refX="3.5" refY="5" fill="#3fa9f5" markerUnits="strokeWidth" markerWidth="4" markerHeight="3" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"/></marker>\n';R+='<?xml version="1.0" encoding="utf-8"?>\n';R+='<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n';R+='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="'+M+'px" height="'+J+'px">\n';R+=P;T=R;var S=K();var O=N();function N(){var Y="";Y+="<g>\n";u.forEach(function(ae){var ad=U[ae];var ac=ad.x-a.xMin+a.padding;var aa=ad.y-a.yMin+a.padding;var ab=ad.width;var Z=ad.height;Y+='    <image xlink:href="'+ad.data+'" x="'+ac+'" y="'+aa+'" height="'+Z+'px" width="'+ab+'px"/>\n';Y+='    <rect x="'+ac+'" y="'+aa+'" height="'+Z+'px" width="'+ab+'px" stroke="black" strokeWidth="2" fill="none"/>\n'});Y+="</g>\n";return Y}function K(){var Y="";if(V.linkOrigin&&V.linkOrigin.length){Y+="<g>\n";V.linkOrigin.forEach(function(ab,ac){var aa=storage.get(V.linkDest[ac]);var ae=widgetsCache[ab];var Z=storage.get(ae.pageId);if(Z&&aa){var ad={};ad.left=ae.box[0];ad.top=ae.box[1];ad.width=ae.box[2];ad.height=ae.box[3];calcLine=e(ad,Z,aa);Y+=X(calcLine.x1,calcLine.y1,calcLine.x2,calcLine.y2)}});Y+="</g>\n"}return Y}R+=O;R+=S;T+=S;T+=O;R+="</svg>";T+="</svg>";return{linksOnTop:R,normal:T}};G=new JSZip();q=G.folder(v(o));E=function(I,e){if(I&&e){I=v(I);q.file(I,e)}else{notification.add("alert","Baah! Something went wrong...")}};j=function(){var e=G.generate({type:"blob"});var I=document.createElement("a");I.textContent="Download ("+(new Date().toLocaleString())+")";I.href=window.URL.createObjectURL(e);I.download=v(A)+".zip";$(".shareLinkExportLocalFull").siblings(".msg").find("a").remove();$(".shareLinkExportLocalFull").siblings(".msg").append(I);I.click()};l=function(){var I=u[p],L,J,K,e;page.drawRasterised(I,function(N,M){C[N].data=M;p+=1;if(u[p]){l()}else{K=w(C);E(o+" visible links.svg",K.linksOnTop);E(o+".svg",K.normal);j()}})};setTimeout(function(){l()},300)}}}}}},mailClear:function(){var a=$(".shareSendMailReceipients");var b=a.val();if(b!=""){notification.add("alert","A link to your mockup has been sent to "+b);a.val("")}}};var fluidEvent={lastEvent:"",lastTrigger:new Date().getTime(),triggerEditor:function(a,c,b){fluidEvent._trigger($("#canvas"),a,c,b)},bindEditor:function(a,b){fluidEvent._bind($("#canvas"),a,b)},triggerPreview:function(a,c,b){fluidEvent._trigger($("#home"),a,c,b)},_trigger:function(d,a,f,e){var c=false;var b=new Date().getTime();var h=e||false;if((fluidEvent.lastEvent!=a)||(b-fluidEvent.lastTrigger>500)||h){c=true}if(c){d.trigger(a,f);fluidEvent.lastEvent=a;fluidEvent.lastTrigger=b}},_bind:function(b,a,c){b.live(a,c)}};